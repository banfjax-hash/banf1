<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BANF Membership Drive Admin</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<!-- Client-side file parsing libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root { --banf-red:#8B0000; --banf-light:#DC143C; --banf-gold:#FF6B35; }
body { background:#f7f0f0; font-family:'Segoe UI',Arial,sans-serif; }
.topbar { background:linear-gradient(135deg,var(--banf-red),var(--banf-light)); color:#fff; padding:18px 24px; }
.topbar h1 { font-size:1.35rem; margin:0; letter-spacing:.5px; }
.topbar .badge-admin { background:rgba(255,255,255,.2); font-size:.7rem; padding:3px 8px; border-radius:12px; margin-left:8px; }
.nav-tabs .nav-link.active { border-bottom:3px solid var(--banf-red); color:var(--banf-red); font-weight:600; }
.nav-tabs .nav-link { color:#555; }
.panel { background:#fff; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.08); padding:24px; margin-bottom:20px; }
.stat-card { background:#fff; border-radius:10px; padding:18px 20px; text-align:center; box-shadow:0 1px 6px rgba(0,0,0,.08); }
.stat-card .number { font-size:2rem; font-weight:700; color:var(--banf-red); }
.stat-card .label { font-size:.8rem; color:#888; text-transform:uppercase; letter-spacing:.5px; }
.upload-zone { border:2px dashed #ccc; border-radius:12px; padding:40px; text-align:center; cursor:pointer; transition:.2s; background:#fafafa; }
.upload-zone:hover, .upload-zone.drag-over { border-color:var(--banf-red); background:#fff5f5; }
.upload-zone .icon { font-size:2.5rem; color:#ccc; margin-bottom:10px; }
.upload-zone.has-file .icon { color:var(--banf-red); }
.json-editor { font-family:'Consolas','Courier New',monospace; font-size:.8rem; background:#1e1e1e; color:#d4d4d4; border-radius:8px; padding:16px; min-height:280px; resize:vertical; white-space:pre; overflow:auto; border:none; width:100%; }
.status-badge { display:inline-block; padding:4px 10px; border-radius:12px; font-size:.78rem; font-weight:600; }
.status-idle     { background:#e3f2fd; color:#1565c0; }
.status-running  { background:#e8f5e9; color:#2e7d32; }
.status-paused   { background:#fff3e0; color:#e65100; }
.status-complete { background:#f3e5f5; color:#6a1b9a; }
.status-stopped  { background:#ffebee; color:#c62828; }
.status-active   { background:#e8f5e9; color:#2e7d32; }
.status-draft    { background:#fff9c4; color:#f57f17; }
.status-archived { background:#eeeeee; color:#616161; }
.status-pending  { background:#fff3e0; color:#e65100; }
.member-row.is-demo td:first-child::before { content:'â˜… '; color:var(--banf-gold); }
.drive-card { border-radius:12px; padding:24px; margin-bottom:16px; }
.drive-demo { background:linear-gradient(135deg,#fff8e1,#fff3cd); border:2px solid #ffc107; }
.drive-live { background:linear-gradient(135deg,#e8f5e9,#c8e6c9); border:2px solid #4caf50; }
.progress-bar-banf { background:linear-gradient(90deg,var(--banf-red),var(--banf-light)); }
.btn-banf { background:var(--banf-red); color:#fff; border:none; }
.btn-banf:hover { background:var(--banf-light); color:#fff; }
.btn-banf-outline { background:transparent; color:var(--banf-red); border:2px solid var(--banf-red); }
.btn-banf-outline:hover { background:var(--banf-red); color:#fff; }
pre.text-preview { max-height:160px; overflow-y:auto; font-size:.72rem; background:#f5f5f5; padding:12px; border-radius:8px; white-space:pre-wrap; word-break:break-word; }
.spinner-sm { width:1rem; height:1rem; }
#toastContainer { position:fixed; top:72px; right:20px; z-index:9999; }
</style>
</head>
<body>

<!-- Topbar -->
<div class="topbar d-flex align-items-center justify-content-between">
  <div>
    <h1><i class="fas fa-drum me-2"></i>BANF Membership Drive Admin
      <span class="badge-admin">v3.0</span>
    </h1>
    <div style="font-size:.8rem;opacity:.8;margin-top:2px">
      <span id="adminEmailDisplay">Not logged in</span>
      <span id="configSourceBadge" style="margin-left:12px"></span>
    </div>
  </div>
  <div class="d-flex gap-2 align-items-center">
    <span id="driveStatusPill" class="status-badge status-idle" style="display:none!important"></span>
    <button class="btn btn-sm" style="background:rgba(255,255,255,.2);color:#fff" data-bs-toggle="modal" data-bs-target="#loginModal">
      <i class="fas fa-user-shield me-1"></i>Login
    </button>
  </div>
</div>

<!-- Toast container -->
<div id="toastContainer"></div>

<!-- Login Modal -->
<div class="modal fade" id="loginModal" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header" style="background:var(--banf-red);color:#fff">
        <h6 class="modal-title"><i class="fas fa-lock me-2"></i>Admin Login</h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label fw-semibold">Admin Email</label>
          <input type="email" id="loginEmail" class="form-control" placeholder="admin@example.com">
        </div>
        <div id="loginError" class="alert alert-danger d-none py-2"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-banf w-100" onclick="doLogin()"><i class="fas fa-sign-in-alt me-2"></i>Sign In</button>
      </div>
    </div>
  </div>
</div>

<!-- Main Container -->
<div class="container-xl py-4">
  <!-- Auth Gate -->
  <div id="authGate" class="panel text-center py-5" style="display:none">
    <i class="fas fa-lock fa-3x mb-3" style="color:#ccc"></i>
    <h5>Admin Login Required</h5>
    <p class="text-muted">Click the Login button to authenticate with your admin email.</p>
    <button class="btn btn-banf" data-bs-toggle="modal" data-bs-target="#loginModal">
      <i class="fas fa-user-shield me-2"></i>Login
    </button>
  </div>

  <!-- Main content (shown after auth) -->
  <div id="mainContent">
    <!-- Nav Tabs -->
    <ul class="nav nav-tabs mb-3" id="adminTabs">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tabConfig"><i class="fas fa-cog me-1"></i>Config</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabUniverse"><i class="fas fa-users me-1"></i>Universe</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabDrive"><i class="fas fa-rocket me-1"></i>Drive</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabRegistrations"><i class="fas fa-list-check me-1"></i>Registrations</a></li>
    </ul>

    <div class="tab-content">

      <!-- ===== CONFIG TAB ===== -->
      <div class="tab-pane fade show active" id="tabConfig">
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <div class="panel h-100">
              <h6 class="fw-bold mb-3"><i class="fas fa-upload me-2" style="color:var(--banf-red)"></i>Upload Membership File</h6>
              <div class="upload-zone" id="uploadZone">
                <div class="icon"><i class="fas fa-file-upload"></i></div>
                <div class="fw-semibold">Drop PPTX, XLSX, CSV, or TXT here</div>
                <div class="text-muted mt-1" style="font-size:.82rem">or <span style="color:var(--banf-red);cursor:pointer" onclick="document.getElementById('fileInput').click()">browse</span></div>
                <div id="fileName" class="text-muted mt-2" style="font-size:.78rem"></div>
              </div>
              <input type="file" id="fileInput" accept=".pptx,.xlsx,.csv,.txt" class="d-none">

              <div id="extractedTextSection" class="mt-3 d-none">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <small class="text-muted fw-semibold">Extracted Text Preview</small>
                  <small><span id="extractedLength" class="text-muted"></span></small>
                </div>
                <pre id="extractedTextPreview" class="text-preview"></pre>
              </div>

              <div class="mt-3 d-flex gap-2">
                <button id="parseBtn" class="btn btn-banf flex-grow-1" onclick="parseWithLLM()" disabled>
                  <i class="fas fa-brain me-2"></i>Parse with AI
                </button>
                <button class="btn btn-banf-outline" onclick="clearFile()" title="Clear"><i class="fas fa-times"></i></button>
              </div>

              <div id="parseSpinner" class="text-center mt-3 d-none">
                <div class="spinner-border text-danger spinner-sm me-2"></div>
                <small class="text-muted">LLM is extracting membership config...</small>
              </div>
            </div>
          </div>

          <div class="col-12 col-md-6">
            <div class="panel h-100">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="fw-bold mb-0"><i class="fas fa-code me-2" style="color:var(--banf-red)"></i>Extracted Config JSON</h6>
                <div class="d-flex gap-1">
                  <button class="btn btn-sm btn-outline-secondary" onclick="formatJson()" title="Format JSON"><i class="fas fa-indent"></i></button>
                  <button class="btn btn-sm btn-outline-secondary" onclick="loadHardcoded()" title="Load hardcoded defaults"><i class="fas fa-database"></i></button>
                </div>
              </div>
              <textarea id="configJson" class="json-editor" placeholder='{"year":"FY2026-27","categories":[...],"events":[...],"eventAccess":{"m2_eb":["incl",...]}}' spellcheck="false"></textarea>
              <div id="jsonError" class="text-danger mt-1 d-none" style="font-size:.8rem"></div>
              <div class="d-flex gap-2 mt-3">
                <button class="btn btn-warning btn-sm flex-grow-1" onclick="saveConfig(false)">
                  <i class="fas fa-save me-1"></i>Save as Draft
                </button>
                <button class="btn btn-banf flex-grow-1" onclick="saveConfig(true)">
                  <i class="fas fa-check-circle me-1"></i>Activate Config
                </button>
              </div>
              <div class="mt-3" id="configValidationMsg"></div>
            </div>
          </div>
        </div>

        <!-- Saved Configs -->
        <div class="panel mt-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="fw-bold mb-0"><i class="fas fa-history me-2" style="color:var(--banf-red)"></i>Saved Configurations</h6>
            <button class="btn btn-sm btn-banf-outline" onclick="loadSavedConfigs()"><i class="fas fa-sync me-1"></i>Refresh</button>
          </div>
          <div id="savedConfigsList">
            <div class="text-muted text-center py-3"><i class="fas fa-spinner fa-spin me-2"></i>Loading...</div>
          </div>
        </div>
      </div>

      <!-- ===== UNIVERSE TAB ===== -->
      <div class="tab-pane fade" id="tabUniverse">
        <!-- Stats -->
        <div class="row g-3 mb-3" id="universeStats">
          <div class="col-6 col-md-3"><div class="stat-card"><div class="number" id="statTotal">â€”</div><div class="label">Total</div></div></div>
          <div class="col-6 col-md-3"><div class="stat-card"><div class="number" id="statActive">â€”</div><div class="label">Active</div></div></div>
          <div class="col-6 col-md-3"><div class="stat-card"><div class="number" id="statDemo">â€”</div><div class="label">Demo Tagged</div></div></div>
          <div class="col-6 col-md-3"><div class="stat-card"><div class="number" id="statInactive">â€”</div><div class="label">Inactive</div></div></div>
        </div>

        <div class="row g-3">
          <div class="col-12 col-md-8">
            <div class="panel">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="fw-bold mb-0"><i class="fas fa-users me-2" style="color:var(--banf-red)"></i>Members Universe Pool</h6>
                <div class="d-flex gap-2">
                  <select id="universeFilter" class="form-select form-select-sm" style="width:auto" onchange="loadUniverse()">
                    <option value="">All</option>
                    <option value="active">Active</option>
                    <option value="demo">Demo</option>
                    <option value="inactive">Inactive</option>
                  </select>
                  <button class="btn btn-sm btn-banf-outline" onclick="loadUniverse()"><i class="fas fa-sync"></i></button>
                </div>
              </div>
              <div id="universeTableWrap" style="max-height:400px;overflow-y:auto">
                <table class="table table-sm table-hover align-middle" id="universeTable">
                  <thead class="table-light sticky-top">
                    <tr><th>Email</th><th>Name</th><th>Source</th><th>Demo</th><th>Active</th><th></th></tr>
                  </thead>
                  <tbody id="universeTbody"></tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-4">
            <div class="panel mb-3">
              <h6 class="fw-bold mb-3"><i class="fas fa-user-plus me-2" style="color:var(--banf-red)"></i>Add Member</h6>
              <div class="mb-2"><input type="email" id="newEmail" class="form-control form-control-sm" placeholder="Email*"></div>
              <div class="mb-2"><input type="text" id="newFirst" class="form-control form-control-sm" placeholder="First Name"></div>
              <div class="mb-2"><input type="text" id="newLast" class="form-control form-control-sm" placeholder="Last Name"></div>
              <div class="mb-2"><input type="tel" id="newPhone" class="form-control form-control-sm" placeholder="Phone"></div>
              <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="newIsDemo">
                <label class="form-check-label" for="newIsDemo" style="font-size:.83rem">Tag as Demo Member (EC test)</label>
              </div>
              <button class="btn btn-banf w-100 btn-sm" onclick="addMember()"><i class="fas fa-plus me-2"></i>Add to Universe</button>
            </div>

            <div class="panel">
              <h6 class="fw-bold mb-3"><i class="fas fa-file-csv me-2" style="color:var(--banf-red)"></i>Bulk Import CSV</h6>
              <p style="font-size:.78rem;color:#666" class="mb-2">Paste CSV rows: <code>email,firstName,lastName,phone</code></p>
              <textarea id="bulkCsv" class="form-control" rows="5" style="font-size:.78rem;font-family:monospace" placeholder="john@example.com,John,Doe,555-1234&#10;jane@example.com,Jane,Smith,"></textarea>
              <div class="form-check mt-2 mb-2">
                <input type="checkbox" class="form-check-input" id="bulkDemoFlag">
                <label class="form-check-label" style="font-size:.82rem" for="bulkDemoFlag">Tag all as Demo</label>
              </div>
              <button class="btn btn-warning w-100 btn-sm" onclick="bulkImport()"><i class="fas fa-upload me-2"></i>Import</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== DRIVE TAB ===== -->
      <div class="tab-pane fade" id="tabDrive">
        <!-- Drive Status -->
        <div class="panel mb-3" id="driveStatusPanel">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="fw-bold mb-0"><i class="fas fa-tachometer-alt me-2" style="color:var(--banf-red)"></i>Current Drive Status</h6>
            <div class="d-flex gap-2 align-items-center">
              <span id="autoRefreshIndicator" class="text-muted" style="font-size:.76rem"></span>
              <button class="btn btn-sm btn-banf-outline" onclick="loadDriveStatus()"><i class="fas fa-sync me-1"></i>Refresh</button>
            </div>
          </div>
          <div id="driveStatusCard">
            <div class="text-muted text-center py-3"><i class="fas fa-spinner fa-spin me-2"></i>Loading drive status...</div>
          </div>
        </div>

        <!-- New Drive Cards -->
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <div class="drive-card drive-demo">
              <h6 class="fw-bold mb-2"><i class="fas fa-flask me-2"></i>Demo Drive</h6>
              <p style="font-size:.85rem;color:#666" class="mb-3">
                Sends invitations to <strong>EC committee members + demo-tagged users</strong> only. Use to test the full flow before going live.
              </p>
              <ul style="font-size:.82rem;color:#555;margin-bottom:16px">
                <li>Auto-targets EC emails + <code>isDemo=true</code> universe members</li>
                <li>Full email + registration + payment flow</li>
                <li>Identify issues &amp; fix manually</li>
              </ul>
              <button class="btn btn-warning w-100" onclick="initDrive('demo')">
                <i class="fas fa-play me-2"></i>Initialize Demo Drive
              </button>
            </div>
          </div>
          <div class="col-12 col-md-6">
            <div class="drive-card drive-live">
              <h6 class="fw-bold mb-2"><i class="fas fa-broadcast-tower me-2"></i>Live Drive</h6>
              <p style="font-size:.85rem;color:#666" class="mb-3">
                Sends invitations to <strong>all active members in the Universe pool</strong>. Requires an active membership config.
              </p>
              <ul style="font-size:.82rem;color:#555;margin-bottom:16px">
                <li>Targets all active MembershipUniverse members</li>
                <li>Full BANF membership invitation email</li>
                <li>Real-time progress monitoring below</li>
              </ul>
              <button class="btn btn-success w-100" onclick="initDrive('live')">
                <i class="fas fa-rocket me-2"></i>Initialize Live Drive
              </button>
            </div>
          </div>
        </div>

        <!-- Drive Controls -->
        <div class="panel mt-3" id="driveControlPanel">
          <h6 class="fw-bold mb-3"><i class="fas fa-gamepad me-2" style="color:var(--banf-red)"></i>Drive Controls</h6>
          <div id="driveControlContent">
            <div class="text-muted text-center py-3">No active drive. Initialize a Demo or Live drive above.</div>
          </div>
        </div>
      </div>

      <!-- ===== REGISTRATIONS TAB ===== -->
      <div class="tab-pane fade" id="tabRegistrations">
        <div class="row g-3 mb-3" id="regStats">
          <div class="col-6 col-md-3"><div class="stat-card"><div class="number" id="regTotal">â€”</div><div class="label">Total</div></div></div>
          <div class="col-6 col-md-3"><div class="stat-card"><div class="number text-success" id="regPaid">â€”</div><div class="label">Paid / Active</div></div></div>
          <div class="col-6 col-md-3"><div class="stat-card"><div class="number text-warning" id="regPending">â€”</div><div class="label">Pending Payment</div></div></div>
          <div class="col-6 col-md-3"><div class="stat-card"><div class="number" id="regRevenue">â€”</div><div class="label">Revenue ($)</div></div></div>
        </div>
        <div class="panel">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="fw-bold mb-0"><i class="fas fa-list me-2" style="color:var(--banf-red)"></i>All Registrations</h6>
            <div class="d-flex gap-2">
              <input type="text" id="regSearch" class="form-control form-control-sm" placeholder="Search..." style="width:160px" oninput="filterRegTable()">
              <button class="btn btn-sm btn-banf-outline" onclick="loadRegistrations()"><i class="fas fa-sync"></i></button>
            </div>
          </div>
          <div style="overflow-x:auto">
            <table class="table table-sm table-hover align-middle" id="regTable">
              <thead class="table-light">
                <tr><th>Code</th><th>Name</th><th>Email</th><th>Category</th><th>Household</th><th>Amount</th><th>Status</th><th>Date</th><th>Action</th></tr>
              </thead>
              <tbody id="regTbody"></tbody>
            </table>
          </div>
          <div id="regEmpty" class="text-muted text-center py-3 d-none">No registrations found.</div>
        </div>
      </div>

    </div><!-- tab-content -->
  </div><!-- mainContent -->
</div><!-- container -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// =====================================================================
// CONFIG
// =====================================================================
const API_BASE = 'https://banfwix.wixsite.com/banf1/_functions';
let adminEmail = localStorage.getItem('banf_admin_email') || '';
let currentDriveId = null;
let driveRefreshInterval = null;
let extractedText = '';
let allRegistrations = [];

// =====================================================================
// AUTH
// =====================================================================
function doLogin() {
    const email = document.getElementById('loginEmail').value.trim();
    if (!email) return;
    adminEmail = email;
    localStorage.setItem('banf_admin_email', email);
    bootstrap.Modal.getInstance(document.getElementById('loginModal'))?.hide();
    initApp();
}
function apiHeaders() {
    return { 'Content-Type': 'application/json', 'x-user-email': adminEmail };
}
function initApp() {
    if (!adminEmail) {
        document.getElementById('authGate').style.display = 'block';
        document.getElementById('mainContent').style.display = 'none';
        return;
    }
    document.getElementById('authGate').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
    document.getElementById('adminEmailDisplay').textContent = adminEmail;
    document.getElementById('loginEmail').value = adminEmail;
    loadSavedConfigs();
    loadUniverse();
    loadDriveStatus();
    loadRegistrations();
}

// =====================================================================
// TOAST
// =====================================================================
function toast(msg, type='success') {
    const id = 't' + Date.now();
    const color = type === 'success' ? '#198754' : type === 'danger' ? '#dc3545' : type === 'warning' ? '#fd7e14' : '#0d6efd';
    document.getElementById('toastContainer').insertAdjacentHTML('beforeend', `
      <div id="${id}" class="toast align-items-center text-white show" style="background:${color};min-width:250px;margin-bottom:8px" role="alert">
        <div class="d-flex"><div class="toast-body">${msg}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="document.getElementById('${id}').remove()"></button></div>
      </div>`);
    setTimeout(() => document.getElementById(id)?.remove(), 4000);
}

// =====================================================================
// FILE UPLOAD & PARSING
// =====================================================================
const uploadZone = document.getElementById('uploadZone');
const fileInput  = document.getElementById('fileInput');

uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
uploadZone.addEventListener('drop', e => { e.preventDefault(); uploadZone.classList.remove('drag-over'); handleFile(e.dataTransfer.files[0]); });
uploadZone.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', () => handleFile(fileInput.files[0]));

async function handleFile(file) {
    if (!file) return;
    document.getElementById('fileName').textContent = file.name + ' (' + (file.size/1024).toFixed(1) + ' KB)';
    uploadZone.classList.add('has-file');
    uploadZone.querySelector('.icon i').className = 'fas fa-file-check';
    extractedText = '';

    const ext = file.name.split('.').pop().toLowerCase();
    try {
        if (ext === 'pptx') {
            extractedText = await extractPptxText(file);
        } else if (ext === 'xlsx' || ext === 'xls') {
            extractedText = await extractXlsxText(file);
        } else if (ext === 'csv' || ext === 'txt') {
            extractedText = await file.text();
        } else {
            toast('Unsupported file type. Use PPTX, XLSX, CSV, or TXT.', 'danger');
            return;
        }
        document.getElementById('extractedLength').textContent = extractedText.length + ' chars extracted';
        document.getElementById('extractedTextPreview').textContent = extractedText.substring(0, 1500) + (extractedText.length > 1500 ? '\n...' : '');
        document.getElementById('extractedTextSection').classList.remove('d-none');
        document.getElementById('parseBtn').disabled = false;
        toast('File parsed successfully! Click "Parse with AI" to extract config.', 'info');
    } catch(e) {
        toast('Error reading file: ' + e.message, 'danger');
    }
}

async function extractPptxText(file) {
    const zip = await JSZip.loadAsync(file);
    const slideFiles = Object.keys(zip.files).filter(n => n.match(/ppt\/slides\/slide\d+\.xml/)).sort();
    let text = '';
    for (const sf of slideFiles) {
        const xml = await zip.files[sf].async('string');
        const parser = new DOMParser();
        const doc = parser.parseFromString(xml, 'text/xml');
        const nodes = doc.querySelectorAll('t');
        nodes.forEach(n => { if (n.textContent.trim()) text += n.textContent + ' '; });
        text += '\n';
    }
    return text.trim();
}

async function extractXlsxText(file) {
    const ab = await file.arrayBuffer();
    const wb = XLSX.read(ab, { type: 'array' });
    let text = '';
    wb.SheetNames.forEach(name => {
        text += `\n=== Sheet: ${name} ===\n`;
        const ws = wb.Sheets[name];
        const csv = XLSX.utils.sheet_to_csv(ws);
        text += csv;
    });
    return text.trim();
}

function clearFile() {
    extractedText = '';
    fileInput.value = '';
    document.getElementById('fileName').textContent = '';
    document.getElementById('extractedTextSection').classList.add('d-none');
    document.getElementById('parseBtn').disabled = true;
    uploadZone.classList.remove('has-file');
    uploadZone.querySelector('.icon i').className = 'fas fa-file-upload';
}

async function parseWithLLM() {
    if (!extractedText) return;
    document.getElementById('parseBtn').disabled = true;
    document.getElementById('parseSpinner').classList.remove('d-none');
    try {
        const resp = await fetch(`${API_BASE}/membership_parse_config`, {
            method: 'POST',
            headers: apiHeaders(),
            body: JSON.stringify({ extractedText, fileType: 'auto' })
        });
        const data = await resp.json();
        if (data.success && data.config) {
            document.getElementById('configJson').value = JSON.stringify(data.config, null, 2);
            document.getElementById('jsonError').classList.add('d-none');
            validateJson();
            toast('Config extracted successfully! Review and save.', 'success');
        } else {
            toast('LLM extraction issue: ' + (data.error || 'Unknown error'), 'warning');
            if (data.raw) {
                document.getElementById('configJson').value = data.raw;
            }
        }
    } catch(e) {
        toast('Parse error: ' + e.message, 'danger');
    } finally {
        document.getElementById('parseBtn').disabled = false;
        document.getElementById('parseSpinner').classList.add('d-none');
    }
}

function formatJson() {
    try {
        const v = document.getElementById('configJson').value.trim();
        document.getElementById('configJson').value = JSON.stringify(JSON.parse(v), null, 2);
        document.getElementById('jsonError').classList.add('d-none');
    } catch(e) {
        document.getElementById('jsonError').textContent = 'Invalid JSON: ' + e.message;
        document.getElementById('jsonError').classList.remove('d-none');
    }
}

function validateJson() {
    const v = document.getElementById('configJson').value.trim();
    if (!v) return null;
    try {
        const cfg = JSON.parse(v);
        const cats = cfg.categories?.length || 0;
        const evts = cfg.events?.length || 0;
        document.getElementById('configValidationMsg').innerHTML =
            `<small class="text-success"><i class="fas fa-check-circle me-1"></i>${cats} categories, ${evts} events found. Year: ${cfg.year || '?'}</small>`;
        document.getElementById('jsonError').classList.add('d-none');
        return cfg;
    } catch(e) {
        document.getElementById('jsonError').textContent = 'Invalid JSON: ' + e.message;
        document.getElementById('jsonError').classList.remove('d-none');
        document.getElementById('configValidationMsg').innerHTML = '';
        return null;
    }
}
document.getElementById('configJson').addEventListener('input', validateJson);

async function saveConfig(setActive) {
    const cfg = validateJson();
    if (!cfg) { toast('Fix JSON errors before saving', 'danger'); return; }
    try {
        const resp = await fetch(`${API_BASE}/membership_config_save`, {
            method: 'POST',
            headers: apiHeaders(),
            body: JSON.stringify({ config: cfg, setActive, notes: setActive ? 'Activated via admin panel' : 'Draft' })
        });
        const data = await resp.json();
        if (data.success) {
            toast(setActive ? 'âœ… Config activated! join.html will now use this config.' : 'ðŸ’¾ Saved as draft.', setActive ? 'success' : 'info');
            loadSavedConfigs();
        } else {
            toast('Save failed: ' + (data.error || 'Unknown'), 'danger');
        }
    } catch(e) { toast('Error: ' + e.message, 'danger'); }
}

async function loadSavedConfigs() {
    const el = document.getElementById('savedConfigsList');
    el.innerHTML = '<div class="text-muted text-center py-2"><i class="fas fa-spinner fa-spin me-2"></i>Loading...</div>';
    try {
        const resp = await fetch(`${API_BASE}/membership_config`, { headers: apiHeaders() });
        const data = await resp.json();
        if (!data.configs || data.configs.length === 0) {
            el.innerHTML = '<div class="text-muted text-center py-2">No saved configs yet. Upload a file and parse it above.</div>';
            return;
        }
        el.innerHTML = `<div class="table-responsive"><table class="table table-sm align-middle">
          <thead class="table-light"><tr><th>Year</th><th>Status</th><th>Categories</th><th>Events</th><th>Created</th><th>By</th><th></th></tr></thead>
          <tbody>` + data.configs.map(c => `
            <tr>
              <td><strong>${c.year || '?'}</strong></td>
              <td><span class="status-badge status-${c.status || 'draft'}">${c.status || 'draft'}</span></td>
              <td>${(c.categories || []).length}</td>
              <td>${(c.events || []).length}</td>
              <td style="font-size:.78rem">${c._createdDate ? new Date(c._createdDate).toLocaleDateString() : '?'}</td>
              <td style="font-size:.78rem">${c.createdBy || '?'}</td>
              <td>
                <button class="btn btn-xs btn-sm btn-outline-secondary me-1" onclick="loadConfigIntoEditor(${JSON.stringify(JSON.stringify(c))})" title="Edit"><i class="fas fa-edit"></i></button>
                ${c.status !== 'active' ? `<button class="btn btn-xs btn-sm btn-success" onclick="activateConfig('${c._id}')"><i class="fas fa-check"></i> Activate</button>` : '<span class="text-success fw-bold" style="font-size:.8rem">âœ“ Active</span>'}
              </td>
            </tr>`).join('') + '</tbody></table></div>';
        // Show which source join.html is using
        const activeConfig = data.configs.find(c => c.status === 'active');
        const badge = document.getElementById('configSourceBadge');
        if (activeConfig) {
            badge.innerHTML = `<span class="status-badge status-active">DB Config Active (${activeConfig.year})</span>`;
        } else {
            badge.innerHTML = `<span class="status-badge status-draft">Hardcoded Fallback</span>`;
        }
    } catch(e) {
        el.innerHTML = '<div class="text-danger">Error loading configs: ' + e.message + '</div>';
    }
}

function loadConfigIntoEditor(jsonStr) {
    try {
        const obj = JSON.parse(jsonStr);
        // remove WixData meta fields
        const { _id, _owner, _createdDate, _updatedDate, status, createdBy, parsedAt, notes, ...clean } = obj;
        document.getElementById('configJson').value = JSON.stringify(clean, null, 2);
        validateJson();
        document.querySelector('#adminTabs a[href="#tabConfig"]').click();
        toast('Config loaded into editor for review.', 'info');
    } catch(e) { toast('Load failed: ' + e.message, 'danger'); }
}

async function activateConfig(configId) {
    if (!confirm('Activate this config? It will be used by join.html going forward.')) return;
    // Load the config, then re-save as active
    try {
        const resp = await fetch(`${API_BASE}/membership_config`, { headers: apiHeaders() });
        const data = await resp.json();
        const cfg = data.configs?.find(c => c._id === configId);
        if (!cfg) { toast('Config not found', 'danger'); return; }
        loadConfigIntoEditor(JSON.stringify(cfg));
        await saveConfig(true);
    } catch(e) { toast('Error: ' + e.message, 'danger'); }
}

function loadHardcoded() {
    const sample = {
        year: "FY2026-27",
        categories: [
            { id: "m2_eb", name: "M2 Premium - Early Bird", badge: "BEST VALUE", tagline: "All 17 events included", eventCount: 17, color: "#8B0000", pricing: { family: 375, couple: 290, individual: 215, student: 145 } },
            { id: "m2",    name: "M2 Premium",              badge: "ALL-ACCESS",  tagline: "All 17 events included", eventCount: 17, color: "#DC143C", pricing: { family: 410, couple: 330, individual: 240, student: 165 } },
            { id: "m1",    name: "M1 Regular",              badge: "",            tagline: "Core events + add-ons",  eventCount: 11, color: "#CC6600", pricing: { family: 280, couple: 255, individual: 140, student: 100 } },
            { id: "cultural", name: "Cultural Special",     badge: "HIGHEST Ã— VALUE", tagline: "Cultural focus",   eventCount: 6,  color: "#4B0082", pricing: { family: 180, couple: 140, individual: 100, student: 75 } },
            { id: "dp1",   name: "DP Special-1",            badge: "",            tagline: "DP + Artist events",     eventCount: 6,  color: "#005580", pricing: { family: 210, couple: 175, individual: 130, student: 95 } },
            { id: "dp2",   name: "DP Special-2",            badge: "LOWEST FEE",  tagline: "Core DP events only",    eventCount: 4,  color: "#336600", pricing: { family: 150, couple: 125, individual: 90, student: 65 } }
        ],
        events: [
            { name: "Bosonto Utsob", date: "Mar 7", type: "Cultural" },
            { name: "Noboborsho (Bengali New Year)", date: "Apr 14", type: "Cultural" },
            { name: "Durga Puja Day 1 & 2 + Lunch", date: "Oct 24-25", type: "Religious" },
            { name: "Artist Program Day 1", date: "Oct 24", type: "Cultural" },
            { name: "Kali Puja + Lunch", date: "Nov 14", type: "Religious" },
            { name: "Natok (Drama) + Dinner", date: "Nov 14", type: "Cultural" }
        ],
        eventAccess: {
            m2_eb: ["incl","incl","incl","incl","incl","incl"],
            m2:    ["incl","incl","incl","incl","incl","incl"],
            m1:    ["incl","incl","incl","na",  "incl","incl"],
            cultural: ["incl","incl","na", "na", "na",  "incl"],
            dp1:   ["na",  "na",  "incl","incl","na",  "na" ],
            dp2:   ["na",  "na",  "incl","na",  "na",  "na" ]
        }
    };
    document.getElementById('configJson').value = JSON.stringify(sample, null, 2);
    validateJson();
    toast('Hardcoded defaults loaded â€” this mirrors the PPTX data.', 'info');
}

// =====================================================================
// UNIVERSE
// =====================================================================
async function loadUniverse() {
    const filter = document.getElementById('universeFilter').value;
    const url = `${API_BASE}/membership_universe` + (filter ? `?filter=${filter}` : '');
    try {
        const resp = await fetch(url, { headers: apiHeaders() });
        const data = await resp.json();
        const stats = data.stats || {};
        document.getElementById('statTotal').textContent    = stats.total    ?? '?';
        document.getElementById('statActive').textContent   = stats.active   ?? '?';
        document.getElementById('statDemo').textContent     = stats.demo     ?? '?';
        document.getElementById('statInactive').textContent = stats.inactive ?? '?';
        const tbody = document.getElementById('universeTbody');
        if (!data.members || data.members.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-muted text-center py-3">No members. Add some or import CSV.</td></tr>';
            return;
        }
        tbody.innerHTML = data.members.map(m => `
          <tr class="member-row${m.isDemo ? ' is-demo' : ''}">
            <td style="font-size:.82rem">${m.email}</td>
            <td style="font-size:.82rem">${m.firstName || ''} ${m.lastName || ''}</td>
            <td><span class="badge bg-secondary" style="font-size:.7rem">${m.source || 'manual'}</span></td>
            <td><input type="checkbox" ${m.isDemo ? 'checked' : ''} onchange="setDemo('${m.email}', this.checked)" title="Demo member"></td>
            <td><span class="status-badge ${m.isActive ? 'status-active' : 'status-stopped'}" style="font-size:.7rem">${m.isActive ? 'Active' : 'Off'}</span></td>
            <td><button class="btn btn-xs btn-sm btn-outline-danger" onclick="removeMember('${m.email}')"><i class="fas fa-minus"></i></button></td>
          </tr>`).join('');
    } catch(e) { toast('Error loading universe: ' + e.message, 'danger'); }
}

async function addMember() {
    const email = document.getElementById('newEmail').value.trim();
    if (!email) { toast('Email is required', 'danger'); return; }
    const member = {
        email,
        firstName: document.getElementById('newFirst').value.trim(),
        lastName: document.getElementById('newLast').value.trim(),
        phone: document.getElementById('newPhone').value.trim(),
        isDemo: document.getElementById('newIsDemo').checked,
        source: 'manual'
    };
    try {
        const resp = await fetch(`${API_BASE}/membership_universe_update`, {
            method: 'POST', headers: apiHeaders(),
            body: JSON.stringify({ action: 'add', member })
        });
        const data = await resp.json();
        if (data.success) {
            toast('Member added', 'success');
            ['newEmail','newFirst','newLast','newPhone'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('newIsDemo').checked = false;
            loadUniverse();
        } else { toast('Error: ' + (data.error || 'Unknown'), 'danger'); }
    } catch(e) { toast(e.message, 'danger'); }
}

async function removeMember(email) {
    if (!confirm(`Remove ${email} from universe?`)) return;
    try {
        const resp = await fetch(`${API_BASE}/membership_universe_update`, {
            method: 'POST', headers: apiHeaders(),
            body: JSON.stringify({ action: 'remove', email })
        });
        const data = await resp.json();
        if (data.success) { toast('Deactivated: ' + email); loadUniverse(); }
        else toast('Error: ' + data.error, 'danger');
    } catch(e) { toast(e.message, 'danger'); }
}

async function setDemo(email, val) {
    try {
        await fetch(`${API_BASE}/membership_universe_update`, {
            method: 'POST', headers: apiHeaders(),
            body: JSON.stringify({ action: 'setDemo', email, isDemo: val })
        });
    } catch(e) { /* silent */ }
}

async function bulkImport() {
    const csv = document.getElementById('bulkCsv').value.trim();
    if (!csv) { toast('Paste CSV data first', 'warning'); return; }
    const isDemo = document.getElementById('bulkDemoFlag').checked;
    const members = [];
    const lines = csv.split('\n').map(l => l.trim()).filter(Boolean);
    for (const line of lines) {
        const parts = line.split(',').map(p => p.trim());
        if (!parts[0]) continue;
        members.push({ email:parts[0], firstName:parts[1]||'', lastName:parts[2]||'', phone:parts[3]||'', isDemo, source:'csv_import' });
    }
    if (members.length === 0) { toast('No valid rows found', 'warning'); return; }
    try {
        const resp = await fetch(`${API_BASE}/membership_universe_update`, {
            method: 'POST', headers: apiHeaders(),
            body: JSON.stringify({ action: 'bulkAdd', members })
        });
        const data = await resp.json();
        if (data.success) {
            toast(`Imported ${data.results?.added || members.length} members`, 'success');
            document.getElementById('bulkCsv').value = '';
            loadUniverse();
        } else toast('Import failed: ' + data.error, 'danger');
    } catch(e) { toast(e.message, 'danger'); }
}

// =====================================================================
// DRIVE
// =====================================================================
async function loadDriveStatus() {
    const card = document.getElementById('driveStatusCard');
    const ctrl = document.getElementById('driveControlContent');
    try {
        const resp = await fetch(`${API_BASE}/membership_drive_status`, { headers: apiHeaders() });
        const data = await resp.json();
        const drive = data.drive;
        const regStats = data.stats || {};
        if (!drive) {
            card.innerHTML = `<div class="text-muted text-center py-2">No drive initialized yet. Use Demo or Live buttons below.</div>`;
            ctrl.innerHTML = `<div class="text-muted text-center py-2">No active drive.</div>`;
            stopAutoRefresh();
            return;
        }
        currentDriveId = drive._id;
        const pct = drive.totalTargets > 0 ? Math.round((drive.sentCount / drive.totalTargets) * 100) : 0;
        const modeLabel = drive.mode === 'demo' ? 'ðŸ§ª Demo' : 'ðŸš€ Live';
        card.innerHTML = `
          <div class="row g-3 mb-3">
            <div class="col-6 col-md-3"><div class="stat-card">
              <div class="number">${drive.totalTargets || 0}</div><div class="label">Targets</div></div></div>
            <div class="col-6 col-md-3"><div class="stat-card">
              <div class="number text-success">${drive.sentCount || 0}</div><div class="label">Sent</div></div></div>
            <div class="col-6 col-md-3"><div class="stat-card">
              <div class="number text-danger">${drive.errorCount || 0}</div><div class="label">Errors</div></div></div>
            <div class="col-6 col-md-3"><div class="stat-card">
              <div class="number">${regStats.paid || 0}</div><div class="label">Paid Members</div></div></div>
          </div>
          <div class="d-flex align-items-center gap-3 mb-2">
            <span class="status-badge status-${drive.status}">${drive.status.toUpperCase()}</span>
            <span class="badge bg-secondary">${modeLabel}</span>
            <span style="font-size:.8rem;color:#888">Year: ${drive.year || '?'} | By: ${drive.launchedBy || '?'}</span>
          </div>
          ${drive.totalTargets > 0 ? `<div class="progress mb-2" style="height:16px"><div class="progress-bar progress-bar-banf" style="width:${pct}%">${pct}%</div></div>` : ''}
          <div style="font-size:.76rem;color:#999">Drive ID: ${drive._id} | Launched: ${drive.launchedAt ? new Date(drive.launchedAt).toLocaleString() : '?'}</div>`;

        const isRunnable = ['idle','paused'].includes(drive.status);
        const isRunning  = drive.status === 'running';
        const isStopped  = ['complete','stopped'].includes(drive.status);
        ctrl.innerHTML = `
          <div class="d-flex flex-wrap gap-2">
            ${isRunnable ? `<button class="btn btn-success" onclick="sendNotifications()"><i class="fas fa-paper-plane me-2"></i>Send Invitations</button>` : ''}
            ${isRunning  ? `<button class="btn btn-warning" onclick="doDriveControl('pause')"><i class="fas fa-pause me-2"></i>Pause</button>` : ''}
            ${drive.status === 'paused' ? `<button class="btn btn-success" onclick="doDriveControl('resume')"><i class="fas fa-play me-2"></i>Resume</button>` : ''}
            ${!isStopped ? `<button class="btn btn-danger" onclick="doDriveControl('stop')"><i class="fas fa-stop me-2"></i>Stop Drive</button>` : ''}
            <button class="btn btn-outline-secondary" onclick="doDriveControl('reset')"><i class="fas fa-redo me-2"></i>Reset</button>
          </div>
          ${isRunning ? '<div class="mt-2 text-success" style="font-size:.82rem"><i class="fas fa-circle-notch fa-spin me-1"></i>Drive running â€” auto-refreshing every 5s</div>' : ''}`;

        if (isRunning) startAutoRefresh();
        else stopAutoRefresh();
        // Update top pill
        const pill = document.getElementById('driveStatusPill');
        pill.className = `status-badge status-${drive.status}`;
        pill.textContent = drive.mode.toUpperCase() + ' ' + drive.status.toUpperCase();
        pill.style.display = 'inline-block';
    } catch(e) {
        card.innerHTML = `<div class="text-danger">Error: ${e.message}</div>`;
    }
}

function startAutoRefresh() {
    if (driveRefreshInterval) return;
    document.getElementById('autoRefreshIndicator').textContent = 'Auto-refreshing...';
    driveRefreshInterval = setInterval(loadDriveStatus, 5000);
}
function stopAutoRefresh() {
    if (driveRefreshInterval) { clearInterval(driveRefreshInterval); driveRefreshInterval = null; }
    document.getElementById('autoRefreshIndicator').textContent = '';
}

async function initDrive(mode) {
    const label = mode === 'demo' ? 'Demo Drive' : 'Live Drive';
    if (!confirm(`Initialize a new ${label}?${mode === 'live' ? ' This will send emails to ALL active universe members.' : ''}`)) return;
    try {
        const resp = await fetch(`${API_BASE}/membership_drive_init`, {
            method: 'POST', headers: apiHeaders(),
            body: JSON.stringify({ mode, year: 'FY2026-27' })
        });
        const data = await resp.json();
        if (data.success) {
            currentDriveId = data.driveId;
            toast(`${label} initialized (ID: ${data.driveId})`, 'success');
            loadDriveStatus();
            document.querySelector('#adminTabs a[href="#tabDrive"]').click();
        } else toast('Init failed: ' + (data.error || 'Unknown'), 'danger');
    } catch(e) { toast(e.message, 'danger'); }
}

async function sendNotifications() {
    if (!currentDriveId) { toast('No active drive. Initialize first.', 'warning'); return; }
    if (!confirm('Send invitation emails now?')) return;
    try {
        const resp = await fetch(`${API_BASE}/membership_drive_notify`, {
            method: 'POST', headers: apiHeaders(),
            body: JSON.stringify({ driveId: currentDriveId })
        });
        const data = await resp.json();
        if (data.success) {
            toast(`âœ… Sent ${data.sentCount} invitations (${data.errorCount} errors, mode: ${data.mode})`, 'success');
            loadDriveStatus();
        } else toast('Send failed: ' + (data.error || 'Unknown'), 'danger');
    } catch(e) { toast(e.message, 'danger'); }
}

async function doDriveControl(action) {
    if (!currentDriveId) { toast('No active drive', 'warning'); return; }
    if (action === 'stop' && !confirm('Stop this drive?')) return;
    try {
        const resp = await fetch(`${API_BASE}/membership_drive_control`, {
            method: 'POST', headers: apiHeaders(),
            body: JSON.stringify({ driveId: currentDriveId, action })
        });
        const data = await resp.json();
        if (data.success) { toast(`Drive ${action}d`, 'success'); loadDriveStatus(); }
        else toast('Error: ' + data.error, 'danger');
    } catch(e) { toast(e.message, 'danger'); }
}

// =====================================================================
// REGISTRATIONS
// =====================================================================
async function loadRegistrations() {
    try {
        const resp = await fetch(`${API_BASE}/membership_registrations`, { headers: apiHeaders() });
        const data = await resp.json();
        allRegistrations = data.registrations || [];
        const paid = allRegistrations.filter(r => r.status === 'active').length;
        const pending = allRegistrations.filter(r => r.status === 'pending').length;
        const revenue = allRegistrations.filter(r => r.status === 'active').reduce((s,r) => s + (r.amount || 0), 0);
        document.getElementById('regTotal').textContent   = allRegistrations.length;
        document.getElementById('regPaid').textContent    = paid;
        document.getElementById('regPending').textContent = pending;
        document.getElementById('regRevenue').textContent = '$' + revenue;
        renderRegTable(allRegistrations);
    } catch(e) { document.getElementById('regTbody').innerHTML = `<tr><td colspan="9" class="text-danger">Error: ${e.message}</td></tr>`; }
}

function renderRegTable(rows) {
    const tbody = document.getElementById('regTbody');
    if (!rows.length) {
        tbody.innerHTML = '';
        document.getElementById('regEmpty').classList.remove('d-none');
        return;
    }
    document.getElementById('regEmpty').classList.add('d-none');
    tbody.innerHTML = rows.map(r => `
      <tr>
        <td style="font-size:.78rem"><code>${r.registrationCode || 'â€”'}</code></td>
        <td style="font-size:.82rem">${r.firstName || ''} ${r.lastName || ''}</td>
        <td style="font-size:.78rem">${r.email || ''}</td>
        <td style="font-size:.78rem">${r.categoryName || r.categoryId || ''}</td>
        <td style="font-size:.78rem;text-transform:capitalize">${r.householdType || ''}</td>
        <td style="font-size:.82rem"><strong>$${r.amount || 0}</strong></td>
        <td><span class="status-badge status-${r.status || 'pending'}">${r.status || 'pending'}</span></td>
        <td style="font-size:.75rem">${r._createdDate ? new Date(r._createdDate).toLocaleDateString() : '?'}</td>
        <td>
          ${r.status === 'pending' ?
            `<button class="btn btn-xs btn-sm btn-success" onclick="confirmPayment('${r.registrationCode}')"><i class="fas fa-check me-1"></i>Confirm Payment</button>` :
            `<span class="text-success" style="font-size:.78rem">âœ“ Paid</span>`}
        </td>
      </tr>`).join('');
}

function filterRegTable() {
    const q = document.getElementById('regSearch').value.toLowerCase();
    renderRegTable(allRegistrations.filter(r => JSON.stringify(r).toLowerCase().includes(q)));
}

async function confirmPayment(code) {
    if (!confirm(`Confirm Zelle payment received for ${code}?`)) return;
    try {
        const resp = await fetch(`${API_BASE}/membership_confirm_payment`, {
            method: 'POST', headers: apiHeaders(),
            body: JSON.stringify({ code, confirmedBy: adminEmail, paymentMethod: 'Zelle', notes: 'Confirmed via admin panel' })
        });
        const data = await resp.json();
        if (data.success) { toast('Payment confirmed! Welcome email sent.', 'success'); loadRegistrations(); }
        else toast('Error: ' + (data.error || 'Unknown'), 'danger');
    } catch(e) { toast(e.message, 'danger'); }
}

// =====================================================================
// INIT
// =====================================================================
document.addEventListener('DOMContentLoaded', () => {
    if (adminEmail) {
        initApp();
    } else {
        document.getElementById('authGate').style.display = 'block';
        document.getElementById('mainContent').style.display = 'none';
    }
    // Tab switch events to lazy-load data
    document.querySelectorAll('#adminTabs a[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', e => {
            const t = e.target.getAttribute('href');
            if (t === '#tabUniverse') loadUniverse();
            else if (t === '#tabDrive') loadDriveStatus();
            else if (t === '#tabRegistrations') loadRegistrations();
            else if (t === '#tabConfig') loadSavedConfigs();
        });
    });
});
</script>
</body>
</html>
