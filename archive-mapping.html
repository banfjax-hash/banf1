<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BANF Archive Document Mapping</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  :root { --banf:#8B0000; }
  body { background:#f7f3f3; font-family:'Segoe UI',system-ui,sans-serif; }
  .top-bar { background:var(--banf); color:#fff; padding:10px 24px; display:flex; align-items:center; gap:14px; }
  .top-bar h1 { font-size:1.2rem; font-weight:700; margin:0; }

  .ctrl-bar { background:#fff; border-bottom:1px solid #e0c0c0; padding:10px 20px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .btn-banf { background:var(--banf); color:#fff; border:none; }
  .btn-banf:hover { background:#a00000; color:#fff; }

  .stat-card { background:#fff; border-radius:10px; padding:16px 20px; box-shadow:0 2px 6px rgba(0,0,0,.07); }
  .stat-card .val { font-size:1.8rem; font-weight:800; }
  .stat-card .lbl { font-size:.78rem; color:#777; text-transform:uppercase; letter-spacing:.5px; }

  .tbl-wrap { background:#fff; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.07); overflow:hidden; }
  table { font-size:.82rem; }
  table th { background:#fdf0f0; color:#8B0000; font-weight:700; white-space:nowrap; position:sticky; top:0; z-index:10; }
  table tbody tr:hover { background:#fdf7f7; }
  .row-editing td { background:#fffde7!important; }

  /* Status badges */
  .badge-auto { background:#e2e8f0; color:#334155; }
  .badge-verified { background:#d1fae5; color:#065f46; }
  .badge-corrected { background:#dbeafe; color:#1e40af; }
  .badge-rejected { background:#fee2e2; color:#991b1b; }
  .badge-pending { background:#fef9c3; color:#78350f; }

  /* Confidence dots */
  .conf-high::before   { content:'â—'; color:#16a34a; }
  .conf-medium::before { content:'â—'; color:#f59e0b; }
  .conf-low::before    { content:'â—'; color:#dc3545; }

  .cat-events     { border-left:4px solid #8b5cf6; }
  .cat-financial  { border-left:4px solid #0ea5e9; }
  .cat-membership { border-left:4px solid #16a34a; }
  .cat-governance { border-left:4px solid #f59e0b; }
  .cat-communication { border-left:4px solid #ec4899; }
  .cat-vendor     { border-left:4px solid #6b7280; }
  .cat-analysis   { border-left:4px solid #64748b; }
  .cat-other      { border-left:4px solid #cbd5e1; }

  .edit-btn { background:none; border:1px solid #ccc; border-radius:5px; padding:2px 8px; font-size:.75rem; cursor:pointer; }
  .edit-btn:hover { background:#8B0000; color:#fff; border-color:#8B0000; }
  .save-btn { background:#16a34a; color:#fff; border:none; border-radius:5px; padding:2px 8px; font-size:.75rem; cursor:pointer; }
  .cancel-btn { background:#6c757d; color:#fff; border:none; border-radius:5px; padding:2px 8px; font-size:.75rem; cursor:pointer; }

  .editable-select { font-size:.78rem; border:1px solid #aaa; border-radius:4px; padding:2px 4px; }
  .editable-input  { font-size:.78rem; border:1px solid #aaa; border-radius:4px; padding:2px 4px; width:100%; }

  .filter-pill { background:#fdf0f0; border:1px solid #e0c0c0; border-radius:20px; padding:3px 12px; font-size:.78rem; cursor:pointer; }
  .filter-pill.active { background:var(--banf); color:#fff; border-color:var(--banf); }

  #log-panel { background:#111; color:#4ade80; font-family:monospace; font-size:.75rem; border-radius:8px; padding:10px 14px; max-height:140px; overflow-y:auto; display:none; margin:0 20px 16px; }
  #log-panel.show { display:block; }

  .pending-import-row { background:#fffde7!important; }
  .pending-import-row td .badge { background:#fef3c7; color:#78350f; }

  /* Data source badges */
  .src-catalogue { background:#f1f5f9; color:#475569; border:1px solid #cbd5e1; }
  .src-gdrive    { background:#e8f0fe; color:#1a73e8; border:1px solid #c5d4f6; }
  .src-gmail     { background:#fce8e6; color:#d93025; border:1px solid #f5c6c1; }

  /* Scan progress badges */
  .scan-ok   { color:#16a34a; font-weight:700; }
  .scan-err  { color:#dc3545; font-weight:700; }
  .scan-skip { color:#6b7280; }
  #scan-summary { background:#f0fdf4; border:1px solid #bbf7d0; border-radius:8px; padding:10px 16px; display:none; margin:8px 20px 0; }
</style>
</head>
<body>

<div class="top-bar">
  <i class="fas fa-archive"></i>
  <h1>Archive Document Mapping</h1>
  <a href="https://banfwix.wixsite.com/banf1/_functions/admin_portal" class="btn btn-sm ms-auto" style="background:rgba(255,255,255,.15);color:#fff;border:1px solid rgba(255,255,255,.3)">
    <i class="fas fa-arrow-left me-1"></i>Admin Portal
  </a>
</div>

<!-- Control bar -->
<div class="ctrl-bar">
  <div>
    <label class="small fw-semibold text-muted me-2">Accounting Year:</label>
    <select id="year-sel" class="form-select form-select-sm d-inline-block" style="width:auto;font-weight:700" onchange="onYearChange()">
      <option value="">All Years</option>
      <option value="FY2020-21">FY2020-21</option>
      <option value="FY2021-22">FY2021-22</option>
      <option value="FY2022-23">FY2022-23</option>
      <option value="FY2023-24">FY2023-24</option>
      <option value="FY2024-25" selected>FY2024-25</option>
      <option value="FY2025-26">FY2025-26</option>
      <option value="FY2026-27">FY2026-27</option>
    </select>
  </div>
  <div class="ms-2">
    <label class="small fw-semibold text-muted me-2">Source:</label>
    <select id="mode-sel" class="form-select form-select-sm d-inline-block" style="width:auto">
      <option value="catalog">Catalogue (live classify)</option>
      <option value="db">WixData (saved)</option>
    </select>
  </div>
  <button class="btn btn-banf btn-sm ms-2" onclick="loadData()"><i class="fas fa-search me-1"></i>Load</button>
  <button class="btn btn-warning btn-sm ms-1" onclick="runMapping()"><i class="fas fa-bolt me-1"></i>Run Mapping â†’ Save to Wix</button>
  <div class="vr mx-2"></div>
  <div class="d-flex align-items-center gap-2 flex-wrap">
    <span class="small fw-semibold text-muted">Sources:</span>
    <div class="form-check form-check-inline mb-0">
      <input class="form-check-input" type="checkbox" id="src-cat" checked>
      <label class="form-check-label small" for="src-cat"><i class="fas fa-folder me-1" style="color:#475569"></i>Catalogue</label>
    </div>
    <div class="form-check form-check-inline mb-0">
      <input class="form-check-input" type="checkbox" id="src-gdrive" checked>
      <label class="form-check-label small" for="src-gdrive"><i class="fab fa-google-drive me-1" style="color:#4285F4"></i>Drive</label>
    </div>
    <div class="form-check form-check-inline mb-0">
      <input class="form-check-input" type="checkbox" id="src-gmail" checked>
      <label class="form-check-label small" for="src-gmail"><i class="fas fa-envelope me-1" style="color:#EA4335"></i>Gmail</label>
    </div>
    <button class="btn btn-sm ms-1" id="full-scan-btn" style="background:#1a73e8;color:#fff" onclick="runFullScan()"><i class="fas fa-satellite-dish me-1"></i>Full Scan (All Sources)</button>
  </div>
  <button class="btn btn-outline-secondary btn-sm ms-auto" onclick="exportCSV()"><i class="fas fa-file-csv me-1"></i>Export CSV</button>
  <button class="btn btn-sm ms-1" id="pdf-report-btn" style="background:#8B0000;color:#fff" onclick="openPdfReport()" title="Generate printable PDF report for current year">
    <i class="fas fa-file-pdf me-1"></i>PDF Report
  </button>
  <button class="btn btn-outline-secondary btn-sm ms-1" onclick="document.getElementById('log-panel').classList.toggle('show')"><i class="fas fa-terminal me-1"></i>Log</button>
</div>

<!-- Log panel -->
<div id="log-panel"></div>

<!-- Scan summary -->
<div id="scan-summary"></div>

<!-- Summary stats -->
<div class="container-fluid px-4 pt-3 pb-2" id="stats-area" style="display:none">
  <div class="row g-3 mb-3">
    <div class="col-6 col-md-3 col-lg-2">
      <div class="stat-card text-center">
        <div class="val text-banf" id="st-total" style="color:var(--banf)">â€”</div>
        <div class="lbl">Total Documents</div>
      </div>
    </div>
    <div class="col-6 col-md-3 col-lg-2">
      <div class="stat-card text-center">
        <div class="val text-success" id="st-verified">â€”</div>
        <div class="lbl">Verified</div>
      </div>
    </div>
    <div class="col-6 col-md-3 col-lg-2">
      <div class="stat-card text-center">
        <div class="val text-warning" id="st-auto">â€”</div>
        <div class="lbl">Auto-Mapped</div>
      </div>
    </div>
    <div class="col-6 col-md-3 col-lg-2">
      <div class="stat-card text-center">
        <div class="val text-info" id="st-pending">â€”</div>
        <div class="lbl">Pending Import</div>
      </div>
    </div>
    <div class="col-6 col-md-3 col-lg-2">
      <div class="stat-card text-center">
        <div class="val" id="st-high" style="color:#16a34a">â€”</div>
        <div class="lbl">High Confidence</div>
      </div>
    </div>
    <div class="col-6 col-md-3 col-lg-2">
      <div class="stat-card text-center">
        <div class="val text-danger" id="st-low">â€”</div>
        <div class="lbl">Low Confidence</div>
      </div>
    </div>
  </div>

  <!-- Category breakdown -->
  <div class="row g-2 mb-3" id="cat-pills"></div>

  <!-- Collection breakdown -->
  <div class="row g-2 mb-2" id="col-pills"></div>

  <!-- Source breakdown -->
  <div class="row g-2 mb-2" id="src-pills"></div>

  <!-- Filters -->
  <div class="d-flex gap-2 align-items-center flex-wrap mt-1">
    <span class="small fw-semibold text-muted">Filter:</span>
    <input type="text" id="search-box" class="form-control form-control-sm" placeholder="Search filenameâ€¦" style="max-width:220px" oninput="renderTable()">
    <select id="flt-cat" class="form-select form-select-sm" style="width:auto" onchange="renderTable()">
      <option value="">All Categories</option>
      <option>Events</option><option>Financial</option><option>Membership</option>
      <option>Governance</option><option>Communication</option><option>Vendor</option><option>Analysis</option><option>Other</option>
    </select>
    <select id="flt-col" class="form-select form-select-sm" style="width:auto" onchange="renderTable()">
      <option value="">All Collections</option>
      <option>Events</option><option>FinancialEntries</option><option>MembershipRegistrations</option>
      <option>Members</option><option>AdminRoles</option><option>KnowledgeBase</option><option>Vendors</option>
    </select>
    <select id="flt-status" class="form-select form-select-sm" style="width:auto" onchange="renderTable()">
      <option value="">All Status</option>
      <option>auto-mapped</option><option>verified</option><option>corrected</option><option>rejected</option><option>pending-import</option>
    </select>
    <select id="flt-conf" class="form-select form-select-sm" style="width:auto" onchange="renderTable()">
      <option value="">All Confidence</option>
      <option>high</option><option>medium</option><option>low</option>
    </select>
    <select id="flt-source" class="form-select form-select-sm" style="width:auto" onchange="renderTable()">
      <option value="">All Sources</option>
      <option value="catalogue">Catalogue</option>
      <option value="gdrive">Google Drive</option>
      <option value="gmail">Gmail</option>
    </select>
  </div>
</div>

<!-- Table -->
<div class="px-4 pb-4" id="table-area" style="display:none">
  <div class="tbl-wrap">
    <div class="table-responsive" style="max-height:600px;overflow-y:auto">
      <table class="table table-hover mb-0" id="main-table">
        <thead>
          <tr>
            <th style="width:30px">#</th>
            <th>Filename</th>
            <th>Source Folder</th>
            <th>Type</th>
            <th>Accounting Year</th>
            <th>Category</th>
            <th>Sub-Category</th>
            <th>Target Collection</th>
            <th>Confidence</th>
            <th>Status</th>
            <th>Data Source</th>
            <th>Notes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbl-body"></tbody>
      </table>
    </div>
    <div class="px-3 py-2 border-top d-flex align-items-center gap-3">
      <span class="small text-muted" id="row-count">0 rows shown</span>
      <button class="btn btn-sm btn-outline-success ms-auto" onclick="batchVerifyVisible()"><i class="fas fa-check-double me-1"></i>Verify All Visible</button>
    </div>
  </div>
</div>

<div id="loading-spinner" class="text-center py-5" style="display:none">
  <div class="spinner-border" style="color:var(--banf)" role="status"></div>
  <div class="mt-2 text-muted small">Loading documentsâ€¦</div>
</div>

<div id="empty-msg" class="text-center py-5" style="display:none">
  <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
  <div class="text-muted">No documents found. Select a year and click <strong>Load</strong>.</div>
</div>

<script>
const API      = 'https://banfwix.wixsite.com/banf1/_functions';
const YEAR_SEL = () => document.getElementById('year-sel').value;
const MODE_SEL = () => document.getElementById('mode-sel').value;

function getHeaders() {
  return {
    'Content-Type': 'application/json',
    'x-admin-email': localStorage.getItem('banfAdminEmail') || '',
    'x-admin-token': localStorage.getItem('banfAdminToken') || '',
  };
}

let allDocs = [];      // flat list currently loaded
let editState = {};    // rowKey â†’ { editing:bool, draft:{} }

// â”€â”€ Logging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function log(msg, type='info') {
  const box = document.getElementById('log-panel');
  box.classList.add('show');
  const color = type==='error'?'#f87171':type==='success'?'#4ade80':'#9fdbfe';
  box.innerHTML += `<div style="color:${color}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
  box.scrollTop = box.scrollHeight;
}

// â”€â”€ Data loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  showSpinner(true);
  const yr   = YEAR_SEL();
  const mode = MODE_SEL();
  log(`Loading ${yr||'all years'} from ${mode}â€¦`);

  try {
    let docs = [];
    if (mode === 'catalog') {
      const url  = `${API}/archive_catalog` + (yr ? `?year=${yr}` : '');
      const resp = await fetch(url, { headers: getHeaders() });
      const data = await resp.json();
      if (!data.success) throw new Error(data.message);
      docs = (data.docs||[]).map(d => ({ ...d, mappingStatus: d.mappingStatus || 'auto-mapped', _source:'catalog' }));
      log(`Catalogue: ${docs.length} documents`, 'success');
      renderStats(data.stats, docs);
    } else {
      const url  = `${API}/archive_map_report` + (yr ? `?year=${yr}&limit=500` : '?limit=500');
      const resp = await fetch(url, { headers: getHeaders() });
      const data = await resp.json();
      if (!data.success) throw new Error(data.message);
      const inDB = (data.items||[]).map(d => ({ ...d, _source:'db' }));
      const pending = (data.pendingImport||[]).map(d => ({ ...d, mappingStatus:'pending-import', _source:'pending' }));
      docs = [...inDB, ...pending];
      log(`WixData: ${inDB.length} saved + ${pending.length} pending import`, 'success');
      renderStats(data.stats, docs);
    }
    allDocs = docs;
    renderTable();
    showArea(true);
  } catch(e) {
    log(`Error: ${e.message}`, 'error');
    alert('Load failed: ' + e.message);
  }
  showSpinner(false);
}

async function runMapping() {
  const yr = YEAR_SEL();
  if (!confirm(`Run archive mapping and save to WixData for ${yr||'ALL years'}?\nThis will upsert documents to ArchiveDocuments collection.`)) return;

  log(`Running mapping â†’ save for ${yr||'all years'}â€¦`);
  document.getElementById('log-panel').classList.add('show');

  try {
    const resp = await fetch(`${API}/archive_map`, {
      method: 'POST',
      headers: getHeaders(),
      body: JSON.stringify({ year: yr||undefined, overwriteExisting: false })
    });
    const data = await resp.json();
    if (!data.success) throw new Error(data.message||'Mapping failed');

    const r = data.results;
    log(`Mapping complete: ${r.saved} new | ${r.updated} updated | ${r.skipped} skipped | ${r.errors.length} errors`, 'success');
    if (r.errors.length) r.errors.forEach(e => log(`  ERROR: ${e.file} â€” ${e.error}`, 'error'));

    // Auto-switch to DB view and reload
    document.getElementById('mode-sel').value = 'db';
    await loadData();
  } catch(e) {
    log(`Run mapping failed: ${e.message}`, 'error');
    alert('Mapping failed: ' + e.message);
  }
}

function onYearChange() {
  allDocs = [];
  editState = {};
  showArea(false);
  document.getElementById('scan-summary').style.display = 'none';
}

// â”€â”€ Source badge helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sourceBadge(src) {
  const s = src || 'catalogue';
  const labels = { catalogue:'<i class="fas fa-folder me-1"></i>Catalogue', gdrive:'<i class="fab fa-google-drive me-1"></i>Drive', gmail:'<i class="fas fa-envelope me-1"></i>Gmail' };
  const cls    = { catalogue:'src-catalogue', gdrive:'src-gdrive', gmail:'src-gmail' };
  return `<span class="badge ${cls[s]||'src-catalogue'}" style="font-size:.7rem">${labels[s]||s}</span>`;
}

// â”€â”€ Full Scan (all data sources) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runFullScan() {
  const yr      = YEAR_SEL();
  const sources = [];
  if (document.getElementById('src-cat').checked)    sources.push('catalogue');
  if (document.getElementById('src-gdrive').checked) sources.push('gdrive');
  if (document.getElementById('src-gmail').checked)  sources.push('gmail');
  if (!sources.length) return alert('Select at least one data source.');

  if (!confirm(`Run Full Scan (${sources.join(', ')}) for ${yr||'ALL years'}?\n\nThis will scan Google Drive and Gmail in real-time and save all found documents to WixData.`)) return;

  const btn = document.getElementById('full-scan-btn');
  if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Scanningâ€¦'; }
  log(`Starting full scan for ${yr||'all years'} from: ${sources.join(', ')}â€¦`);
  document.getElementById('log-panel').classList.add('show');
  const sumEl = document.getElementById('scan-summary');
  sumEl.style.display = 'none';

  try {
    const resp = await fetch(`${API}/archive_full_scan`, {
      method: 'POST',
      headers: getHeaders(),
      body: JSON.stringify({ year: yr || undefined, sources, overwriteExisting: false })
    });
    const data = await resp.json();
    if (!data.success) throw new Error(data.message || 'Full scan failed');

    const sl = data.scanLog || {};

    // Build per-source log lines
    const srcDetails = [];
    if (sl.catalogue) {
      const ok = sl.catalogue.status === 'ok';
      log(`ğŸ“ Catalogue: ${sl.catalogue.count} documents â€” ${sl.catalogue.status}`, ok?'success':'error');
      srcDetails.push(`<span class="me-3"><i class="fas fa-folder me-1" style="color:#475569"></i><strong>${sl.catalogue.count}</strong> from Catalogue</span>`);
    }
    if (sl.gdrive) {
      const ok = sl.gdrive.status === 'ok';
      log(`â˜ï¸ Google Drive: ${sl.gdrive.count} docs for ${yr||'all years'} (${sl.gdrive.totalInDrive||0} total found) â€” ${sl.gdrive.status}`, ok?'success':'error');
      if (!ok) log(`   Drive error: ${sl.gdrive.error||''}`, 'error');
      srcDetails.push(`<span class="me-3"><i class="fab fa-google-drive me-1" style="color:#1a73e8"></i><strong>${sl.gdrive.count}</strong> from Google Drive</span>`);
    }
    if (sl.gmail) {
      const ok = sl.gmail.status === 'ok';
      log(`ğŸ“§ Gmail: ${sl.gmail.count} emails (${sl.gmail.totalMessages||0} messages scanned) â€” ${sl.gmail.status}`, ok?'success':'error');
      if (!ok) log(`   Gmail error: ${sl.gmail.error||''}`, 'error');
      srcDetails.push(`<span class="me-3"><i class="fas fa-envelope me-1" style="color:#d93025"></i><strong>${sl.gmail.count}</strong> from Gmail</span>`);
    }

    const r = data.results;
    log(`âœ… Scan complete: ${r.saved} new | ${r.updated} updated | ${r.skipped} skipped | ${r.errors?.length||0} errors â€” Total: ${data.totalDocs} docs`, 'success');
    if (r.errors?.length) r.errors.slice(0, 5).forEach(e => log(`  âš ï¸ ${e.file} â€” ${e.error}`, 'error'));

    // Show summary bar
    sumEl.innerHTML = `<div class="d-flex align-items-center flex-wrap gap-2">
      <strong class="text-success me-2"><i class="fas fa-check-circle me-1"></i>Full Scan Complete</strong>
      ${srcDetails.join('')}
      <span class="ms-2 text-muted small">${r.saved} new Â· ${r.updated} updated Â· ${r.skipped} skipped Â· ${data.totalDocs} total</span>
    </div>`;
    sumEl.style.display = '';

    // Auto-switch to WixData view and reload
    document.getElementById('mode-sel').value = 'db';
    await loadData();
  } catch(e) {
    log(`Full scan failed: ${e.message}`, 'error');
    alert('Full scan failed: ' + e.message);
  } finally {
    if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-satellite-dish me-1"></i>Full Scan (All Sources)'; }
  }
}

// â”€â”€ Stats rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderStats(stats, docs) {
  document.getElementById('stats-area').style.display = '';
  document.getElementById('st-total').textContent     = docs.length;
  document.getElementById('st-verified').textContent  = docs.filter(d=>d.mappingStatus==='verified').length;
  document.getElementById('st-auto').textContent      = docs.filter(d=>d.mappingStatus==='auto-mapped').length;
  document.getElementById('st-pending').textContent   = docs.filter(d=>d.mappingStatus==='pending-import').length;
  document.getElementById('st-high').textContent      = docs.filter(d=>d.confidence==='high').length;
  document.getElementById('st-low').textContent       = docs.filter(d=>d.confidence==='low').length;

  // Category pills
  const byCat = countBy(docs, 'category');
  const catColors = { Events:'#8b5cf6', Financial:'#0ea5e9', Membership:'#16a34a', Governance:'#f59e0b', Communication:'#ec4899', Vendor:'#6b7280', Analysis:'#64748b', Other:'#cbd5e1' };
  document.getElementById('cat-pills').innerHTML = Object.entries(byCat).map(([k,v]) =>
    `<div class="col-auto"><span class="badge rounded-pill" style="background:${catColors[k]||'#888'};font-size:.78rem;padding:5px 12px">${k} <strong>${v}</strong></span></div>`).join('');

  // Collection pills
  const byCol = countBy(docs, 'targetCollection');
  document.getElementById('col-pills').innerHTML = Object.entries(byCol).map(([k,v]) =>
    `<div class="col-auto"><span class="badge rounded-pill bg-secondary" style="font-size:.74rem;padding:4px 10px;opacity:.85">${k}: ${v}</span></div>`).join('');

  // Source pills
  const bySrc = countBy(docs, 'source');
  const srcClr = { catalogue:'#475569', gdrive:'#1a73e8', gmail:'#d93025' };
  const srcIco = { catalogue:'fa-folder', gdrive:'fa-google-drive fab', gmail:'fa-envelope fas' };
  document.getElementById('src-pills').innerHTML = Object.entries(bySrc).map(([k,v]) =>
    `<div class="col-auto"><span class="badge rounded-pill" style="background:${srcClr[k]||'#888'};color:#fff;font-size:.74rem;padding:4px 10px"><i class="${(srcIco[k]||'fas fa-file')} me-1"></i>${k}: <strong>${v}</strong></span></div>`).join('');
}

// â”€â”€ Table rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTable() {
  const search  = document.getElementById('search-box').value.toLowerCase();
  const fltCat  = document.getElementById('flt-cat').value;
  const fltCol  = document.getElementById('flt-col').value;
  const fltSt   = document.getElementById('flt-status').value;
  const fltConf = document.getElementById('flt-conf').value;

  let filtered = allDocs.filter(d => {
    if (search && !d.filename.toLowerCase().includes(search) && !(d.originalPath||'').toLowerCase().includes(search)) return false;
    if (fltCat  && d.category         !== fltCat)  return false;
    if (fltCol  && d.targetCollection !== fltCol)  return false;
    if (fltSt   && d.mappingStatus    !== fltSt)   return false;
      if (fltConf && d.confidence !== fltConf) return false;
    const fltSrc = (document.getElementById('flt-source')?.value) || '';
    if (fltSrc  && (d.source||'catalogue') !== fltSrc) return false;
    return true;
  });

  const rowKey = d => d.docKey || d.originalPath;

  document.getElementById('tbl-body').innerHTML = filtered.map((d, i) => {
    const key       = rowKey(d);
    const isEditing = editState[key]?.editing;
    const draft     = editState[key]?.draft || d;
    const isPending = d.mappingStatus === 'pending-import';
    const catClass  = 'cat-' + (d.category||'other').toLowerCase();
    const stBadge   = statusBadge(d.mappingStatus);
    const confClass = `conf-${d.confidence||'low'}`;

    if (isEditing) {
      return `<tr class="row-editing ${catClass}" id="row-${i}">
        <td class="text-muted">${i+1}</td>
        <td><strong>${esc(d.filename)}</strong><div class="text-muted small">${esc(d.originalPath)}</div></td>
        <td><span class="badge bg-secondary">${esc(d.sourceFolder)}</span></td>
        <td><span class="badge bg-light text-dark border">${esc(d.fileType)}</span></td>
        <td>
          <select class="editable-select" id="edit-year-${i}">
            ${yearOptions(draft.accountingYear)}
          </select>
        </td>
        <td>
          <select class="editable-select" id="edit-cat-${i}" onchange="syncCollection(${i}, this.value, '${i}')">
            ${catOptions(draft.category)}
          </select>
        </td>
        <td><input class="editable-input" id="edit-sub-${i}" value="${esc(draft.subCategory||'')}"></td>
        <td>
          <select class="editable-select" id="edit-col-${i}">
            ${colOptions(draft.targetCollection)}
          </select>
        </td>
        <td><span class="${confClass} me-1"></span>${draft.confidence||''}</td>
        <td>${stBadge}</td>
        <td>${sourceBadge(d.source)}</td>
        <td><input class="editable-input" id="edit-notes-${i}" value="${esc(draft.notes||'')}"></td>
        <td>
          <button class="save-btn me-1" onclick="saveRow('${esc(key)}', ${i}, 'correct')">Save</button>
          <button class="save-btn me-1" style="background:#16a34a" onclick="saveRow('${esc(key)}', ${i}, 'verify')">âœ“ Verify</button>
          <button class="cancel-btn" onclick="cancelEdit('${esc(key)}', ${i})">âœ•</button>
        </td>
      </tr>`;
    }

    return `<tr class="${catClass}${isPending?' pending-import-row':''}" id="row-${i}">
      <td class="text-muted small">${i+1}</td>
      <td>
        <strong>${esc(d.filename)}</strong>
        <div class="text-muted" style="font-size:.72rem;word-break:break-all">${esc(d.originalPath)}</div>
      </td>
      <td><span class="badge bg-secondary" style="font-size:.7rem">${esc(d.sourceFolder||'')}</span></td>
      <td><span class="badge bg-light text-dark border" style="font-size:.7rem">${esc(d.fileType||'')}</span></td>
      <td>${esc(d.accountingYear||'â€”')}</td>
      <td><span class="badge" style="background:${catColor(d.category)};color:#fff;font-size:.72rem">${esc(d.category||'')}</span></td>
      <td class="small">${esc(d.subCategory||'â€”')}</td>
      <td><code style="font-size:.72rem">${esc(d.targetCollection||'')}</code></td>
      <td><span class="${confClass} me-1"></span><span class="small">${d.confidence||''}</span></td>
      <td>${stBadge}${isPending?'<div style="font-size:.65rem;color:#78350f;margin-top:2px">Run Mapping to save</div>':''}</td>
      <td>${sourceBadge(d.source)}</td>
      <td class="small text-muted">${esc(d.notes||'')}</td>
      <td nowrap>
        <button class="edit-btn" onclick="startEdit('${esc(key)}', ${i})" title="Edit mapping"><i class="fas fa-edit"></i></button>
        ${d.mappingStatus !== 'verified' ? `<button class="save-btn ms-1" onclick="quickVerify('${esc(key)}', ${i})" title="Mark verified"><i class="fas fa-check"></i></button>` : ''}
        ${d.mappingStatus !== 'rejected' ? `<button class="cancel-btn ms-1" onclick="quickReject('${esc(key)}', ${i})" title="Reject"><i class="fas fa-times"></i></button>` : ''}
      </td>
    </tr>`;
  }).join('');

  document.getElementById('row-count').textContent = `${filtered.length} of ${allDocs.length} documents`;
  window._filteredDocs = filtered;
}

// â”€â”€ Edit helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startEdit(key, idx) {
  editState[key] = { editing: true, draft: { ...allDocs.find(d=>(d.docKey||d.originalPath)===key) } };
  renderTable();
  const el = document.getElementById('row-' + idx);
  if (el) el.scrollIntoView({ block:'nearest' });
}
function cancelEdit(key, idx) {
  delete editState[key];
  renderTable();
}

async function saveRow(key, idx, action) {
  const el = id => document.getElementById(id + '-' + idx);
  const body = {
    docKey:          key,
    accountingYear:  el('edit-year') ?.value,
    category:        el('edit-cat')  ?.value,
    subCategory:     el('edit-sub')  ?.value,
    targetCollection:el('edit-col')  ?.value,
    notes:           el('edit-notes')?.value,
    action,
    adminEmail: localStorage.getItem('banfAdminEmail') || 'admin',
  };
  try {
    log(`Saving: ${key} â†’ action=${action}`);
    const resp = await fetch(`${API}/archive_map_update`, { method:'POST', headers:getHeaders(), body:JSON.stringify(body) });
    const data = await resp.json();
    if (!data.success) throw new Error(data.message);
    // Update in-memory
    const docIdx = allDocs.findIndex(d=>(d.docKey||d.originalPath)===key);
    if (docIdx >= 0) {
      allDocs[docIdx] = { ...allDocs[docIdx], ...body, mappingStatus: action==='verify'?'verified':(action==='correct'?'corrected':allDocs[docIdx].mappingStatus), _source:'db' };
    }
    delete editState[key];
    log(`Saved ${key}`, 'success');
    renderTable();
  } catch(e) {
    log(`Save failed: ${e.message}`, 'error');
    alert('Save failed: ' + e.message);
  }
}

async function quickVerify(key, idx) {
  await patchStatus(key, 'verify');
}
async function quickReject(key, idx) {
  if (!confirm('Mark this document as rejected?')) return;
  await patchStatus(key, 'reject');
}
async function patchStatus(key, action) {
  try {
    const resp = await fetch(`${API}/archive_map_update`, {
      method:'POST', headers:getHeaders(),
      body: JSON.stringify({ docKey:key, action, adminEmail:localStorage.getItem('banfAdminEmail')||'admin' })
    });
    const data = await resp.json();
    if (!data.success) throw new Error(data.message);
    const docIdx = allDocs.findIndex(d=>(d.docKey||d.originalPath)===key);
    if (docIdx >= 0) allDocs[docIdx].mappingStatus = action==='verify'?'verified':'rejected';
    log(`${action}: ${key}`, 'success');
    renderTable();
  } catch(e) { log('Patch failed: ' + e.message, 'error'); }
}

async function batchVerifyVisible() {
  const visible  = (window._filteredDocs||[]).filter(d=>d.mappingStatus!=='verified');
  if (!visible.length) { alert('No unverified documents visible.'); return; }
  if (!confirm(`Mark ${visible.length} visible documents as verified?`)) return;
  let ok=0, err=0;
  for (const d of visible) {
    try {
      const resp = await fetch(`${API}/archive_map_update`, {
        method:'POST', headers:getHeaders(),
        body: JSON.stringify({ docKey:d.docKey||d.originalPath, action:'verify', adminEmail:localStorage.getItem('banfAdminEmail')||'admin' })
      });
      const data = await resp.json();
      if (data.success) { d.mappingStatus='verified'; ok++; }
      else err++;
    } catch(_) { err++; }
  }
  log(`Batch verify: ${ok} verified, ${err} errors`, ok&&!err?'success':'info');
  renderTable();
}

// â”€â”€ Collection auto-suggest â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function syncCollection(idx, category, sfx) {
  const catToCol = { Events:'Events', Financial:'FinancialEntries', Membership:'MembershipRegistrations', Governance:'AdminRoles', Communication:'KnowledgeBase', Vendor:'Vendors', Analysis:'KnowledgeBase', Other:'KnowledgeBase' };
  const colSel = document.getElementById('edit-col-' + sfx);
  if (colSel) colSel.value = catToCol[category] || 'KnowledgeBase';
}

// â”€â”€ Export CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportCSV() {
  const docs = window._filteredDocs || allDocs;
  const hdr = 'Filename,OriginalPath,FileType,Category,SubCategory,AccountingYear,TargetCollection,Confidence,Status,Notes,SourceFolder,FileSize';
  const rows = docs.map(d => [
    d.filename, d.originalPath, d.fileType, d.category, d.subCategory,
    d.accountingYear, d.targetCollection, d.confidence, d.mappingStatus,
    (d.notes||'').replace(/,/g,'|'), d.sourceFolder, d.fileSize
  ].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(','));
  const csv  = [hdr, ...rows].join('\n');
  const yr   = YEAR_SEL() || 'all';
  const blob = new Blob([csv], {type:'text/csv'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a'); a.href=url; a.download=`BANF_Archive_Mapping_${yr}.csv`; a.click();
  URL.revokeObjectURL(url);
  log(`CSV exported: ${rows.length} rows`, 'success');
}

// â”€â”€ PDF Report â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPdfReport() {
  const yr = YEAR_SEL() || 'FY2024-25';
  const url = `${API}/archive_scan_report?year=${encodeURIComponent(yr)}`;
  window.open(url, '_blank');
  log(`Opening PDF report for ${yr} in new tabâ€¦`, 'success');
}

// â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSpinner(v) {
  document.getElementById('loading-spinner').style.display = v?'':'none';
  if (v) { document.getElementById('stats-area').style.display='none'; document.getElementById('table-area').style.display='none'; }
}
function showArea(v) {
  document.getElementById('table-area').style.display = v?'':'none';
  document.getElementById('empty-msg').style.display  = (!v && !allDocs.length) ? '' : 'none';
}

function catColor(cat) {
  return {Events:'#8b5cf6',Financial:'#0ea5e9',Membership:'#16a34a',Governance:'#f59e0b',Communication:'#ec4899',Vendor:'#6b7280',Analysis:'#64748b'}[cat]||'#888';
}

function statusBadge(s) {
  const map = { 'auto-mapped':'badge-auto', verified:'badge-verified', corrected:'badge-corrected', rejected:'badge-rejected', 'pending-import':'badge-pending' };
  const label = { 'auto-mapped':'Auto-Mapped', verified:'âœ“ Verified', corrected:'Corrected', rejected:'âœ— Rejected', 'pending-import':'Pending Import' };
  return `<span class="badge ${map[s]||'badge-auto'}" style="font-size:.7rem">${label[s]||s}</span>`;
}

function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function countBy(arr, key) { return arr.reduce((a,i)=>{ const v=i[key]||'unknown'; a[v]=(a[v]||0)+1; return a; }, {}); }

function yearOptions(sel) {
  return ['FY2020-21','FY2021-22','FY2022-23','FY2023-24','FY2024-25','FY2025-26','FY2026-27','unknown'].map(y =>
    `<option value="${y}" ${y===sel?'selected':''}>${y}</option>`).join('');
}
function catOptions(sel) {
  return ['Events','Financial','Membership','Governance','Communication','Vendor','Analysis','Other'].map(c =>
    `<option value="${c}" ${c===sel?'selected':''}>${c}</option>`).join('');
}
function colOptions(sel) {
  return ['Events','FinancialEntries','MembershipRegistrations','Members','AdminRoles','KnowledgeBase','Vendors'].map(c =>
    `<option value="${c}" ${c===sel?'selected':''}>${c}</option>`).join('');
}

// â”€â”€ Auto-load on page open â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function init() {
  // Default: catalog view for FY2024-25
  document.getElementById('year-sel').value = 'FY2024-25';
  document.getElementById('mode-sel').value = 'catalog';
  loadData();
})();
</script>
</body>
</html>
