<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BANF ‚Äî Communications Drive Dashboard</title>
<style>
:root {
  --red:#8B0000; --crimson:#DC143C; --gold:#D4AF37;
  --bg:#f0f4f8; --card:#fff; --border:#e2e8f0;
  --text:#1e293b; --muted:#64748b; --green:#16a34a;
  --blue:#1d4ed8; --orange:#ea580c; --purple:#7c3aed;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',Arial,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

/* Header */
.header{background:linear-gradient(135deg,var(--red),var(--crimson));padding:18px 28px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
.header h1{color:#fff;font-size:1.25rem;font-weight:700}
.header .subtitle{color:rgba(255,255,255,.8);font-size:.82rem;margin-top:3px}
.header-right{display:flex;align-items:center;gap:12px}
.refresh-badge{background:rgba(255,255,255,.15);color:#fff;font-size:.75rem;padding:5px 12px;border-radius:20px;cursor:pointer;border:1px solid rgba(255,255,255,.3);transition:.2s}
.refresh-badge:hover{background:rgba(255,255,255,.25)}
.auto-badge{background:rgba(255,255,255,.1);color:rgba(255,255,255,.75);font-size:.72rem;padding:4px 10px;border-radius:20px}

/* Main content */
.main{padding:24px 28px;max-width:1600px;margin:0 auto}

/* Stats grid */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:14px;margin-bottom:28px}
.stat-card{background:var(--card);border-radius:14px;padding:18px 16px;border:2px solid transparent;cursor:pointer;transition:.2s;box-shadow:0 1px 4px rgba(0,0,0,.06)}
.stat-card:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,.1)}
.stat-card.active{border-color:var(--crimson);box-shadow:0 4px 16px rgba(139,0,0,.2)}
.stat-card.active-all{border-color:var(--crimson)}
.stat-num{font-size:2rem;font-weight:800;line-height:1}
.stat-label{font-size:.78rem;color:var(--muted);margin-top:6px;font-weight:500}
.stat-pct{font-size:.72rem;color:var(--muted);margin-top:3px}
.dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px}
.c-sent{color:var(--blue)} .bg-sent{background:var(--blue)}
.c-opened{color:#0891b2} .bg-opened{background:#0891b2}
.c-verified{color:var(--green)} .bg-verified{background:var(--green)}
.c-modified{color:var(--orange)} .bg-modified{background:var(--orange)}
.c-declined{color:var(--red)} .bg-declined{background:var(--red)}
.c-optout{color:var(--purple)} .bg-optout{background:var(--purple)}
.c-pending{color:#b45309} .bg-pending{background:#b45309}
.c-rate{color:#0f766e} .bg-rate{background:#0f766e}

/* Drill-down section */
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:10px}
.section-title{font-size:1rem;font-weight:700;color:var(--text)}
.filter-info{font-size:.8rem;color:var(--muted);background:#f1f5f9;padding:5px 14px;border-radius:20px}
.search-box{display:flex;gap:8px;flex-wrap:wrap}
.search-box input{border:1px solid var(--border);border-radius:8px;padding:7px 12px;font-size:.82rem;outline:none;min-width:220px}
.search-box input:focus{border-color:var(--crimson)}

/* Table */
.table-wrap{background:var(--card);border-radius:14px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.06);overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:.82rem}
thead{background:#f8fafc}
th{padding:10px 14px;text-align:left;font-weight:600;color:var(--muted);font-size:.75rem;text-transform:uppercase;letter-spacing:.4px;border-bottom:1px solid var(--border);white-space:nowrap}
td{padding:10px 14px;border-bottom:1px solid #f1f5f9;vertical-align:middle}
tr:last-child td{border-bottom:none}
tr:hover td{background:#fafafa}
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:.72rem;font-weight:600;white-space:nowrap}
.badge-pending{background:#fef3c7;color:#92400e}
.badge-corrected{background:#d1fae5;color:#065f46}
.badge-declined{background:#fee2e2;color:#991b1b}
.badge-yes{background:#dbeafe;color:#1e40af}
.badge-no{background:#f3f4f6;color:#6b7280}
.badge-modified{background:#ffedd5;color:#9a3412}
.badge-verified{background:#dcfce7;color:#14532d}
.badge-optout{background:#ede9fe;color:#4c1d95}

/* Empty state */
.empty{text-align:center;padding:48px;color:var(--muted)}
.empty-icon{font-size:2.5rem;margin-bottom:12px}

/* Loading */
.loading{text-align:center;padding:60px;color:var(--muted)}
.spinner{width:36px;height:36px;border:4px solid #e2e8f0;border-top-color:var(--crimson);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}

/* Last updated */
.footer-bar{text-align:center;color:var(--muted);font-size:.75rem;padding:20px;margin-top:8px}

/* Responsive */
@media(max-width:600px){
  .header{padding:14px 16px}
  .main{padding:16px}
  .stats-grid{grid-template-columns:repeat(2,1fr);gap:10px}
}
</style>
</head>
<body>

<div class="header">
  <div>
    <h1>BANF ‚Äî Communications Drive Dashboard</h1>
    <div class="subtitle" id="driveSubtitle">Communications Details Correction Drive ‚Ä¢ Loading‚Ä¶</div>
  </div>
  <div class="header-right">
    <span class="auto-badge" id="autoLabel">üîÑ Auto-refresh: 30s</span>
    <button class="refresh-badge" onclick="loadData()">‚Üª Refresh Now</button>
  </div>
</div>

<div class="main">

  <!-- Stats cards -->
  <div class="stats-grid" id="statsGrid">
    <div class="loading" style="grid-column:1/-1"><div class="spinner"></div>Loading dashboard‚Ä¶</div>
  </div>

  <!-- Drill-down table -->
  <div class="section-header">
    <div>
      <div class="section-title">Member Details</div>
    </div>
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
      <span class="filter-info" id="filterInfo">Showing all</span>
      <div class="search-box">
        <input id="searchBox" type="text" placeholder="Search by email or name‚Ä¶" oninput="applyFilters()">
      </div>
    </div>
  </div>

  <div class="table-wrap" id="tableWrap">
    <div class="loading"><div class="spinner"></div>Loading‚Ä¶</div>
  </div>

</div>

<div class="footer-bar" id="footerBar">Last updated: loading‚Ä¶</div>

<script>
const WIX_BASE = 'https://banfwix.wixsite.com/banf1/_functions';
let allRows = [];
let activeFilter = 'all';
let refreshInterval;

const STAT_DEFS = [
  { key:'totalSent',         label:'Emails Sent',           cls:'c-sent',     bg:'bg-sent',     filter:'all' },
  { key:'formOpened',        label:'Form Opened',           cls:'c-opened',   bg:'bg-opened',   filter:'opened' },
  { key:'approvedNoChange',  label:'Verified (No Changes)', cls:'c-verified', bg:'bg-verified', filter:'no_change' },
  { key:'approvedWithChange', label:'Verified (Modified)',  cls:'c-modified', bg:'bg-modified', filter:'modified' },
  { key:'declined',          label:'Declined',              cls:'c-declined', bg:'bg-declined', filter:'declined' },
  { key:'optedOut',          label:'Unsubscribed',          cls:'c-optout',   bg:'bg-optout',   filter:'optout' },
  { key:'pending',           label:'Pending Response',      cls:'c-pending',  bg:'bg-pending',  filter:'pending' },
  { key:'responseRate',      label:'Response Rate (%)',     cls:'c-rate',     bg:'bg-rate',     filter:'all', suffix:'%' },
];

async function loadData() {
  try {
    const resp = await fetch(WIX_BASE + '/comms_dashboard_data', {
      headers: { 'x-user-email': getAdminEmail() }
    });
    const data = await resp.json();
    if (!data.success) { showError(data.error || 'Access denied'); return; }
    allRows = data.drillDown || [];
    renderStats(data.stats);
    applyFilters();
    document.getElementById('footerBar').textContent = 'Last updated: ' + new Date(data.stats.lastUpdated).toLocaleString();
    document.getElementById('driveSubtitle').textContent =
      `Communications Details Correction Drive  ‚Ä¢  ${data.stats.totalSent} emails sent  ‚Ä¢  ${data.stats.responseRate}% response rate`;
  } catch (e) {
    showError('Could not load dashboard: ' + e.message);
  }
}

function getAdminEmail() {
  let em = sessionStorage.getItem('banf_admin_email') || '';
  if (!em) {
    em = prompt('Enter your BANF admin email to access the dashboard:') || '';
    if (em) sessionStorage.setItem('banf_admin_email', em.trim().toLowerCase());
  }
  return em;
}

function renderStats(stats) {
  const grid = document.getElementById('statsGrid');
  grid.innerHTML = STAT_DEFS.map(d => {
    const val = stats[d.key] !== undefined ? stats[d.key] : '‚Äî';
    const pct  = d.key !== 'responseRate' && stats.totalSent > 0
      ? `${Math.round((val / stats.totalSent) * 100)}% of total` : '';
    const isActive = activeFilter === d.filter;
    return `<div class="stat-card ${isActive ? 'active' : ''}" onclick="setFilter('${d.filter}','${d.label}')">
      <div class="stat-num ${d.cls}">${val}${d.suffix || ''}</div>
      <div class="stat-label"><span class="dot ${d.bg}"></span>${d.label}</div>
      ${pct ? `<div class="stat-pct">${pct}</div>` : ''}
    </div>`;
  }).join('');
}

function setFilter(filter, label) {
  activeFilter = filter;
  document.getElementById('filterInfo').textContent = filter === 'all' ? 'Showing all' : `Filtered: ${label}`;
  // Re-render stats to show active card
  if (allRows.length) {
    const grid = document.getElementById('statsGrid');
    grid.querySelectorAll('.stat-card').forEach((c, i) => {
      c.classList.toggle('active', STAT_DEFS[i].filter === filter);
    });
  }
  applyFilters();
}

function applyFilters() {
  const search = (document.getElementById('searchBox').value || '').toLowerCase();
  let rows = allRows;

  // Category filter
  if (activeFilter !== 'all') {
    rows = rows.filter(r => {
      if (activeFilter === 'opened')    return r.formOpenedAt;
      if (activeFilter === 'no_change') return r.status === 'corrected' && r.hasChanges === false;
      if (activeFilter === 'modified')  return r.status === 'corrected' && r.hasChanges === true;
      if (activeFilter === 'declined')  return r.status === 'declined';
      if (activeFilter === 'optout')    return r.noFutureEmail;
      if (activeFilter === 'pending')   return r.status === 'pending';
      return true;
    });
  }

  // Search filter
  if (search) {
    rows = rows.filter(r =>
      (r.email || '').toLowerCase().includes(search) ||
      (r.firstName || '').toLowerCase().includes(search) ||
      (r.lastName || '').toLowerCase().includes(search)
    );
  }

  renderTable(rows);
  document.getElementById('filterInfo').textContent =
    `${rows.length} record${rows.length !== 1 ? 's' : ''}${activeFilter !== 'all' ? ' (filtered)' : ''}${search ? ' ¬∑ search active' : ''}`;
}

function renderTable(rows) {
  if (!rows.length) {
    document.getElementById('tableWrap').innerHTML =
      '<div class="empty"><div class="empty-icon">üîç</div><p>No records match this filter.</p></div>';
    return;
  }

  const esc = s => (s || '‚Äî').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const fmtDate = s => s ? new Date(s).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit'}) : '‚Äî';

  const tbody = rows.map(r => {
    const statusBadge = r.status === 'corrected'
      ? (r.hasChanges ? '<span class="badge badge-modified">Modified</span>' : '<span class="badge badge-verified">Verified</span>')
      : r.status === 'declined'
        ? '<span class="badge badge-declined">Declined</span>'
        : '<span class="badge badge-pending">Pending</span>';

    const openedBadge = r.formOpenedAt
      ? `<span class="badge badge-yes">Yes (${r.formOpenedCount || 1}√ó)</span>`
      : '<span class="badge badge-no">No</span>';

    const unsubBadge = r.noFutureEmail
      ? '<span class="badge badge-optout">Unsubscribed</span>'
      : '';

    return `<tr>
      <td><strong>${esc(r.email)}</strong></td>
      <td>${esc(r.firstName)} ${esc(r.lastName)}</td>
      <td>Stage ${r.stage || '?'}</td>
      <td>${statusBadge} ${unsubBadge}</td>
      <td>${openedBadge}</td>
      <td style="color:var(--muted);font-size:.75rem">${fmtDate(r.sentAt)}</td>
      <td style="color:var(--muted);font-size:.75rem">${fmtDate(r.formOpenedAt)}</td>
      <td style="color:var(--muted);font-size:.75rem">${r.correctedOn || r.declinedOn || '‚Äî'}</td>
      <td style="color:var(--muted);font-size:.75rem">${esc(r.phone)}</td>
      <td style="color:var(--muted);font-size:.75rem">${esc(r.preferredEmail)}</td>
    </tr>`;
  }).join('');

  document.getElementById('tableWrap').innerHTML = `
    <table>
      <thead><tr>
        <th>Email</th><th>Name</th><th>Stage</th><th>Status</th>
        <th>Opened Form</th><th>Email Sent</th><th>Form Opened</th>
        <th>Action Date</th><th>Phone</th><th>Preferred Email</th>
      </tr></thead>
      <tbody>${tbody}</tbody>
    </table>`;
}

function showError(msg) {
  document.getElementById('statsGrid').innerHTML =
    `<div style="grid-column:1/-1;color:#dc2626;padding:20px;background:#fee2e2;border-radius:10px">‚ö†Ô∏è ${msg}</div>`;
}

// Auto-refresh
function startAutoRefresh() {
  clearInterval(refreshInterval);
  let countdown = 30;
  refreshInterval = setInterval(() => {
    countdown--;
    document.getElementById('autoLabel').textContent = `üîÑ Auto-refresh: ${countdown}s`;
    if (countdown <= 0) {
      countdown = 30;
      loadData();
    }
  }, 1000);
}

// Init
loadData();
startAutoRefresh();
</script>
</body>
</html>
