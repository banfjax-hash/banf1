<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Join BANF ‚Äî Bengali Association of North Florida</title>
<link rel="icon" href="https://ranadhir19.github.io/banf1/banf-logo.png">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
:root {
  --banf-red: #8B0000;
  --banf-bright: #DC143C;
  --banf-gold: #D4AF37;
  --banf-orange: #FF6B35;
}
body { font-family: 'Segoe UI', Arial, sans-serif; background: #fff9f9; }
.banner {
  background: linear-gradient(135deg, var(--banf-red) 0%, #4a0000 100%);
  color: #fff; padding: 2.5rem 1.5rem 1.5rem; text-align: center;
}
.banner h1 { font-size: 2rem; font-weight: 800; margin: 0; letter-spacing: 0.5px; }
.banner p { opacity: .85; margin: .4rem 0 0; font-size: 1rem; }
.step-bar { display:flex; justify-content: center; gap: 0; margin: 0; padding: 0; }
.step-bar .step {
  flex: 1; max-width: 130px; text-align: center; padding: 12px 6px 10px;
  background: #2a0000; color: rgba(255,255,255,.55); font-size: .75rem; font-weight: 600;
  border-bottom: 3px solid transparent; transition: all .2s;
}
.step-bar .step.active { color: #fff; border-bottom-color: var(--banf-gold); background: #3d0000; }
.step-bar .step.done { color: rgba(255,255,255,.7); border-bottom-color: #28a745; }
.step-bar .step .snum {
  display: inline-flex; align-items: center; justify-content: center;
  width: 24px; height: 24px; border-radius: 50%;
  background: rgba(255,255,255,.15); font-size: .8rem; margin-bottom: 4px;
}
.step-bar .step.active .snum { background: var(--banf-gold); color: #000; }
.step-bar .step.done .snum { background: #28a745; color: #fff; }
.wizard-wrap { max-width: 780px; margin: 2rem auto; padding: 0 1rem 3rem; }
.wizard-step { display: none; }
.wizard-step.active { display: block; }
.tier-card {
  border: 2px solid #e5e5e5; border-radius: 14px; padding: 1.25rem;
  cursor: pointer; transition: all .2s; background: #fff; position: relative;
  height: 100%;
}
.tier-card:hover { border-color: var(--banf-bright); box-shadow: 0 4px 16px rgba(139,0,0,.12); }
.tier-card.selected { border-color: var(--banf-red); box-shadow: 0 4px 18px rgba(139,0,0,.2); background: #fff5f5; }
.tier-card .badge-rec {
  position:absolute; top:-10px; right:14px;
  background: var(--banf-gold); color:#000; font-size:.7rem; font-weight:700;
  padding:3px 10px; border-radius:10px;
}
.tier-price { font-size: 2rem; font-weight: 700; line-height: 1; }
.tier-price small { font-size: 1rem; font-weight: 400; color: #888; }
.feature-list li { font-size: .85rem; margin-bottom: 3px; }
.ai-bubble {
  background: linear-gradient(120deg, #fff5f5, #fff9f2);
  border: 1px solid #ffd6d6; border-radius: 14px; padding: 1.25rem;
  margin: 1rem 0;
}
.ai-bubble .ai-icon { font-size:1.5rem; margin-right:.5rem; }
.ai-result { white-space: pre-wrap; font-size:.9rem; line-height:1.6; }
/* Zelle block */
.zelle-block {
  background: linear-gradient(120deg,#f0faf0,#e9f9e9);
  border:2px solid #28a745; border-radius:14px; padding:1.5rem; text-align:center;
}
.zelle-block .amount-badge {
  font-size: 2.5rem; font-weight: 800; color: var(--banf-red);
}
.code-badge {
  display:inline-block; background:#8B0000; color:#fff;
  font-size:1.1rem; font-weight:700; padding:.4rem 1.2rem; border-radius:8px;
  letter-spacing:1px; margin:.5rem 0;
}
.spinner-overlay {
  position:fixed; inset:0; background:rgba(255,255,255,.75);
  display:flex; align-items:center; justify-content:center; z-index:9999;
  display:none;
}
.alert-float {
  position:fixed; top:80px; left:50%; transform:translateX(-50%);
  min-width:320px; z-index:9999; display:none;
}
/* Zelle QR placeholder */
.zelle-qr-wrap {
  width:160px; height:160px; margin:0 auto 1rem;
  background:#f0fff0; border:2px dashed #28a745; border-radius:12px;
  display:flex; align-items:center; justify-content:center; color:#28a745; font-size:.8rem; text-align:center; padding:.5rem;
}
</style>
</head>
<body>

<!-- Loading overlay -->
<div class="spinner-overlay" id="spinnerOverlay">
  <div class="text-center">
    <div class="spinner-border text-danger" style="width:3rem;height:3rem"></div>
    <p class="mt-3 text-muted" id="spinnerMsg">Please wait‚Ä¶</p>
  </div>
</div>

<!-- Alert toast -->
<div class="alert alert-danger alert-float shadow" id="alertFloat" role="alert" style="display:none"></div>

<!-- Banner + step bar -->
<div class="banner">
  <h1><img src="https://ranadhir19.github.io/banf1/banf-logo.png" height="38" style="margin-right:10px;vertical-align:middle" onerror="this.style.display='none'">Join BANF</h1>
  <p>Become a member of the Bengali Association of North Florida</p>
  <div class="step-bar mt-3" id="stepBar">
    <div class="step active" data-s="1"><div class="snum">1</div><br>Choose Tier</div>
    <div class="step" data-s="2"><div class="snum">2</div><br>AI Advisor</div>
    <div class="step" data-s="3"><div class="snum">3</div><br>Your Info</div>
    <div class="step" data-s="4"><div class="snum">4</div><br>Payment</div>
    <div class="step" data-s="5"><div class="snum">5</div><br>Confirm</div>
  </div>
</div>

<div class="wizard-wrap">

  <!-- ‚ïê‚ïê STEP 1: CHOOSE TIER ‚ïê‚ïê -->
  <div class="wizard-step active" id="step1">
    <h4 class="fw-bold mb-1">Select Membership Tier</h4>
    <p class="text-muted mb-4">Choose the plan that fits your family. Not sure? Let the AI Advisor help.</p>
    <div class="row g-3" id="tierGrid">
      <div class="text-center py-5"><div class="spinner-border text-danger"></div></div>
    </div>
    <div class="d-flex justify-content-between mt-4">
      <button class="btn btn-outline-secondary" onclick="goToAdvisor()"><i class="bi bi-robot me-2"></i>AI Advisor</button>
      <button class="btn btn-danger px-4" id="btnStep1Next" onclick="nextStep(2)" disabled><i class="bi bi-arrow-right me-1"></i>Continue</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê STEP 2: AI ADVISOR ‚ïê‚ïê -->
  <div class="wizard-step" id="step2">
    <h4 class="fw-bold mb-1"><i class="bi bi-robot text-danger me-2"></i>AI Membership Advisor</h4>
    <p class="text-muted mb-3">Answer a few questions and our AI will recommend the best tier for your family.</p>
    <div class="card shadow-sm border-0 mb-3">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label fw-semibold">Adults in household</label>
            <select class="form-select" id="ai_adults">
              <option value="1">1</option>
              <option value="2" selected>2</option>
              <option value="3">3+</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">Children (under 18)</label>
            <select class="form-select" id="ai_children">
              <option value="0" selected>0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="5">4‚Äì5</option>
              <option value="99">6+</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">Household includes a senior (65+)?</label>
            <select class="form-select" id="ai_senior">
              <option value="false" selected>No</option>
              <option value="true">Yes</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">Are you a full-time student?</label>
            <select class="form-select" id="ai_student">
              <option value="false" selected>No</option>
              <option value="true">Yes</option>
            </select>
          </div>
          <div class="col-12">
            <label class="form-label fw-semibold">Interests (check all that apply)</label>
            <div class="row g-2">
              <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" value="Durga Puja" id="int1"><label class="form-check-label" for="int1">Durga Puja</label></div></div>
              <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" value="Cultural Events" id="int2" checked><label class="form-check-label" for="int2">Cultural Events</label></div></div>
              <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" value="Kids Programs" id="int3"><label class="form-check-label" for="int3">Kids Programs</label></div></div>
              <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" value="Networking" id="int4"><label class="form-check-label" for="int4">Networking</label></div></div>
              <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" value="Volunteering" id="int5"><label class="form-check-label" for="int5">Volunteering</label></div></div>
              <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" value="Magazine" id="int6"><label class="form-check-label" for="int6">BANF Magazine</label></div></div>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">Annual budget for membership</label>
            <select class="form-select" id="ai_budget">
              <option value="">No preference</option>
              <option value="30">Up to $30</option>
              <option value="60">Up to $60</option>
              <option value="100">Up to $100</option>
              <option value="150">Up to $150</option>
              <option value="250">Up to $250</option>
            </select>
          </div>
        </div>
        <button class="btn btn-danger mt-3 px-4" onclick="runAdvisor()"><i class="bi bi-magic me-2"></i>Get Recommendation</button>
      </div>
    </div>
    <div class="ai-bubble d-none" id="aiResult">
      <div><span class="ai-icon">ü§ñ</span><strong>AI Recommendation</strong></div>
      <div class="ai-result mt-2" id="aiResultText"></div>
      <div class="mt-2" id="aiSelectBtn"></div>
    </div>
    <div class="d-flex justify-content-between mt-4">
      <button class="btn btn-outline-secondary" onclick="nextStep(1)"><i class="bi bi-arrow-left me-1"></i>Back</button>
      <button class="btn btn-danger px-4" onclick="nextStep(3)"><i class="bi bi-arrow-right me-1"></i>Skip to Registration</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê STEP 3: REGISTRATION FORM ‚ïê‚ïê -->
  <div class="wizard-step" id="step3">
    <h4 class="fw-bold mb-1">Your Information</h4>
    <p class="text-muted mb-3">Please complete the registration form.</p>
    <div class="card shadow-sm border-0 mb-3">
      <div class="card-body">
        <!-- Tier reminder -->
        <div class="alert alert-warning py-2 mb-3 d-flex align-items-center gap-2" id="s3TierReminder">
          <i class="bi bi-info-circle-fill text-warning"></i>
          <span id="s3TierText">Membership tier: <strong></strong></span>
        </div>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label fw-semibold">First Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="r_firstName" required>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">Last Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="r_lastName" required>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">Email Address <span class="text-danger">*</span></label>
            <input type="email" class="form-control" id="r_email" required>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">Phone Number</label>
            <input type="tel" class="form-control" id="r_phone" placeholder="(xxx) xxx-xxxx">
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">Spouse / Partner Name</label>
            <input type="text" class="form-control" id="r_spouse" placeholder="If applicable">
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">City</label>
            <input type="text" class="form-control" id="r_city" placeholder="Jacksonville">
          </div>
          <div class="col-md-8">
            <label class="form-label fw-semibold">Address</label>
            <input type="text" class="form-control" id="r_address" placeholder="Street address (optional)">
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">ZIP Code</label>
            <input type="text" class="form-control" id="r_zip">
          </div>
          <div class="col-12">
            <label class="form-label fw-semibold">Children's Names (comma separated)</label>
            <input type="text" class="form-control" id="r_children" placeholder="e.g. Riya, Arjun">
            <div class="form-text">Include names of children who will be part of this membership</div>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">How did you hear about BANF?</label>
            <select class="form-select" id="r_referral">
              <option value="">Select‚Ä¶</option>
              <option>Friend / Family</option>
              <option>Social Media</option>
              <option>WhatsApp Group</option>
              <option>BANF Event</option>
              <option>Website</option>
              <option>Other</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    <div class="d-flex justify-content-between mt-4">
      <button class="btn btn-outline-secondary" onclick="nextStep(2)"><i class="bi bi-arrow-left me-1"></i>Back</button>
      <button class="btn btn-danger px-4" onclick="submitRegistration()"><i class="bi bi-check2-circle me-1"></i>Register</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê STEP 4: PAYMENT (ZELLE) ‚ïê‚ïê -->
  <div class="wizard-step" id="step4">
    <h4 class="fw-bold mb-1">Complete Payment via Zelle</h4>
    <p class="text-muted mb-3">Your registration is submitted. Please send your membership fee via Zelle to activate your membership.</p>
    <div class="zelle-block mb-4">
      <div class="amount-badge" id="z_amount">$100</div>
      <div class="text-muted mb-3">Membership fee for <strong id="z_tierName">Family</strong></div>
      <div class="zelle-qr-wrap" id="zelleQrWrap">
        <div><i class="bi bi-qr-code" style="font-size:2.5rem;display:block"></i><span>Zelle QR Code<br><small>(in Zelle app)</small></span></div>
      </div>
      <div class="mb-2"><strong>Zelle to:</strong> <code class="fs-5" id="z_recipient">banfjax@gmail.com</code></div>
      <div class="mb-3"><strong>Memo / Note:</strong> <span class="code-badge" id="z_memo">BANF Membership BANF-XXXXXXXX</span></div>
      <div class="alert alert-info d-inline-flex align-items-center gap-2 py-2 px-3 mt-1" style="border-radius:8px">
        <i class="bi bi-info-circle-fill"></i>
        Add the memo exactly as shown so we can match your payment
      </div>
    </div>
    <div class="card shadow-sm border-0 mb-3">
      <div class="card-body">
        <h6 class="fw-bold mb-2">How to send Zelle</h6>
        <ol class="mb-0" style="font-size:.9rem">
          <li>Open your bank app or Zelle app</li>
          <li>Send <strong id="z_amount2">$100</strong> to <strong>banfjax@gmail.com</strong> (BANF Jacksonville)</li>
          <li>In the <em>Memo</em> or <em>Note</em> field, enter: <strong><span id="z_memo2">BANF Membership BANF-XXXXXXXX</span></strong></li>
          <li>Submit the payment</li>
          <li>A BANF EC member will confirm your payment within 1-2 business days</li>
          <li>You'll receive a welcome email once your membership is activated</li>
        </ol>
      </div>
    </div>
    <div class="alert alert-success d-flex align-items-start gap-2">
      <i class="bi bi-envelope-check-fill mt-1"></i>
      <div>A confirmation email with your registration code and payment instructions has been sent to <strong id="z_email">your email</strong>.</div>
    </div>
    <div class="d-flex justify-content-end mt-3">
      <button class="btn btn-danger px-4" onclick="nextStep(5)"><i class="bi bi-check-circle me-1"></i>Done</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê STEP 5: CONFIRMATION ‚ïê‚ïê -->
  <div class="wizard-step" id="step5">
    <div class="text-center py-4">
      <div style="font-size:4rem">üéâ</div>
      <h3 class="fw-bold mt-2" style="color:var(--banf-red)">Welcome to BANF!</h3>
      <p class="text-muted mb-4">Your registration is complete. Payment confirmation pending.</p>
      <div class="card shadow-sm border-0 mx-auto" style="max-width:420px">
        <div class="card-body">
          <div class="mb-2 text-muted small">Your Registration Code</div>
          <div class="code-badge fs-4" id="conf_code">BANF-XXXXXXXX</div>
          <div class="mt-3 text-muted small">Tier: <strong id="conf_tier">Family</strong> &nbsp;|&nbsp; Amount: <strong id="conf_amount">$100</strong></div>
          <hr>
          <p class="small mb-0"><i class="bi bi-envelope me-1 text-danger"></i>Confirmation sent to <strong id="conf_email"></strong></p>
        </div>
      </div>
      <div class="mt-4">
        <a href="member-portal.html" class="btn btn-danger me-2"><i class="bi bi-person-circle me-1"></i>Member Portal</a>
        <a href="index.html" class="btn btn-outline-secondary"><i class="bi bi-house me-1"></i>BANF Home</a>
      </div>
      <div class="mt-4 text-muted small">
        Questions? Email <a href="mailto:banfjax@gmail.com">banfjax@gmail.com</a>
      </div>
    </div>
  </div>

</div><!-- wizard-wrap -->

<!-- Check existing registration modal -->
<div class="modal fade" id="existingModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0"><h5 class="modal-title fw-bold">Registration Found</h5></div>
      <div class="modal-body" id="existingModalBody"></div>
      <div class="modal-footer border-0">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-danger" onclick="goToPaymentExisting()">View Payment Info</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API = 'https://banfwix.wixsite.com/banf1/_functions';
let tiers = [];
let selectedTier = null;
let registrationData = null;

// ‚îÄ‚îÄ Utilities ‚îÄ‚îÄ
function showSpinner(msg='Loading‚Ä¶') {
  document.getElementById('spinnerMsg').textContent = msg;
  document.getElementById('spinnerOverlay').style.display = 'flex';
}
function hideSpinner() { document.getElementById('spinnerOverlay').style.display = 'none'; }
function showAlert(msg, type='danger') {
  const el = document.getElementById('alertFloat');
  el.className = `alert alert-${type} alert-float shadow`;
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(()=>{ el.style.display='none'; }, 4500);
}

// ‚îÄ‚îÄ Step navigation ‚îÄ‚îÄ
let currentStep = 1;
function goToStep(n) {
  document.querySelectorAll('.wizard-step').forEach((s,i)=>{ s.classList.toggle('active', i===n-1); });
  document.querySelectorAll('.step-bar .step').forEach(s=>{
    const sn = +s.dataset.s;
    s.classList.toggle('active', sn===n);
    s.classList.toggle('done', sn<n);
  });
  currentStep = n;
  window.scrollTo({top:0, behavior:'smooth'});
}
function nextStep(n) { goToStep(n); }

// ‚îÄ‚îÄ STEP 1: Load tiers ‚îÄ‚îÄ
async function loadTiers() {
  try {
    showSpinner('Loading membership plans‚Ä¶');
    const res = await fetch(`${API}/membership_tiers`);
    const data = await res.json();
    if (!data.success) throw new Error(data.error);
    tiers = data.tiers;
    renderTiers();
  } catch(e) {
    document.getElementById('tierGrid').innerHTML = `<div class="col-12"><div class="alert alert-danger">Failed to load tiers: ${e.message}</div></div>`;
  } finally { hideSpinner(); }
}

function renderTiers() {
  const grid = document.getElementById('tierGrid');
  grid.innerHTML = tiers.map(t => `
    <div class="col-sm-6 col-lg-4">
      <div class="tier-card${t.recommended?' border-danger':''}" onclick="selectTier('${t.id}')" id="tc-${t.id}">
        ${t.recommended ? '<div class="badge-rec">‚≠ê Popular</div>' : ''}
        <div class="d-flex align-items-center gap-2 mb-2">
          <i class="bi bi-${t.icon}" style="font-size:1.4rem;color:${t.color}"></i>
          <strong style="font-size:1rem">${t.name}</strong>
        </div>
        <div class="tier-price" style="color:${t.color}">$${t.price}<small>/yr</small></div>
        <div class="text-muted small mb-2">${t.tagline}</div>
        <div class="text-muted small mb-2">
          <i class="bi bi-people me-1"></i>${t.adults} adult${t.adults>1?'s':''}${t.children>0?(', up to '+t.children+' children'):''}${t.children===-1?', unlimited children':''}
        </div>
        <ul class="feature-list ps-3 mb-0">
          ${t.features.slice(0,4).map(f=>`<li>${f}</li>`).join('')}
          ${t.features.length>4?`<li class="text-muted">+${t.features.length-4} more‚Ä¶</li>`:''}
        </ul>
      </div>
    </div>`).join('');
}

function selectTier(id) {
  selectedTier = tiers.find(t=>t.id===id);
  document.querySelectorAll('.tier-card').forEach(c=>c.classList.remove('selected'));
  document.getElementById('tc-'+id)?.classList.add('selected');
  document.getElementById('btnStep1Next').disabled = false;
  // Update step 3 reminder
  document.querySelector('#s3TierText strong').textContent = `${selectedTier.name} ‚Äî $${selectedTier.price}/yr`;
}

function goToAdvisor() { goToStep(2); }

// ‚îÄ‚îÄ STEP 2: AI Advisor ‚îÄ‚îÄ
async function runAdvisor() {
  const interests = [...document.querySelectorAll('[id^=int]:checked')].map(c=>c.value);
  const budget = document.getElementById('ai_budget').value;
  const body = {
    adults: +document.getElementById('ai_adults').value,
    children: +document.getElementById('ai_children').value,
    isSenior: document.getElementById('ai_senior').value==='true',
    isStudent: document.getElementById('ai_student').value==='true',
    interests, budget: budget?+budget:null
  };
  try {
    showSpinner('Getting AI recommendation‚Ä¶');
    const res = await fetch(`${API}/membership_recommend`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
    });
    const data = await res.json();
    if (!data.success) throw new Error(data.error);
    document.getElementById('aiResultText').textContent = data.recommendation || '';
    if (data.tier) {
      document.getElementById('aiSelectBtn').innerHTML = `
        <button class="btn btn-sm btn-danger" onclick="selectTierFromAdvisor('${data.recommendedTierId}')">
          <i class="bi bi-check-circle me-1"></i>Select ${data.tier.name} ($${data.tier.price}/yr)
        </button>`;
    }
    document.getElementById('aiResult').classList.remove('d-none');
  } catch(e) { showAlert('Advisor error: '+e.message); }
  finally { hideSpinner(); }
}

function selectTierFromAdvisor(id) {
  selectTier(id);
  goToStep(3);
}

// ‚îÄ‚îÄ STEP 3: Register ‚îÄ‚îÄ
function validateForm() {
  const fields = ['r_firstName','r_lastName','r_email'];
  let valid = true;
  for (const f of fields) {
    const el = document.getElementById(f);
    if (!el.value.trim()) { el.classList.add('is-invalid'); valid=false; } else el.classList.remove('is-invalid');
  }
  if (!selectedTier) { showAlert('Please select a membership tier first.'); valid=false; }
  return valid;
}

async function submitRegistration() {
  if (!validateForm()) return;
  const childNames = document.getElementById('r_children').value.split(',').map(s=>s.trim()).filter(Boolean);
  const body = {
    firstName: document.getElementById('r_firstName').value.trim(),
    lastName: document.getElementById('r_lastName').value.trim(),
    email: document.getElementById('r_email').value.trim().toLowerCase(),
    phone: document.getElementById('r_phone').value.trim(),
    spouseName: document.getElementById('r_spouse').value.trim(),
    city: document.getElementById('r_city').value.trim(),
    address: document.getElementById('r_address').value.trim(),
    zip: document.getElementById('r_zip').value.trim(),
    tierId: selectedTier.id,
    adultCount: selectedTier.adults,
    childCount: childNames.length,
    childNames,
    referralSource: document.getElementById('r_referral').value
  };
  try {
    showSpinner('Submitting registration‚Ä¶');
    const res = await fetch(`${API}/membership_register`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
    });
    const data = await res.json();
    if (!data.success && !data.alreadyRegistered) throw new Error(data.error);

    const code = data.registrationCode;
    const tier = data.tier || selectedTier;
    const amount = data.amount || selectedTier.price;
    const memo = `BANF Membership ${code}`;
    registrationData = { ...body, code, tier, amount, memo };

    if (data.alreadyRegistered) {
      // Show modal
      document.getElementById('existingModalBody').innerHTML = `
        <p>You are already registered for 2025-26 membership.</p>
        <p><strong>Code:</strong> <span class="code-badge">${code}</span></p>
        <p><strong>Status:</strong> ${data.status}</p>`;
      new bootstrap.Modal(document.getElementById('existingModal')).show();
      return;
    }

    // Populate Zelle step
    document.getElementById('z_amount').textContent = `$${amount}`;
    document.getElementById('z_amount2').textContent = `$${amount}`;
    document.getElementById('z_tierName').textContent = tier.name;
    document.getElementById('z_recipient').textContent = data.zelleRecipient || 'banfjax@gmail.com';
    document.getElementById('z_memo').textContent = memo;
    document.getElementById('z_memo2').textContent = memo;
    document.getElementById('z_email').textContent = body.email;
    // Confirmation step
    document.getElementById('conf_code').textContent = code;
    document.getElementById('conf_tier').textContent = tier.name;
    document.getElementById('conf_amount').textContent = `$${amount}`;
    document.getElementById('conf_email').textContent = body.email;

    goToStep(4);
  } catch(e) { showAlert('Registration failed: '+e.message); }
  finally { hideSpinner(); }
}

function goToPaymentExisting() {
  bootstrap.Modal.getInstance(document.getElementById('existingModal'))?.hide();
  if (registrationData) {
    const { code, tier, amount } = registrationData;
    const memo = `BANF Membership ${code}`;
    document.getElementById('z_amount').textContent = `$${amount}`;
    document.getElementById('z_amount2').textContent = `$${amount}`;
    document.getElementById('z_tierName').textContent = tier?.name || 'Membership';
    document.getElementById('z_memo').textContent = memo;
    document.getElementById('z_memo2').textContent = memo;
    document.getElementById('z_email').textContent = registrationData.email || '';
    document.getElementById('conf_code').textContent = code;
    document.getElementById('conf_tier').textContent = tier?.name || '';
    document.getElementById('conf_amount').textContent = `$${amount}`;
    document.getElementById('conf_email').textContent = registrationData.email || '';
  }
  goToStep(4);
}

// ‚îÄ‚îÄ Check status form ‚îÄ‚îÄ
async function checkStatus() {
  const code = document.getElementById('statusCode')?.value?.trim();
  if (!code) return;
  try {
    showSpinner('Checking status‚Ä¶');
    const res = await fetch(`${API}/membership_status?code=${encodeURIComponent(code)}`);
    const data = await res.json();
    if (!data.success) throw new Error(data.error);
    const reg = data.registration;
    showAlert(`Status: ${reg.status} | ${reg.firstName} ${reg.lastName} | ${reg.tier}`, 'success');
  } catch(e) { showAlert('Not found: ' + e.message); }
  finally { hideSpinner(); }
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
loadTiers();
</script>
</body>
</html>
