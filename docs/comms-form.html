<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="robots" content="noindex,nofollow">
<title>BANF — Verify Your Details</title>
<style>
  :root {
    --red: #8B0000; --crimson: #DC143C; --gold: #D4AF37;
    --bg: #f5f7fa; --card: #fff; --border: #e0e0e0;
    --text: #2D2D2D; --muted: #666;
  }
  * { box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif; }
  body { background: var(--bg); margin: 0; padding: 20px 16px 60px; color: var(--text); }
  .card { background: var(--card); border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,.08); max-width: 680px; margin: 0 auto; overflow: hidden; }
  .header { background: linear-gradient(135deg, var(--red), var(--crimson)); color: #fff; padding: 28px 32px; text-align: center; }
  .header h1 { margin: 0; font-size: 1.4rem; font-weight: 700; }
  .header p { margin: 6px 0 0; opacity: .85; font-size: .9rem; }
  .body { padding: 28px 32px; }
  .notice { background: #fff8e1; border-left: 4px solid var(--gold); border-radius: 0 8px 8px 0; padding: 12px 16px; margin: 0 0 24px; font-size: .9rem; color: #7B5800; line-height: 1.6; }
  .section-title { font-size: 1rem; font-weight: 700; color: var(--red); margin: 24px 0 12px; display: flex; align-items: center; gap: 8px; }
  .section-title::after { content: ''; flex: 1; height: 1px; background: #eee; }
  .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  @media(max-width:500px){ .row2 { grid-template-columns: 1fr; } }
  label { display: block; font-size: .88rem; font-weight: 600; margin-bottom: 5px; color: var(--text); }
  input[type=text], input[type=email], input[type=tel], input[type=number], input[type=date], select {
    width: 100%; padding: 10px 14px; border: 2px solid var(--border); border-radius: 10px;
    font-size: .95rem; transition: border .2s; }
  input:focus, select:focus { outline: none; border-color: var(--crimson); box-shadow: 0 0 0 3px rgba(220,20,60,.12); }
  .mb { margin-bottom: 16px; }
  .opt-row { display: flex; align-items: center; gap: 12px; background: #f8f8ff; border-radius: 10px; padding: 14px; border: 2px solid var(--border); }
  .opt-row input[type=checkbox] { width: 20px; height: 20px; accent-color: var(--crimson); cursor: pointer; flex-shrink: 0; }
  .dyn-row { display: flex; gap: 8px; align-items: flex-end; margin-bottom: 10px; }
  .dyn-row > * { flex: 1; }
  .btn-remove { flex: 0 0 36px; height: 38px; background: #ffeaea; border: 1px solid #ffb3b3; border-radius: 8px; cursor: pointer; color: #c00; font-size: 1.1rem; }
  .btn-add { display: inline-flex; align-items: center; gap: 6px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 8px; padding: 8px 14px; font-size: .87rem; cursor: pointer; transition: background .2s; color: var(--text); margin-top: 4px; }
  .btn-add:hover { background: #e4e4e4; }
  .actions { display: flex; gap: 12px; margin-top: 28px; flex-wrap: wrap; }
  .btn-save { flex: 2; min-width: 160px; padding: 14px 20px; background: linear-gradient(135deg,var(--red),var(--crimson)); color: #fff; border: none; border-radius: 30px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: opacity .2s; }
  .btn-save:hover { opacity: .9; }
  .btn-save:disabled { opacity: .5; cursor: not-allowed; }
  .btn-decline { flex: 1; min-width: 120px; padding: 14px 20px; background: #f0f0f0; color: var(--muted); border: 1px solid #ccc; border-radius: 30px; font-size: .95rem; cursor: pointer; transition: background .2s; }
  .btn-decline:hover { background: #e4e4e4; }
  .result { text-align: center; padding: 40px 32px; display: none; }
  .result.show { display: block; }
  .result .icon { font-size: 3.5rem; margin-bottom: 16px; }
  .result h2 { margin: 0 0 12px; color: var(--text); }
  .result p { color: var(--muted); line-height: 1.7; }
  .spinner { display: none; justify-content: center; margin: 8px 0 0; }
  .spinner.show { display: flex; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .spin-circle { width: 22px; height: 22px; border: 3px solid #eee; border-top-color: var(--crimson); border-radius: 50%; animation: spin .7s linear infinite; }
  #loadingOverlay { display:flex; align-items:center; justify-content:center; min-height:60vh; text-align:center; color:#555; }
  #loadingOverlay .ld-spinner { width:48px; height:48px; border:5px solid #e0e0e0; border-top-color:#8B0000; border-radius:50%; animation:spin .8s linear infinite; margin:0 auto 20px; }
  .err-msg { color:#c0392b; max-width:420px; line-height:1.6; padding:0 20px; margin:0 auto; text-align:center; }
</style>
</head>
<body>

<!-- LOADING STATE -->
<div id="loadingOverlay">
  <div>
    <div class="ld-spinner"></div>
    <p>Loading your BANF details form…</p>
  </div>
</div>

<!-- MAIN CARD (hidden until data loads) -->
<div class="card" id="mainCard" style="display:none">
  <div class="header">
    <h1>Bengali Association of North Florida</h1>
    <p>Communication Details Verification</p>
  </div>

  <!-- FORM -->
  <div id="mainForm" class="body">
    <div class="notice">
      Please review your details below. You can update any information or simply confirm it as-is.
      All fields are optional — only correct what needs updating. You may also choose to decline this request.
    </div>

    <div class="section-title"><span>&#128100; Your Name</span></div>
    <div class="row2 mb">
      <div>
        <label for="firstName">First Name</label>
        <input type="text" id="firstName" value="" placeholder="First name">
      </div>
      <div>
        <label for="lastName">Last Name</label>
        <input type="text" id="lastName" value="" placeholder="Last name">
      </div>
    </div>

    <div class="section-title"><span>&#128222; Contact Details</span></div>
    <div class="row2 mb">
      <div>
        <label for="phone">Phone Number</label>
        <input type="tel" id="phone" value="" placeholder="e.g. 904-555-0100">
      </div>
      <div>
        <label for="preferredEmail">Preferred Email for BANF</label>
        <input type="email" id="preferredEmail" value="" placeholder="your@email.com">
      </div>
    </div>

    <div class="section-title"><span>&#128231; Email Communication Preferences</span></div>
    <p style="font-size:.88rem;color:var(--muted);margin:0 0 14px;line-height:1.6">
      Please choose your email communication preference. This applies to <strong>all future BANF emails</strong>
      including event invitations, cultural programs, sports days, religious observances, community updates,
      education programs, and general announcements.
    </p>
    <div class="opt-row mb" id="optInRow" style="border-color:#22c55e;background:#f0fdf4;cursor:pointer">
      <input type="radio" name="emailPref" id="optIn" value="in" checked style="width:18px;height:18px;accent-color:#16a34a;flex-shrink:0;cursor:pointer">
      <label for="optIn" style="cursor:pointer">
        <strong style="color:#15803d">&#10003;&nbsp; Yes, I want to receive BANF emails</strong>
        <span style="color:#555;font-size:.85rem;display:block;margin-top:3px;line-height:1.5">
          I am happy to receive invitations and updates about BANF events: sports days, cultural festivals,
          religious celebrations, social gatherings, community initiatives, educational programs, and general announcements.
        </span>
      </label>
    </div>
    <div class="opt-row mb" id="optOutRow" style="border-color:#ef4444;background:#fff5f5;cursor:pointer">
      <input type="radio" name="emailPref" id="optOut" value="out" style="width:18px;height:18px;accent-color:#dc2626;flex-shrink:0;cursor:pointer">
      <label for="optOut" style="cursor:pointer">
        <strong style="color:#dc2626">&#128683;&nbsp; No, please stop all BANF email communications</strong>
        <span style="color:#666;font-size:.85rem;display:block;margin-top:3px;line-height:1.5">
          I do not wish to receive any future emails from BANF. My record will be flagged immediately
          and no further communications of any kind will be sent to this email address.
          You can change this decision at any time by contacting <strong>banfjax@gmail.com</strong>.
        </span>
      </label>
    </div>
    <p style="font-size:.78rem;color:#888;margin:-4px 0 0;line-height:1.6">
      &#128274; Your preference is stored securely. BANF does not share your contact details with any third party.
    </p>

    <div class="section-title"><span>&#127968; Other Adults in Household</span></div>
    <p style="font-size:.88rem;color:var(--muted);margin:0 0 12px;line-height:1.6">
      Please list all other adults currently in your household and their relationship to you.
    </p>
    <div id="adultsContainer"></div>
    <button type="button" id="btnAddAdult" class="btn-add">&#65291; Add adult</button>

    <div class="section-title" style="margin-top:28px"><span>&#128118; Children in Household</span></div>
    <p style="font-size:.88rem;color:var(--muted);margin:0 0 12px;line-height:1.6">
      Please list children's full names and ages.
    </p>
    <div id="kidsContainer"></div>
    <button type="button" id="btnAddKid" class="btn-add">&#65291; Add child</button>

    <div class="actions">
      <button class="btn-save" id="btnSave">&#10004; Confirm &amp; Save</button>
      <button class="btn-decline" id="btnDecline">Skip / Decline to modify</button>
    </div>
    <div class="spinner" id="spinner"><div class="spin-circle"></div></div>
    <p id="errMsg" style="color:#c00;font-size:.88rem;margin-top:8px;display:none"></p>
  </div>

  <!-- SUCCESS SCREEN -->
  <div id="successScreen" class="result">
    <div class="icon" id="successIcon">&#10003;</div>
    <h2 id="successTitle">Details Saved!</h2>
    <p id="successMsg">Thank you for taking the time to verify your information.<br>
       BANF will use these details for all future communications.</p>
    <p style="font-size:.85rem;color:#aaa;margin-top:20px">You may close this window.</p>
  </div>

  <!-- DECLINED SCREEN -->
  <div id="declineScreen" class="result">
    <div class="icon">&#128591;</div>
    <h2>No problem!</h2>
    <p>We have recorded that you declined to modify your details at this time.<br>
       Our existing records for you remain unchanged.</p>
    <p style="font-size:.85rem;color:#aaa;margin-top:20px">You may close this window.</p>
  </div>

  <!-- ALREADY-DONE / ERROR SCREEN -->
  <div id="doneScreen" class="result">
    <div class="icon">&#9989;</div>
    <h2 id="doneTitle"></h2>
    <p id="doneMsg"></p>
    <p style="font-size:.85rem;color:#aaa;margin-top:20px">You may close this window.</p>
  </div>
</div>

<script>
(function () {
  var BASE  = 'https://banfwix.wixsite.com/banf1/_functions';
  var TOKEN = new URLSearchParams(window.location.search).get('token') || '';

  if (!TOKEN) { window.location.replace('https://banfwix.wixsite.com/banf1'); return; }

  // ── Load data from Wix JSON endpoint ─────────────────────
  fetch(BASE + '/comms_form_data?token=' + encodeURIComponent(TOKEN))
    .then(function (r) { return r.json(); })
    .then(function (data) {
      document.getElementById('loadingOverlay').style.display = 'none';
      document.getElementById('mainCard').style.display = '';

      if (!data.success) {
        document.getElementById('mainForm').style.display = 'none';
        document.getElementById('doneScreen').classList.add('show');
        document.getElementById('doneTitle').textContent = 'Error';
        document.getElementById('doneMsg').textContent = data.error || 'Something went wrong.';
        return;
      }
      if (data.screen === 'done') {
        document.getElementById('mainForm').style.display = 'none';
        document.getElementById('doneScreen').classList.add('show');
        document.getElementById('doneTitle').textContent = data.title;
        document.getElementById('doneMsg').textContent = data.msg;
        return;
      }

      // Populate form fields
      var m = data.member || {};
      document.getElementById('firstName').value      = m.firstName || '';
      document.getElementById('lastName').value       = m.lastName || '';
      document.getElementById('phone').value          = m.phone || '';
      document.getElementById('preferredEmail').value = m.email || '';
      if (m.emailOptIn === false) {
        document.getElementById('optOut').checked = true;
        selectOptIn(false);
      }

      var adults = data.adults || [];
      for (var i = 0; i < adults.length; i++) addAdult(adults[i]);
      var kids = data.kids || [];
      for (var j = 0; j < kids.length; j++) addKid(kids[j]);
    })
    .catch(function (err) {
      document.getElementById('loadingOverlay').innerHTML =
        '<p class="err-msg">Could not load the form. Please try again or contact <a href="mailto:banfjax@gmail.com">banfjax@gmail.com</a>. (' + err.message + ')</p>';
    });

  // ── Adult rows ─────────────────────────────────────────────
  var adultCount = 0;
  function addAdult(data) {
    data = data || {};
    var i    = adultCount++;
    var id   = 'adult_' + i;
    var name = data.name || '';
    var mid  = data.memberId || '';
    var rel  = data.relationship || 'Spouse/Partner';
    var rels = ['Spouse/Partner','Parent','Sibling','Friend','Other'];
    var opts = '';
    for (var r = 0; r < rels.length; r++) {
      opts += '<option' + (rels[r] === rel ? ' selected' : '') + '>' + rels[r] + '</option>';
    }
    var html = '<div class="dyn-row" id="' + id + '">'
      + '<input type="hidden" data-field="memberid" value="' + mid + '">'
      + '<div><label style="font-size:.82rem">Full name</label>'
      + '<input type="text" placeholder="Full name" value="' + escAttr(name) + '" data-field="name"></div>'
      + '<div style="flex:0 0 160px"><label style="font-size:.82rem">Relationship</label>'
      + '<select data-field="rel">' + opts + '</select></div>'
      + '<button type="button" class="btn-remove" data-remove="' + id + '" title="Remove">&#10005;</button></div>';
    document.getElementById('adultsContainer').insertAdjacentHTML('beforeend', html);
  }

  // ── Kid rows ───────────────────────────────────────────────
  var kidCount = 0;
  function addKid(data) {
    data = data || {};
    var i    = kidCount++;
    var id   = 'kid_' + i;
    var name = data.name || '';
    var mid  = data.memberId || '';
    var age  = data.age != null ? String(data.age) : '';
    var html = '<div class="dyn-row" id="' + id + '">'
      + '<input type="hidden" data-field="memberid" value="' + mid + '">'
      + '<div><label style="font-size:.82rem">Child\'s full name</label>'
      + '<input type="text" placeholder="Full name" value="' + escAttr(name) + '" data-field="name"></div>'
      + '<div style="flex:0 0 100px"><label style="font-size:.82rem">Age (years)</label>'
      + '<input type="number" min="0" max="20" placeholder="Age" value="' + age + '" data-field="age"></div>'
      + '<button type="button" class="btn-remove" data-remove="' + id + '" title="Remove">&#10005;</button></div>';
    document.getElementById('kidsContainer').insertAdjacentHTML('beforeend', html);
  }

  function escAttr(s) { return (s || '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // ── Email opt-in toggle ────────────────────────────────────
  function selectOptIn(val) {
    document.getElementById(val ? 'optIn' : 'optOut').checked = true;
    document.getElementById('optInRow').style.borderColor  = val ? '#22c55e' : '#e5e7eb';
    document.getElementById('optInRow').style.background   = val ? '#f0fdf4' : '#f9f9f9';
    document.getElementById('optOutRow').style.borderColor = val ? '#e5e7eb' : '#ef4444';
    document.getElementById('optOutRow').style.background  = val ? '#f9f9f9' : '#fff5f5';
  }

  // ── Collect form data ──────────────────────────────────────
  function collectAdults() {
    var rows = document.querySelectorAll('#adultsContainer .dyn-row');
    var result = [];
    for (var i = 0; i < rows.length; i++) {
      var row = rows[i];
      var n = row.querySelector('[data-field="name"]').value.trim();
      if (!n) continue;
      result.push({
        memberId:     (row.querySelector('[data-field="memberid"]') || {}).value || '',
        name:         n,
        relationship: row.querySelector('[data-field="rel"]').value
      });
    }
    return result;
  }
  function collectKids() {
    var rows = document.querySelectorAll('#kidsContainer .dyn-row');
    var result = [];
    for (var i = 0; i < rows.length; i++) {
      var row = rows[i];
      var n = row.querySelector('[data-field="name"]').value.trim();
      if (!n) continue;
      result.push({
        memberId: (row.querySelector('[data-field="memberid"]') || {}).value || '',
        name:     n,
        age:      parseInt(row.querySelector('[data-field="age"]').value) || null
      });
    }
    return result;
  }

  // ── Submit ─────────────────────────────────────────────────
  function submitForm() {
    var btn = document.getElementById('btnSave');
    var sp  = document.getElementById('spinner');
    var err = document.getElementById('errMsg');
    err.style.display = 'none';
    btn.disabled = true;
    sp.classList.add('show');

    var payload = {
      token:          TOKEN,
      firstName:      document.getElementById('firstName').value.trim(),
      lastName:       document.getElementById('lastName').value.trim(),
      phone:          document.getElementById('phone').value.trim(),
      preferredEmail: document.getElementById('preferredEmail').value.trim(),
      emailOptIn:     document.getElementById('optIn').checked,
      noFutureEmail:  document.getElementById('optOut').checked,
      otherAdults:    collectAdults(),
      kids:           collectKids()
    };

    fetch(BASE + '/comms_correction_submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(function (r) { return r.json(); })
    .then(function (data) {
      if (data.success) {
        document.getElementById('mainForm').style.display = 'none';
        if (payload.noFutureEmail) {
          document.getElementById('successIcon').textContent = '\u2709\ufe0f';
          document.getElementById('successTitle').textContent = 'Unsubscribed Successfully';
          document.getElementById('successMsg').innerHTML =
            'You have been removed from all future BANF email communications.<br>' +
            'Your preference has been saved immediately. We respect your decision.<br>' +
            '<span style="font-size:.85rem;color:#888">To re-subscribe in the future, please contact us at <strong>banfjax@gmail.com</strong>.</span>';
        } else {
          document.getElementById('successIcon').textContent = '\u2705';
          document.getElementById('successTitle').textContent = 'Details Saved!';
          document.getElementById('successMsg').innerHTML =
            'Thank you for taking the time to verify your information.<br>' +
            'BANF will use these updated details for all future communications.';
        }
        document.getElementById('successScreen').classList.add('show');
      } else {
        err.textContent = data.error || 'An error occurred. Please try again.';
        err.style.display = 'block';
        btn.disabled = false;
        sp.classList.remove('show');
      }
    })
    .catch(function () {
      err.textContent = 'Network error. Please check your connection and try again.';
      err.style.display = 'block';
      btn.disabled = false;
      sp.classList.remove('show');
    });
  }

  // ── Decline ────────────────────────────────────────────────
  function declineForm() {
    if (!confirm('Are you sure you want to skip this update? No changes will be made to your record.')) return;
    document.getElementById('btnDecline').disabled = true;
    fetch(BASE + '/comms_correction_decline', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token: TOKEN })
    })
    .then(function () {
      document.getElementById('mainForm').style.display = 'none';
      document.getElementById('declineScreen').classList.add('show');
    })
    .catch(function () {
      document.getElementById('mainForm').style.display = 'none';
      document.getElementById('declineScreen').classList.add('show');
    });
  }

  // ── Wire up all events ─────────────────────────────────────
  document.getElementById('btnAddAdult').addEventListener('click', function () { addAdult(); });
  document.getElementById('btnAddKid').addEventListener('click', function () { addKid(); });
  document.getElementById('btnSave').addEventListener('click', function () { submitForm(); });
  document.getElementById('btnDecline').addEventListener('click', function () { declineForm(); });
  document.getElementById('optInRow').addEventListener('click', function () { selectOptIn(true); });
  document.getElementById('optOutRow').addEventListener('click', function () { selectOptIn(false); });

  // Event delegation for remove buttons
  document.getElementById('adultsContainer').addEventListener('click', function (e) {
    var t = e.target;
    while (t && t !== this) {
      if (t.getAttribute && t.getAttribute('data-remove')) {
        var el = document.getElementById(t.getAttribute('data-remove'));
        if (el) el.parentNode.removeChild(el);
        return;
      }
      t = t.parentNode;
    }
  });
  document.getElementById('kidsContainer').addEventListener('click', function (e) {
    var t = e.target;
    while (t && t !== this) {
      if (t.getAttribute && t.getAttribute('data-remove')) {
        var el = document.getElementById(t.getAttribute('data-remove'));
        if (el) el.parentNode.removeChild(el);
        return;
      }
      t = t.parentNode;
    }
  });

})();
</script>
</body>
</html>
