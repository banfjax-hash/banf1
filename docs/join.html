<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Join BANF FY2026-27 Membership</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
:root{ --red:#8B0000;--bright:#DC143C;--gold:#D4AF37;--orange:#FF6B35; }
body{font-family:'Segoe UI',Arial,sans-serif;background:#fff9f9}
.banner{background:linear-gradient(135deg,var(--red) 0%,#3d0000 100%);color:#fff;padding:2rem 1rem 0;text-align:center}
.banner h1{font-size:1.9rem;font-weight:800;margin:0}
.banner p{opacity:.85;margin:.3rem 0 0;font-size:.95rem}
.step-bar{display:flex;justify-content:center;margin:0;padding:0}
.step-bar .step{flex:1;max-width:120px;text-align:center;padding:11px 4px 9px;background:#2a0000;color:rgba(255,255,255,.5);font-size:.72rem;font-weight:600;border-bottom:3px solid transparent;transition:all .2s}
.step-bar .step.active{color:#fff;border-bottom-color:var(--gold);background:#3d0000}
.step-bar .step.done{color:rgba(255,255,255,.65);border-bottom-color:#28a745}
.step-bar .step .snum{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:rgba(255,255,255,.15);font-size:.78rem;margin-bottom:3px}
.step-bar .step.active .snum{background:var(--gold);color:#000}
.step-bar .step.done .snum{background:#28a745;color:#fff}
.wizard-wrap{max-width:860px;margin:1.5rem auto;padding:0 1rem 4rem}
.wizard-step{display:none}
.wizard-step.active{display:block}
/* Tier cards */
.cat-card{border:2px solid #e5e5e5;border-radius:14px;padding:1rem;cursor:pointer;transition:all .2s;background:#fff;position:relative;height:100%}
.cat-card:hover{border-color:var(--bright);box-shadow:0 4px 16px rgba(139,0,0,.12)}
.cat-card.selected{border-color:var(--red);box-shadow:0 4px 20px rgba(139,0,0,.2);background:#fff5f5}
.cat-card .badge-highlight{position:absolute;top:-10px;right:12px;font-size:.65rem;font-weight:700;padding:3px 9px;border-radius:10px}
.cat-price{font-size:1.7rem;font-weight:800;line-height:1}
/* Pricing table */
.price-table th{background:var(--red);color:#fff;font-size:.8rem;padding:6px 10px}
.price-table td{padding:6px 10px;font-size:.9rem}
.price-table tr:hover td{background:#fff0f0}
.price-table tr.selected-row td{background:#ffe0e0;font-weight:700}
/* Event matrix */
.ev-incl{color:#28a745;font-weight:700}
.ev-addon{color:#FF6B35;font-weight:600}
.ev-na{color:#ccc}
/* Zelle */
.zelle-block{background:linear-gradient(120deg,#f0faf0,#e9f9e9);border:2px solid #28a745;border-radius:14px;padding:1.5rem;text-align:center}
.amount-badge{font-size:2.4rem;font-weight:800;color:var(--red)}
.code-badge{display:inline-block;background:var(--red);color:#fff;font-size:1.1rem;font-weight:700;padding:.35rem 1.1rem;border-radius:8px;letter-spacing:1px;margin:.5rem 0}
.spinner-overlay{position:fixed;inset:0;background:rgba(255,255,255,.8);display:flex;align-items:center;justify-content:center;z-index:9999;display:none}
.alert-float{position:fixed;top:80px;left:50%;transform:translateX(-50%);min-width:340px;z-index:9999;display:none}
/* Active/paid state banner */
.success-banner{background:linear-gradient(135deg,#155724,#28a745);color:#fff;border-radius:14px;padding:2rem;text-align:center;margin-bottom:1.5rem}
.tab-btn{border:2px solid #e5e5e5;background:#fff;border-radius:8px;padding:8px 18px;font-weight:600;font-size:.9rem;cursor:pointer;transition:all .2s}
.tab-btn.active{border-color:var(--red);background:var(--red);color:#fff}
</style>
</head>
<body>

<div class="spinner-overlay" id="spinnerOverlay">
  <div class="text-center"><div class="spinner-border text-danger" style="width:3rem;height:3rem"></div>
  <p class="mt-3 text-muted" id="spinnerMsg">Please wait...</p></div>
</div>
<div class="alert alert-danger alert-float shadow" id="alertFloat" role="alert"></div>

<!-- Banner -->
<div class="banner">
  <h1>Join BANF FY2026-27</h1>
  <p>Bengali Association of North Florida &mdash; Membership Drive</p>
  <div class="step-bar mt-3" id="stepBar">
    <div class="step active" data-s="1"><div class="snum">1</div><br>Membership</div>
    <div class="step" data-s="2"><div class="snum">2</div><br>AI Advisor</div>
    <div class="step" data-s="3"><div class="snum">3</div><br>Your Info</div>
    <div class="step" data-s="4"><div class="snum">4</div><br>Payment</div>
    <div class="step" data-s="5"><div class="snum">5</div><br>Confirm</div>
  </div>
</div>

<div class="wizard-wrap">

<!-- STEP 1: Choose Category & Household Type -->
<div class="wizard-step active" id="step1">
  <h4 class="fw-bold mb-1">FY2026-27 Membership Categories</h4>
  <p class="text-muted mb-2">Choose your category and household type. 7 options for every profile &amp; budget.</p>
  <!-- Household type selector -->
  <div class="d-flex gap-2 flex-wrap mb-3" id="householdBtns">
    <button class="tab-btn active" onclick="setHousehold('family')" id="ht-family">Family</button>
    <button class="tab-btn" onclick="setHousehold('couple')" id="ht-couple">Couple</button>
    <button class="tab-btn" onclick="setHousehold('individual')" id="ht-individual">Individual</button>
    <button class="tab-btn" onclick="setHousehold('student')" id="ht-student">Student</button>
  </div>

  <div class="table-responsive mb-3">
    <table class="table table-bordered price-table mb-0 text-center" id="pricingTable">
      <thead><tr>
        <th class="text-start">Category</th><th>Events</th><th>Value x</th>
        <th>Family</th><th>Couple</th><th>Individual</th><th>Student</th><th></th>
      </tr></thead>
      <tbody id="pricingBody">
        <tr><td colspan="8" class="text-center py-3"><div class="spinner-border spinner-border-sm text-danger"></div></td></tr>
      </tbody>
    </table>
  </div>

  <div class="row g-3" id="categoryCards">
    <div class="col-12 text-center py-3"><div class="spinner-border text-danger"></div></div>
  </div>

  <!-- Event access matrix (collapsible) -->
  <div class="mt-3">
    <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#eventMatrix">
      <i class="bi bi-table me-1"></i>View Full Event Access Matrix
    </button>
    <div class="collapse mt-2" id="eventMatrix">
      <div class="table-responsive">
        <table class="table table-sm table-bordered" id="eventMatrixTable">
          <thead class="table-dark"><tr>
            <th>Event</th><th>Date</th><th>Type</th>
            <th>M2 EB</th><th>M2</th><th>M1</th><th>Cultural</th><th>DP-1</th><th>DP-2</th>
          </tr></thead>
          <tbody id="eventMatrixBody"></tbody>
        </table>
      </div>
      <p class="text-muted small mt-1"><span class="ev-incl">Included</span> &nbsp; <span class="ev-addon">$XX Add-on</span> &nbsp; <span class="ev-na">Not available</span></p>
    </div>
  </div>

  <div class="d-flex justify-content-between mt-4">
    <button class="btn btn-outline-secondary" onclick="goToStep(2)"><i class="bi bi-robot me-1"></i>AI Advisor</button>
    <button class="btn btn-danger px-4" id="btnStep1Next" onclick="goToStep(3)" disabled><i class="bi bi-arrow-right me-1"></i>Continue</button>
  </div>
</div>

<!-- STEP 2: AI Advisor -->
<div class="wizard-step" id="step2">
  <h4 class="fw-bold mb-1"><i class="bi bi-robot text-danger me-2"></i>AI Membership Advisor</h4>
  <p class="text-muted mb-3">Answer a few questions and our AI will recommend the best FY2026-27 plan.</p>
  <div class="card shadow-sm border-0 mb-3">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label fw-semibold">Adults in household</label>
          <select class="form-select" id="ai_adults"><option value="1">1</option><option value="2" selected>2</option><option value="3">3+</option></select>
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold">Children (under 18)</label>
          <select class="form-select" id="ai_children"><option value="0" selected>0</option><option value="1">1</option><option value="2">2</option><option value="3">3+</option></select>
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold">Full-time student?</label>
          <select class="form-select" id="ai_student"><option value="false" selected>No</option><option value="true">Yes</option></select>
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold">Primary Durga Puja focused?</label>
          <select class="form-select" id="ai_dp"><option value="false" selected>No - general events</option><option value="true">Yes - mainly Durga Puja</option></select>
        </div>
        <div class="col-12">
          <label class="form-label fw-semibold">Interests (select all that apply)</label>
          <div class="row g-2">
            <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" value="cultural events" id="i1" checked><label class="form-check-label" for="i1">Cultural Events</label></div></div>
            <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" value="Durga Puja" id="i2"><label class="form-check-label" for="i2">Durga Puja</label></div></div>
            <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" value="kids programs" id="i3"><label class="form-check-label" for="i3">Kids Programs</label></div></div>
            <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" value="workshops" id="i4"><label class="form-check-label" for="i4">Workshops</label></div></div>
            <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" value="sports" id="i5"><label class="form-check-label" for="i5">Sports Day</label></div></div>
            <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" value="drama music" id="i6"><label class="form-check-label" for="i6">Drama &amp; Music</label></div></div>
          </div>
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold">Annual budget preference</label>
          <select class="form-select" id="ai_budget">
            <option value="">No preference</option>
            <option value="75">Up to $75</option>
            <option value="150">Up to $150</option>
            <option value="215">Up to $215</option>
            <option value="280">Up to $280</option>
            <option value="500">Flexible</option>
          </select>
        </div>
      </div>
      <button class="btn btn-danger mt-3" onclick="runAdvisor()"><i class="bi bi-magic me-2"></i>Get AI Recommendation</button>
    </div>
  </div>
  <div class="d-none" id="aiResult">
    <div class="card border-warning mb-3">
      <div class="card-body">
        <h6 class="fw-bold"><i class="bi bi-robot text-warning me-1"></i>AI Recommendation</h6>
        <p id="aiResultText" class="mb-2"></p>
        <div id="aiSelectBtn"></div>
      </div>
    </div>
  </div>
  <div class="d-flex justify-content-between mt-4">
    <button class="btn btn-outline-secondary" onclick="goToStep(1)"><i class="bi bi-arrow-left me-1"></i>Back</button>
    <button class="btn btn-danger px-4" onclick="goToStep(selectedCategory ? 3 : 1)"><i class="bi bi-arrow-right me-1"></i>Skip to Registration</button>
  </div>
</div>

<!-- STEP 3: Registration Form -->
<div class="wizard-step" id="step3">
  <h4 class="fw-bold mb-1">Your Information</h4>
  <div class="alert alert-info py-2 mb-3 d-flex gap-2 align-items-center" id="s3TierBanner">
    <i class="bi bi-info-circle-fill"></i>
    <span id="s3TierText">Selected: <strong></strong></span>
  </div>
  <div class="card shadow-sm border-0">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6"><label class="form-label fw-semibold">First Name <span class="text-danger">*</span></label><input type="text" class="form-control" id="r_firstName"></div>
        <div class="col-md-6"><label class="form-label fw-semibold">Last Name <span class="text-danger">*</span></label><input type="text" class="form-control" id="r_lastName"></div>
        <div class="col-md-6"><label class="form-label fw-semibold">Email Address <span class="text-danger">*</span></label><input type="email" class="form-control" id="r_email"></div>
        <div class="col-md-6"><label class="form-label fw-semibold">Phone Number</label><input type="tel" class="form-control" id="r_phone" placeholder="(xxx) xxx-xxxx"></div>
        <div class="col-md-6"><label class="form-label fw-semibold">Spouse / Partner Name</label><input type="text" class="form-control" id="r_spouse"></div>
        <div class="col-md-6"><label class="form-label fw-semibold">City</label><input type="text" class="form-control" id="r_city" placeholder="Jacksonville"></div>
        <div class="col-12"><label class="form-label fw-semibold">Children Names (comma separated)</label><input type="text" class="form-control" id="r_children" placeholder="e.g. Riya, Arjun"></div>
        <div class="col-md-6"><label class="form-label fw-semibold">How did you hear about BANF?</label>
          <select class="form-select" id="r_referral">
            <option value="">Select...</option><option>Friend / Family</option><option>Social Media</option>
            <option>WhatsApp Group</option><option>BANF Event</option><option>Website</option><option>Other</option>
          </select>
        </div>
      </div>
    </div>
  </div>
  <div class="d-flex justify-content-between mt-4">
    <button class="btn btn-outline-secondary" onclick="goToStep(1)"><i class="bi bi-arrow-left me-1"></i>Back</button>
    <button class="btn btn-danger px-4" onclick="submitRegistration()"><i class="bi bi-check2-circle me-1"></i>Register</button>
  </div>
</div>

<!-- STEP 4: Payment -->
<div class="wizard-step" id="step4">
  <h4 class="fw-bold mb-1">Complete Payment</h4>
  <p class="text-muted mb-3">Registration submitted. Send your membership fee via Zelle to activate.</p>

  <div class="zelle-block mb-4">
    <div class="amount-badge" id="z_amount">$280</div>
    <div class="text-muted mb-3">FY2026-27 membership &mdash; <strong id="z_tierName">M1 Regular</strong> (<span id="z_household">Family</span>)</div>
    <div class="mb-2"><i class="bi bi-phone me-1 text-success"></i><strong>Zelle to:</strong> <code class="fs-5">banfjax@gmail.com</code></div>
    <div class="mb-3"><strong>Memo / Note (required):</strong><br><span class="code-badge" id="z_memo">BANF Membership BANF-XXXXXXXX</span></div>
    <div class="alert alert-warning d-inline-flex gap-2 py-2 px-3" style="border-radius:8px;font-size:.85rem">
      <i class="bi bi-exclamation-triangle-fill"></i>Use this exact memo so we can match your payment
    </div>
  </div>

  <div class="card shadow-sm border-0 mb-3">
    <div class="card-body">
      <h6 class="fw-bold">How to send Zelle</h6>
      <ol style="font-size:.9rem">
        <li>Open your bank app or the Zelle app</li>
        <li>Send <strong id="z_amount2">$280</strong> to <strong>banfjax@gmail.com</strong> (BANF Jacksonville)</li>
        <li>In the <em>Memo/Note</em> field enter: <strong id="z_memo2">BANF Membership BANF-XXXXXXXX</strong></li>
        <li>Submit the payment</li>
        <li>EC will confirm payment and activate your membership within 1-2 business days</li>
      </ol>
    </div>
  </div>

  <!-- TEST / DEMO payment button -->
  <div class="card border-warning mb-3">
    <div class="card-body">
      <h6 class="fw-bold text-warning"><i class="bi bi-flask me-1"></i>Demo / Test Mode</h6>
      <p class="mb-2" style="font-size:.9rem">For testing purposes only: clicking the button below simulates a Zelle payment confirmation and triggers the welcome email instantly.</p>
      <a class="btn btn-warning fw-bold" id="testPayBtn" href="#" target="_blank">
        <i class="bi bi-lightning-charge-fill me-1"></i>Simulate Payment Received (Test Only)
      </a>
    </div>
  </div>

  <div class="alert alert-success d-flex gap-2">
    <i class="bi bi-envelope-check-fill mt-1"></i>
    <div>A confirmation email with payment instructions has been sent to <strong id="z_email"></strong>.</div>
  </div>

  <div class="d-flex justify-content-end mt-3">
    <button class="btn btn-outline-secondary me-2" onclick="goToStep(5)">Done (already paid)</button>
  </div>
</div>

<!-- STEP 5: Confirmation -->
<div class="wizard-step" id="step5">
  <div id="paidSuccessBanner" class="success-banner d-none">
    <div style="font-size:3rem"></div>
    <h3 class="fw-bold mt-1">Payment Confirmed! Welcome to BANF!</h3>
    <p class="mb-0 opacity-90">Your FY2026-27 membership is now <strong>active</strong>.</p>
  </div>
  <div id="pendingBanner" class="text-center py-3">
    <div style="font-size:3.5rem"></div>
    <h3 class="fw-bold mt-1" style="color:var(--red)">Registration Complete!</h3>
    <p class="text-muted">Please complete Zelle payment to activate your membership.</p>
  </div>
  <div class="card shadow-sm border-0 mx-auto" style="max-width:440px">
    <div class="card-body text-center">
      <div class="text-muted small mb-1">Your Registration Code</div>
      <div class="code-badge fs-4 font-monospace" id="conf_code">BANF-XXXXXXXX</div>
      <div class="mt-2 text-muted small">
        <strong id="conf_tier">M1 Regular</strong> &nbsp;|&nbsp; <span id="conf_household">Family</span> &nbsp;|&nbsp; <strong id="conf_amount">$280</strong>
      </div>
      <hr>
      <p class="small mb-0"><i class="bi bi-envelope me-1 text-danger"></i>Confirmation sent to <strong id="conf_email"></strong></p>
    </div>
  </div>
  <div class="text-center mt-4">
    <a href="member-portal.html" class="btn btn-danger me-2"><i class="bi bi-person-circle me-1"></i>Member Portal</a>
    <a href="index.html" class="btn btn-outline-secondary"><i class="bi bi-house me-1"></i>BANF Home</a>
  </div>
  <div class="text-center mt-3 text-muted small">Questions? <a href="mailto:banfjax@gmail.com">banfjax@gmail.com</a></div>
</div>

</div><!-- wizard-wrap -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API = 'https://banfwix.wixsite.com/banf1/_functions';
let categories = [], eventList = [], eventAccess = {};
let selectedCategory = null;
let selectedHousehold = 'family';
let regData = null;

// Utilities
function showSpinner(msg){ document.getElementById('spinnerMsg').textContent=msg||'Please wait...'; document.getElementById('spinnerOverlay').style.display='flex'; }
function hideSpinner(){ document.getElementById('spinnerOverlay').style.display='none'; }
function showAlert(msg,type='danger'){ const el=document.getElementById('alertFloat'); el.className='alert alert-'+type+' alert-float shadow'; el.textContent=msg; el.style.display='block'; setTimeout(()=>{el.style.display='none';},5000); }
function goToStep(n){
  if(n===3 && !selectedCategory){ showAlert('Please select a membership category first.'); goToStep(1); return; }
  document.querySelectorAll('.wizard-step').forEach((s,i)=>s.classList.toggle('active',i===n-1));
  document.querySelectorAll('.step-bar .step').forEach(s=>{ const sn=+s.dataset.s; s.classList.toggle('active',sn===n); s.classList.toggle('done',sn<n); });
  window.scrollTo({top:0,behavior:'smooth'});
}

// Step 1: Load tiers
async function loadTiers(){
  try{
    showSpinner('Loading membership plans...');
    const r = await fetch(API+'/membership_tiers');
    const d = await r.json();
    if(!d.success) throw new Error(d.error);
    categories = d.categories; eventList = d.events; eventAccess = d.eventAccess;
    renderPricingTable(); renderCards(); renderEventMatrix();
  }catch(e){ document.getElementById('categoryCards').innerHTML='<div class="col-12"><div class="alert alert-danger">'+e.message+'</div></div>'; }
  finally{ hideSpinner(); }
}

function setHousehold(ht){
  selectedHousehold = ht;
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('ht-'+ht).classList.add('active');
  renderPricingTable(); renderCards();
}

const PRICE_COLORS = { m2_eb:'#8B0000', m2:'#C00020', m1:'#FF6B35', cultural:'#D4AF37', dp1:'#6f42c1', dp2:'#28a745' };

function renderPricingTable(){
  const ht = selectedHousehold;
  const rows = categories.map(c=>{
    const p = c.pricing;
    const isSelected = selectedCategory && selectedCategory.id === c.id;
    const rowClass = isSelected ? 'selected-row' : '';
    return `<tr class="${rowClass}" onclick="selectCat('${c.id}')" style="cursor:pointer">
      <td class="text-start fw-bold" style="color:${PRICE_COLORS[c.id]||'#333'}">${c.name}<br><small class="fw-normal text-muted">${c.tagline}</small></td>
      <td>${c.eventCount}</td>
      <td class="fw-bold">${c.multiplier}&#215;</td>
      <td${ht==='family'?' class="table-warning fw-bold"':''}>${ht==='family'?'<strong>':''}$${c.pricing.family}${ht==='family'?'</strong>':''}</td>
      <td${ht==='couple'?' class="table-warning fw-bold"':''}>${ht==='couple'?'<strong>':''}$${c.pricing.couple}${ht==='couple'?'</strong>':''}</td>
      <td${ht==='individual'?' class="table-warning fw-bold"':''}>${ht==='individual'?'<strong>':''}$${c.pricing.individual}${ht==='individual'?'</strong>':''}</td>
      <td${ht==='student'?' class="table-warning fw-bold"':''}>${ht==='student'?'<strong>':''}$${c.pricing.student}${ht==='student'?'</strong>':''}</td>
      <td><button class="btn btn-sm ${isSelected?'btn-danger':'btn-outline-danger'}" onclick="event.stopPropagation();selectCat('${c.id}')">${isSelected?'Selected':'Select'}</button></td>
    </tr>`;
  }).join('');
  document.getElementById('pricingBody').innerHTML = rows;
}

function renderCards(){
  const ht = selectedHousehold;
  document.getElementById('categoryCards').innerHTML = categories.map(c=>{
    const price = c.pricing[ht];
    const isSelected = selectedCategory && selectedCategory.id === c.id;
    const badgeColors = { m2_eb:'bg-danger', m2:'bg-secondary', m1:'bg-warning text-dark', cultural:'bg-warning text-dark', dp1:'bg-primary', dp2:'bg-success' };
    return `<div class="col-sm-6 col-lg-4">
      <div class="cat-card${isSelected?' selected':''}" onclick="selectCat('${c.id}')" id="cc-${c.id}">
        <span class="badge-highlight badge ${badgeColors[c.id]||'bg-secondary'}">${c.badge}</span>
        <div class="fw-bold mb-1" style="color:${PRICE_COLORS[c.id]||'#333'};font-size:1rem">${c.name}</div>
        <div class="cat-price" style="color:${PRICE_COLORS[c.id]||'#333'}">$${price}<small style="font-size:.9rem;font-weight:400;color:#888">/yr</small></div>
        <div class="text-muted small mb-2">${c.tagline}</div>
        <div class="text-muted small mb-2"><i class="bi bi-calendar3 me-1"></i>${c.eventCount} events &nbsp;<i class="bi bi-graph-up me-1 ms-2"></i>${c.multiplier}&#215; value</div>
        <ul class="list-unstyled mb-0" style="font-size:.8rem">${c.features.slice(0,4).map(f=>`<li>&#10003; ${f}</li>`).join('')}</ul>
      </div>
    </div>`;
  }).join('');
}

function renderEventMatrix(){
  const cats = ['m2_eb','m2','m1','cultural','dp1','dp2'];
  const rows = eventList.map((ev,i)=>{
    const cells = cats.map(cid=>{
      const acc = (eventAccess[cid]||[])[i]||'na';
      if(acc==='incl') return '<td class="ev-incl text-center">&#10003;</td>';
      if(acc==='na') return '<td class="ev-na text-center">-</td>';
      return `<td class="ev-addon text-center">${acc}</td>`;
    }).join('');
    const typeColors = {Cultural:'#D4AF37',Religious:'#8B0000',Social:'#28a745',Educational:'#17a2b8'};
    return `<tr><td>${ev.name}</td><td style="white-space:nowrap;font-size:.8rem">${ev.date}</td><td><span style="font-size:.75rem;color:${typeColors[ev.type]||'#555'};font-weight:600">${ev.type}</span></td>${cells}</tr>`;
  }).join('');
  document.getElementById('eventMatrixBody').innerHTML = rows;
}

function selectCat(id){
  selectedCategory = categories.find(c=>c.id===id);
  document.getElementById('btnStep1Next').disabled = false;
  document.querySelectorAll('.cat-card').forEach(c=>c.classList.remove('selected'));
  document.getElementById('cc-'+id)?.classList.add('selected');
  renderPricingTable();
  const price = selectedCategory.pricing[selectedHousehold];
  document.querySelector('#s3TierText strong').textContent = `${selectedCategory.name} - ${selectedHousehold} - $${price}`;
}

// Step 2: AI Advisor
async function runAdvisor(){
  const interests = [...document.querySelectorAll('[id^=i]:checked')].map(c=>c.value);
  const body = {
    adults: +document.getElementById('ai_adults').value,
    children: +document.getElementById('ai_children').value,
    isStudent: document.getElementById('ai_student').value==='true',
    dpFocused: document.getElementById('ai_dp').value==='true',
    interests,
    budget: document.getElementById('ai_budget').value || null
  };
  // auto-set household
  if(body.isStudent) setHousehold('student');
  else if(body.adults>=2 && body.children>0) setHousehold('family');
  else if(body.adults>=2) setHousehold('couple');
  else setHousehold('individual');

  try{
    showSpinner('Getting AI recommendation...');
    const res = await fetch(API+'/membership_recommend',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const d = await res.json();
    if(!d.success) throw new Error(d.error);
    document.getElementById('aiResultText').textContent = d.recommendation||'';
    if(d.category){
      document.getElementById('aiSelectBtn').innerHTML = `<button class="btn btn-sm btn-danger" onclick="selectCatFromAdvisor('${d.recommendedCategoryId}')">Select ${d.category.name} ($${d.price}/yr)</button>`;
    }
    document.getElementById('aiResult').classList.remove('d-none');
  }catch(e){ showAlert('Advisor error: '+e.message); }
  finally{ hideSpinner(); }
}
function selectCatFromAdvisor(id){ selectCat(id); goToStep(3); }

// Step 3: Register
function validateForm(){
  let ok = true;
  ['r_firstName','r_lastName','r_email'].forEach(id=>{ const el=document.getElementById(id); if(!el.value.trim()){el.classList.add('is-invalid');ok=false;}else el.classList.remove('is-invalid'); });
  if(!selectedCategory){ showAlert('Please select a membership category.'); ok=false; }
  return ok;
}

async function submitRegistration(){
  if(!validateForm()) return;
  const childNames = document.getElementById('r_children').value.split(',').map(s=>s.trim()).filter(Boolean);
  const body = {
    firstName: document.getElementById('r_firstName').value.trim(),
    lastName: document.getElementById('r_lastName').value.trim(),
    email: document.getElementById('r_email').value.trim().toLowerCase(),
    phone: document.getElementById('r_phone').value.trim(),
    spouseName: document.getElementById('r_spouse').value.trim(),
    city: document.getElementById('r_city').value.trim(),
    categoryId: selectedCategory.id,
    householdType: selectedHousehold,
    childCount: childNames.length,
    childNames,
    referralSource: document.getElementById('r_referral').value
  };
  try{
    showSpinner('Submitting registration...');
    const res = await fetch(API+'/membership_register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const d = await res.json();
    if(!d.success && !d.alreadyRegistered) throw new Error(d.error);

    const code = d.registrationCode;
    const amount = d.amount || selectedCategory.pricing[selectedHousehold];
    const memo = 'BANF Membership '+code;
    const testLink = d.testPayLink || ('https://banfwix.wixsite.com/banf1/_functions/membership_test_pay?code='+code);
    regData = { ...body, code, amount, memo, testLink };

    // Populate payment step
    document.getElementById('z_amount').textContent = '$'+amount;
    document.getElementById('z_amount2').textContent = '$'+amount;
    document.getElementById('z_tierName').textContent = selectedCategory.name;
    document.getElementById('z_household').textContent = selectedHousehold;
    document.getElementById('z_memo').textContent = memo;
    document.getElementById('z_memo2').textContent = memo;
    document.getElementById('z_email').textContent = body.email;
    document.getElementById('testPayBtn').href = testLink;

    // Populate confirm step
    document.getElementById('conf_code').textContent = code;
    document.getElementById('conf_tier').textContent = selectedCategory.name;
    document.getElementById('conf_household').textContent = selectedHousehold;
    document.getElementById('conf_amount').textContent = '$'+amount;
    document.getElementById('conf_email').textContent = body.email;

    goToStep(4);
  }catch(e){ showAlert('Registration failed: '+e.message); }
  finally{ hideSpinner(); }
}

// Handle return from test_pay endpoint redirect
function handleReturnParams(){
  const p = new URLSearchParams(location.search);
  if(p.get('paid')==='1'){
    const code=p.get('code')||''; const name=p.get('name')||'';
    // Jump to step 5 showing success
    goToStep(5);
    document.getElementById('conf_code').textContent = code;
    document.getElementById('paidSuccessBanner').classList.remove('d-none');
    document.getElementById('pendingBanner').classList.add('d-none');
    if(name) document.querySelector('#step5 h3').textContent = 'Welcome to BANF, '+name+'!';
  } else if(p.get('paid')==='already'){
    const code=p.get('code')||''; const name=p.get('name')||'';
    goToStep(5);
    document.getElementById('conf_code').textContent = code;
    document.getElementById('paidSuccessBanner').classList.remove('d-none');
    document.getElementById('paidSuccessBanner').querySelector('h3').textContent = 'Already Active'+( name?' - Welcome back, '+name+'!':'!');
    document.getElementById('pendingBanner').classList.add('d-none');
  } else if(p.get('error')){
    const msg = {'missing_code':'No registration code provided','not_found':'Registration code not found. Please re-register.','server':'Server error, please contact banfjax@gmail.com'}[p.get('error')]||'Payment error.';
    showAlert(msg);
  }
}

// Init
loadTiers();
handleReturnParams();
</script>
</body>
</html>
