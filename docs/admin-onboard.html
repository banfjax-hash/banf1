<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BANF Account Setup</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
:root { --red:#b91c1c; --dark:#7f1d1d; --light-red:#fef2f2; }
body { background:linear-gradient(135deg,#b91c1c 0%,#7f1d1d 50%,#1a1a2e 100%); min-height:100vh; font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; display:flex; align-items:center; justify-content:center; padding:20px }
.wizard-wrap { max-width:720px; width:100%; margin:auto }
.wizard-card { background:#fff; border-radius:20px; box-shadow:0 25px 60px rgba(0,0,0,.4); overflow:hidden }
.wizard-header { background:linear-gradient(135deg,var(--red),var(--dark)); padding:28px 36px }
.wizard-header h1 { color:#fff; font-size:1.5rem; font-weight:700; margin:0 }
.wizard-header p { color:rgba(255,255,255,.75); font-size:.88rem; margin:4px 0 0 }
/* Step progress */
.steps-bar { display:flex; align-items:center; padding:20px 36px; border-bottom:1px solid #f0f0f0; gap:0 }
.step-item { display:flex; align-items:center; flex:1 }
.step-circle { width:34px; height:34px; border-radius:50%; border:2px solid #ddd; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:.85rem; background:#fff; color:#999; transition:all .3s; flex-shrink:0 }
.step-circle.active { background:var(--red); border-color:var(--red); color:#fff }
.step-circle.done { background:#16a34a; border-color:#16a34a; color:#fff }
.step-label { font-size:.75rem; color:#999; margin-left:8px; font-weight:500 }
.step-label.active { color:var(--red); font-weight:700 }
.step-label.done { color:#16a34a }
.step-line { flex:1; height:2px; background:#e5e7eb; margin:0 8px }
.step-line.done { background:#16a34a }
/* Content */
.wizard-body { padding:32px 36px }
.step-pane { display:none }
.step-pane.active { display:block }
.section-head { font-size:1.2rem; font-weight:700; color:#1f2937; margin-bottom:4px }
.section-sub { color:#6b7280; font-size:.88rem; margin-bottom:24px }
.form-label { font-weight:600; color:#374151; margin-bottom:6px; font-size:.9rem }
.required-star { color:var(--red) }
.form-control, .form-select { border-radius:10px; border:2px solid #e5e7eb; padding:10px 14px; font-size:.93rem; transition:border-color .2s }
.form-control:focus, .form-select:focus { border-color:var(--red); box-shadow:0 0 0 3px rgba(185,28,28,.12); outline:none }
.btn-banf { background:linear-gradient(135deg,var(--red),var(--dark)); color:#fff; border:none; border-radius:10px; padding:11px 28px; font-weight:700; font-size:.95rem; cursor:pointer; transition:opacity .2s }
.btn-banf:hover { opacity:.9; color:#fff }
.btn-banf:disabled { opacity:.5; cursor:not-allowed }
.badge-role { background:var(--light-red); color:var(--red); padding:4px 12px; border-radius:20px; font-size:.78rem; font-weight:700; border:1px solid #fca5a5 }
.badge-title { background:linear-gradient(135deg,var(--red),var(--dark)); color:#fff; padding:4px 14px; border-radius:20px; font-size:.78rem; font-weight:700 }
.family-card { border:1px solid #e5e7eb; border-radius:12px; padding:16px; background:#fafafa; margin-bottom:12px }
.family-card h6 { color:#1f2937; font-weight:700; margin:0 0 8px }
.field-hint { font-size:.77rem; color:#9ca3af; margin-top:3px }
.pw-req-list { margin:10px 0 0; padding:0; list-style:none; display:grid; grid-template-columns:1fr 1fr; gap:5px 16px }
.pw-req { font-size:.79rem; color:#9ca3af; display:flex; align-items:center; gap:6px; transition:color .2s }
.pw-req.met  { color:#16a34a; font-weight:600 }
.pw-req.fail { color:#ef4444; font-weight:600 }
.pw-req i { font-size:.75rem; width:14px; text-align:center }
.pw-req-note { font-size:.77rem; color:#6b7280; margin-top:6px }
.info-banner { background:var(--light-red); border:1px solid #fca5a5; border-radius:12px; padding:14px 18px; margin-bottom:20px }
.info-banner p { margin:0; font-size:.88rem; color:#7f1d1d }
.success-icon { font-size:4rem; color:#16a34a }
.alert-err { background:#fef2f2; border:1px solid #fca5a5; color:#7f1d1d; border-radius:10px; padding:12px 16px; font-size:.88rem; margin-bottom:16px; display:none }
.loading-overlay { position:fixed; inset:0; background:rgba(0,0,0,.4); display:flex; align-items:center; justify-content:center; z-index:9999; display:none }
.spinner-big { width:56px; height:56px; border:5px solid #fff; border-top-color:var(--red); border-radius:50%; animation:spin .8s linear infinite }
@keyframes spin { to { transform:rotate(360deg) } }
</style>
</head>
<body>

<div class="loading-overlay" id="loading-overlay">
  <div class="spinner-big"></div>
</div>

<div class="wizard-wrap">
  <div class="wizard-card">

    <!-- Header -->
    <div class="wizard-header">
      <h1>&#x1F331; Bengali Association of NE Florida</h1>
      <p>Account Setup &amp; Profile Completion</p>
    </div>

    <!-- Error state (invalid token) -->
    <div id="err-state" style="display:none" class="p-5 text-center">
      <div style="font-size:3rem;color:#dc2626"><i class="fas fa-exclamation-triangle"></i></div>
      <h4 class="mt-3 text-danger">Invalid or Expired Setup Link</h4>
      <p class="text-muted" id="err-msg">This setup link is no longer valid. Please contact the admin who granted your role.</p>
      <a href="mailto:banfjax@gmail.com" class="btn btn-banf mt-2"><i class="fas fa-envelope me-2"></i>Contact Admin</a>
    </div>

    <!-- Step progress bar -->
    <div class="steps-bar" id="steps-bar">
      <div class="step-item">
        <div class="step-circle active" id="sc1">1</div>
        <span class="step-label active" id="sl1">Set Password</span>
      </div>
      <div class="step-line" id="line1"></div>
      <div class="step-item">
        <div class="step-circle" id="sc2">2</div>
        <span class="step-label" id="sl2">Your Profile</span>
      </div>
      <div class="step-line" id="line2"></div>
      <div class="step-item">
        <div class="step-circle" id="sc3">3</div>
        <span class="step-label" id="sl3">All Done</span>
      </div>
    </div>

    <!-- Body -->
    <div class="wizard-body">

      <!-- ══════════════════════════════════════════════════════ -->
      <!-- STEP 1: Set Password -->
      <!-- ══════════════════════════════════════════════════════ -->
      <div class="step-pane active" id="pane1">
        <div class="section-head">Welcome to BANF Admin!</div>
        <div class="section-sub">Please set a secure password for your account to continue.</div>

        <div class="info-banner mb-4" id="role-info-banner">
          <p><strong>Role granted:</strong> <span class="badge-role" id="disp-role">EC Member</span>
          &nbsp;<span class="badge-title" id="disp-title" style="display:none"></span></p>
          <p class="mt-1 mb-0"><strong>Account:</strong> <span id="disp-email" class="text-muted"></span></p>
        </div>

        <div id="err1" class="alert-err"><i class="fas fa-exclamation-circle me-2"></i><span id="err1-msg"></span></div>

        <div class="mb-3">
          <label class="form-label">New Password <span class="required-star">*</span></label>
          <div class="input-group">
            <input type="password" class="form-control" id="pw1" placeholder="e.g. MyP@ss2024!" oninput="checkPwReqs()" onkeydown="if(event.key==='Enter')step1Submit()">
            <button class="btn btn-outline-secondary" type="button" onclick="togglePw('pw1',this)"><i class="fas fa-eye"></i></button>
          </div>
          <!-- Live requirements checklist -->
          <ul class="pw-req-list" id="pw-req-list">
            <li class="pw-req" id="req-len"><i class="fas fa-circle"></i> Min. 8 characters</li>
            <li class="pw-req" id="req-upper"><i class="fas fa-circle"></i> Uppercase letter (A–Z)</li>
            <li class="pw-req" id="req-lower"><i class="fas fa-circle"></i> Lowercase letter (a–z)</li>
            <li class="pw-req" id="req-num"><i class="fas fa-circle"></i> Number (0–9)</li>
            <li class="pw-req" id="req-special" style="grid-column:span 1"><i class="fas fa-circle"></i> Special char (!@#$%^&amp;*)</li>
            <li class="pw-req" id="req-match" style="grid-column:span 1"><i class="fas fa-circle"></i> Passwords match</li>
          </ul>
        </div>

        <div class="mb-4">
          <label class="form-label">Confirm Password <span class="required-star">*</span></label>
          <div class="input-group">
            <input type="password" class="form-control" id="pw2" placeholder="Repeat password" oninput="checkPwReqs()" onkeydown="if(event.key==='Enter')step1Submit()">
            <button class="btn btn-outline-secondary" type="button" onclick="togglePw('pw2',this)"><i class="fas fa-eye"></i></button>
          </div>
        </div>

        <button class="btn btn-banf w-100" onclick="step1Submit()" id="btn-step1">
          <i class="fas fa-lock me-2"></i>Set Password &amp; Continue
        </button>
      </div>

      <!-- ══════════════════════════════════════════════════════ -->
      <!-- STEP 2: Complete Profile -->
      <!-- ══════════════════════════════════════════════════════ -->
      <div class="step-pane" id="pane2">
        <div class="section-head">Complete Your Profile</div>
        <div class="section-sub">Help us keep BANF records accurate. <strong>Phone number is required</strong> for EC communications.</div>

        <div id="err2" class="alert-err"><i class="fas fa-exclamation-circle me-2"></i><span id="err2-msg"></span></div>

        <h6 class="fw-bold text-muted small text-uppercase mb-3" style="letter-spacing:.05em"><i class="fas fa-user me-1"></i> Personal Information</h6>

        <div class="row g-3 mb-2">
          <div class="col-md-6">
            <label class="form-label">First Name</label>
            <input type="text" class="form-control" id="pf-fname" placeholder="First name">
          </div>
          <div class="col-md-6">
            <label class="form-label">Last Name</label>
            <input type="text" class="form-control" id="pf-lname" placeholder="Last name">
          </div>
          <div class="col-md-6">
            <label class="form-label">Email <span id="lbl-email-ro" class="text-muted small">(Your login)</span></label>
            <input type="email" class="form-control" id="pf-email" readonly style="background:#f9fafb">
          </div>
          <div class="col-md-6">
            <label class="form-label">Primary Phone <span class="required-star">*</span></label>
            <input type="tel" class="form-control" id="pf-phone" placeholder="e.g. (904) 555-1234">
            <div class="field-hint">Used for EC communications — mandatory</div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Alternate Phone</label>
            <input type="tel" class="form-control" id="pf-phone2" placeholder="Optional">
          </div>
        </div>

        <h6 class="fw-bold text-muted small text-uppercase mb-3 mt-4" style="letter-spacing:.05em"><i class="fas fa-map-marker-alt me-1"></i> Home Address</h6>

        <div class="row g-3 mb-2">
          <div class="col-12">
            <label class="form-label">Street Address</label>
            <input type="text" class="form-control" id="pf-addr" placeholder="123 Main Street">
          </div>
          <div class="col-md-5">
            <label class="form-label">City</label>
            <input type="text" class="form-control" id="pf-city" placeholder="City">
          </div>
          <div class="col-md-4">
            <label class="form-label">State</label>
            <input type="text" class="form-control" id="pf-state" placeholder="FL" maxlength="2">
          </div>
          <div class="col-md-3">
            <label class="form-label">ZIP</label>
            <input type="text" class="form-control" id="pf-zip" placeholder="32218" maxlength="10">
          </div>
        </div>

        <!-- Family Members Section -->
        <div id="family-section" style="display:none" class="mt-4">
          <h6 class="fw-bold text-muted small text-uppercase mb-3" style="letter-spacing:.05em"><i class="fas fa-users me-1"></i> Your Family Members <span class="text-muted fw-normal small">(from BANF records — please verify)</span></h6>
          <div id="family-container"></div>
        </div>

        <div class="d-flex gap-2 mt-4">
          <button class="btn btn-banf" onclick="step2Submit()" id="btn-step2">
            <i class="fas fa-check me-2"></i>Save &amp; Complete Setup
          </button>
          <button class="btn btn-outline-secondary" onclick="step2Skip()">
            Skip for now
          </button>
        </div>
        <div class="field-hint mt-2">You can update your profile anytime from the admin portal.</div>
      </div>

      <!-- ══════════════════════════════════════════════════════ -->
      <!-- STEP 3: All Done -->
      <!-- ══════════════════════════════════════════════════════ -->
      <div class="step-pane text-center py-4" id="pane3">
        <div class="success-icon mb-3"><i class="fas fa-check-circle"></i></div>
        <h4 class="fw-bold text-success mb-2">Setup Complete!</h4>
        <p class="text-muted mb-1">Your account is ready. You can now access the BANF Admin Portal.</p>
        <p class="text-muted small mb-4">Sign in with <strong id="done-email"></strong></p>
        <a href="#" id="btn-go-portal" class="btn btn-banf btn-lg px-5">
          <i class="fas fa-shield-alt me-2"></i>Open Admin Portal
        </a>
        <p class="text-muted small mt-3">Redirecting automatically in <span id="countdown">5</span> seconds...</p>
      </div>

    </div><!-- wizard-body -->
  </div><!-- wizard-card -->
</div><!-- wizard-wrap -->

<script>
const API = 'https://banfwix.wixsite.com/banf1/_functions';
const params = new URLSearchParams(window.location.search);
const EMAIL = (params.get('email') || '').trim();
const TOKEN = (params.get('token') || '').trim();
let adminName = '';
let portalUrl  = './admin-portal.html?email=' + encodeURIComponent(EMAIL);
let guideUrl   = './admin-guide.html?email=' + encodeURIComponent(EMAIL); // updated after verify

// ── Initialise ──────────────────────────────────────────────
(async function init() {
  if (!EMAIL || !TOKEN) { showErr('Missing email or setup token in URL.'); return; }
  showLoading(true);
  try {
    const res = await apiFetch('/admin_onboard_verify', 'POST', { email: EMAIL, token: TOKEN });
    showLoading(false);
    if (!res.success) { showErr(res.error || 'Invalid setup link'); return; }

    // Populate step-1 info banner
    const ar = res.adminRole || {};
    adminName = [ar.firstName, ar.lastName].filter(Boolean).join(' ') || EMAIL.split('@')[0];
    document.getElementById('disp-email').textContent = EMAIL;
    const roleMap = {ec_member:'EC Member', admin:'Admin', super_admin:'Super Admin', member:'Member'};
    document.getElementById('disp-role').textContent = roleMap[ar.role] || ar.role || 'EC Member';
    if (ar.ecTitle) {
      const el = document.getElementById('disp-title');
      el.textContent = ar.ecTitle; el.style.display = '';
    }

    // Pre-fill step-2 profile
    const p = res.profile || {};
    document.getElementById('pf-fname').value  = ar.firstName || p.firstName || '';
    document.getElementById('pf-lname').value  = ar.lastName  || p.lastName  || '';
    document.getElementById('pf-email').value  = EMAIL;
    document.getElementById('pf-phone').value  = p.phone  || p.phone1  || '';
    document.getElementById('pf-phone2').value = p.phone2 || '';
    document.getElementById('pf-addr').value   = p.address || p.street || '';
    document.getElementById('pf-city').value   = p.city   || '';
    document.getElementById('pf-state').value  = p.state  || 'FL';
    document.getElementById('pf-zip').value    = p.zipCode || p.zip || '';

    // Render family members
    if (res.family && res.family.members && res.family.members.length > 0) {
      renderFamilySection(res.family);
    }

    document.getElementById('done-email').textContent = EMAIL;

    // Build guide URL with name + role for the welcome message
    const fname    = ar.firstName || '';
    const roleDisp = ar.ecTitle   || (ar.role||'').replace(/_/g,' ');
    guideUrl = `./admin-guide.html` +
      `?email=${encodeURIComponent(EMAIL)}` +
      `&name=${encodeURIComponent(fname)}` +
      `&role=${encodeURIComponent(roleDisp)}`;
    document.getElementById('btn-go-portal').href = guideUrl;
    document.getElementById('btn-go-portal').innerHTML = '<i class="fas fa-book-open me-2"></i>View Guide &amp; Open Admin Panel';

    // If password was already set (user revisiting), go to step 2
    if (ar.passwordSet) {
      gotoStep(2);
    }

  } catch(e) {
    showLoading(false);
    showErr('Could not load setup data: ' + e.message);
  }
})();

// ── Step 1: Set Password ──────────────────────────────────────
async function step1Submit() {
  const pw1 = document.getElementById('pw1').value;
  const pw2 = document.getElementById('pw2').value;
  setErr(1, '');

  if (!pw1)              { setErr(1, 'Please enter a password.'); return; }
  if (pw1.length < 8)    { setErr(1, 'Password must be at least 8 characters.'); return; }
  if (!/[A-Z]/.test(pw1)) { setErr(1, 'Password must include at least one uppercase letter (A–Z).'); return; }
  if (!/[a-z]/.test(pw1)) { setErr(1, 'Password must include at least one lowercase letter (a–z).'); return; }
  if (!/[0-9]/.test(pw1)) { setErr(1, 'Password must include at least one number (0–9).'); return; }
  if (!/[^A-Za-z0-9]/.test(pw1)) { setErr(1, 'Password must include at least one special character (e.g. !@#$%^&*).'); return; }
  if (pw1 !== pw2)       { setErr(1, 'Passwords do not match.'); return; }

  setBtnLoading('btn-step1', true, 'Setting password…');
  try {
    const res = await apiFetch('/admin_set_password', 'POST', { email: EMAIL, token: TOKEN, password: pw1 });
    setBtnLoading('btn-step1', false, '<i class="fas fa-lock me-2"></i>Set Password &amp; Continue');
    if (!res.success) { setErr(1, res.error || 'Failed to set password'); return; }
    gotoStep(2);
  } catch(e) {
    setBtnLoading('btn-step1', false, '<i class="fas fa-lock me-2"></i>Set Password &amp; Continue');
    setErr(1, 'Error: ' + e.message);
  }
}

// ── Step 2: Save Profile ──────────────────────────────────────
async function step2Submit() {
  const phone = document.getElementById('pf-phone').value.trim();
  setErr(2, '');
  if (!phone) { setErr(2, 'Phone number is required.'); return; }

  const familyMembers = gatherFamilyEdits();

  const payload = {
    email: EMAIL, token: TOKEN,
    firstName: document.getElementById('pf-fname').value.trim(),
    lastName:  document.getElementById('pf-lname').value.trim(),
    phone,
    phone2:    document.getElementById('pf-phone2').value.trim(),
    address:   document.getElementById('pf-addr').value.trim(),
    city:      document.getElementById('pf-city').value.trim(),
    state:     document.getElementById('pf-state').value.trim(),
    zipCode:   document.getElementById('pf-zip').value.trim(),
    familyMembers
  };

  setBtnLoading('btn-step2', true, 'Saving…');
  try {
    const saveRes = await apiFetch('/admin_save_profile', 'POST', payload);
    if (!saveRes.success) {
      setBtnLoading('btn-step2', false, '<i class="fas fa-check me-2"></i>Save &amp; Complete Setup');
      setErr(2, saveRes.error || 'Failed to save profile'); return;
    }
    // Mark complete
    const doneRes = await apiFetch('/admin_onboard_complete', 'POST', { email: EMAIL, token: TOKEN });
    setBtnLoading('btn-step2', false, '<i class="fas fa-check me-2"></i>Save &amp; Complete Setup');
    if (!doneRes.success) { setErr(2, doneRes.error || 'Failed to finalize'); return; }
    gotoStep(3);
    startCountdown();
  } catch(e) {
    setBtnLoading('btn-step2', false, '<i class="fas fa-check me-2"></i>Save &amp; Complete Setup');
    setErr(2, 'Error: ' + e.message);
  }
}

async function step2Skip() {
  // Still mark as complete without profile changes
  showLoading(true);
  try {
    await apiFetch('/admin_onboard_complete', 'POST', { email: EMAIL, token: TOKEN });
  } catch(_) {}
  showLoading(false);
  gotoStep(3);
  startCountdown();
}

// ── Step 3: Countdown + redirect ─────────────────────────────
function startCountdown() {
  let c = 5;
  const el = document.getElementById('countdown');
  const t = setInterval(() => {
    c--;
    el.textContent = c;
    if (c <= 0) { clearInterval(t); window.location.href = guideUrl; }
  }, 1000);
}

// ── Family section ────────────────────────────────────────────
function renderFamilySection(family) {
  const sec = document.getElementById('family-section');
  const cont = document.getElementById('family-container');
  sec.style.display = '';

  const relLabels = {adult:'Spouse/Partner', minor:'Child/Minor'};
  cont.innerHTML = family.members.map(m => `
    <div class="family-card" data-memberid="${m.memberId || ''}">
      <h6><i class="fas fa-${m.relationshipType === 'minor' ? 'child' : 'user'} me-1 text-danger"></i>
        ${escHtml(m.firstName || '')} ${escHtml(m.lastName || '')}
        <span class="badge bg-secondary ms-1" style="font-size:.7rem;font-weight:500">${relLabels[m.relationshipType] || m.relationshipType || ''}</span>
      </h6>
      <div class="row g-2">
        <div class="col-md-4">
          <label class="form-label small mb-1">First Name</label>
          <input type="text" class="form-control form-control-sm fm-fname" value="${escHtml(m.firstName || '')}">
        </div>
        <div class="col-md-4">
          <label class="form-label small mb-1">Last Name</label>
          <input type="text" class="form-control form-control-sm fm-lname" value="${escHtml(m.lastName || '')}">
        </div>
        <div class="col-md-4">
          <label class="form-label small mb-1">Phone</label>
          <input type="tel" class="form-control form-control-sm fm-phone" value="${escHtml(m.phone || '')}">
        </div>
        <div class="col-md-6">
          <label class="form-label small mb-1">Email</label>
          <input type="email" class="form-control form-control-sm fm-email" value="${escHtml(m.email || '')}" placeholder="Optional">
        </div>
        <div class="col-md-6">
          <label class="form-label small mb-1">Relationship</label>
          <select class="form-select form-select-sm fm-rel">
            <option value="spouse" ${m.relationship==='spouse'?'selected':''}>Spouse/Partner</option>
            <option value="child" ${(m.relationship==='child'||m.relationshipType==='minor')?'selected':''}>Child</option>
            <option value="parent" ${m.relationship==='parent'?'selected':''}>Parent</option>
            <option value="sibling" ${m.relationship==='sibling'?'selected':''}>Sibling</option>
            <option value="other" ${(!m.relationship||m.relationship==='other')?'selected':''}>Other</option>
          </select>
        </div>
      </div>
    </div>`).join('');
}

function gatherFamilyEdits() {
  const cards = document.querySelectorAll('.family-card');
  const result = [];
  cards.forEach(card => {
    const mid = card.dataset.memberid;
    if (!mid) return;
    result.push({
      memberId:     mid,
      firstName:    card.querySelector('.fm-fname')?.value.trim()  || '',
      lastName:     card.querySelector('.fm-lname')?.value.trim()  || '',
      phone:        card.querySelector('.fm-phone')?.value.trim()  || '',
      email:        card.querySelector('.fm-email')?.value.trim()  || '',
      relationship: card.querySelector('.fm-rel')?.value           || ''
    });
  });
  return result;
}

// ── Step navigation ───────────────────────────────────────────
function gotoStep(n) {
  [1,2,3].forEach(i => {
    document.getElementById('pane'+i).classList.toggle('active', i===n);
    const sc = document.getElementById('sc'+i);
    const sl = document.getElementById('sl'+i);
    if (i < n) { sc.innerHTML='<i class="fas fa-check"></i>'; sc.classList.add('done'); sc.classList.remove('active'); sl.classList.add('done'); sl.classList.remove('active'); }
    else if (i===n) { sc.textContent=i; sc.classList.add('active'); sc.classList.remove('done'); sl.classList.add('active'); sl.classList.remove('done'); sc.innerHTML=i; }
    else { sc.textContent=i; sc.classList.remove('active','done'); sl.classList.remove('active','done'); }
    if (i < 3) document.getElementById('line'+i).classList.toggle('done', i < n);
  });
  window.scrollTo({top:0,behavior:'smooth'});
}

// ── Live password requirements checklist ─────────────────────
function checkPwReqs() {
  const pw  = document.getElementById('pw1').value;
  const pw2 = document.getElementById('pw2').value;
  function setReq(id, met) {
    const el = document.getElementById(id);
    el.classList.toggle('met',  met);
    el.classList.toggle('fail', pw.length > 0 && !met);
    el.querySelector('i').className = met ? 'fas fa-circle-check' : (pw.length > 0 ? 'fas fa-circle-xmark' : 'fas fa-circle');
  }
  setReq('req-len',     pw.length >= 8);
  setReq('req-upper',   /[A-Z]/.test(pw));
  setReq('req-lower',   /[a-z]/.test(pw));
  setReq('req-num',     /[0-9]/.test(pw));
  setReq('req-special', /[^A-Za-z0-9]/.test(pw));
  // Match check only when confirm field has a value
  const m2 = document.getElementById('req-match');
  if (pw2.length > 0) {
    const matched = pw === pw2;
    m2.classList.toggle('met',  matched);
    m2.classList.toggle('fail', !matched);
    m2.querySelector('i').className = matched ? 'fas fa-circle-check' : 'fas fa-circle-xmark';
  } else {
    m2.classList.remove('met','fail');
    m2.querySelector('i').className = 'fas fa-circle';
  }
}

function togglePw(id, btn) {
  const el = document.getElementById(id);
  const showing = el.type === 'text';
  el.type = showing ? 'password' : 'text';
  btn.innerHTML = showing ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
}

// ── Utilities ─────────────────────────────────────────────────
function escHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function setErr(step, msg) {
  const el = document.getElementById('err'+step);
  const ms = document.getElementById('err'+step+'-msg');
  if (ms) ms.textContent = msg;
  el.style.display = msg ? 'block' : 'none';
  if (msg) el.scrollIntoView({ behavior:'smooth', block:'nearest' });
}

function showErr(msg) {
  document.getElementById('steps-bar').style.display = 'none';
  document.querySelector('.wizard-body').style.display = 'none';
  const e = document.getElementById('err-state');
  e.style.display = '';
  document.getElementById('err-msg').textContent = msg;
}

function showLoading(on) { document.getElementById('loading-overlay').style.display = on ? 'flex' : 'none'; }

function setBtnLoading(id, on, label) {
  const btn = document.getElementById(id);
  btn.disabled = on;
  btn.innerHTML = on ? '<span class="spinner-border spinner-border-sm me-2"></span>Please wait…' : label;
}

async function apiFetch(path, method, body) {
  const res = await fetch(API + path, {
    method, headers: { 'Content-Type':'application/json' },
    body: body ? JSON.stringify(body) : undefined
  });
  return res.json();
}
</script>
</body>
</html>
