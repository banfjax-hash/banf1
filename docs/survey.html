<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BANF Survey</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--banf-red:#8B0000;--banf-orange:#FF6B35;--grad:linear-gradient(135deg,#8B0000,#DC143C)}
*{font-family:'Poppins',sans-serif;box-sizing:border-box}
body{background:linear-gradient(135deg,#f8e8e8,#fff5f0);min-height:100vh;padding:2rem 1rem}
.survey-card{max-width:680px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 8px 40px rgba(139,0,0,.12);overflow:hidden}
.survey-header{background:var(--grad);color:#fff;padding:2rem}
.survey-header h2{font-size:1.4rem;font-weight:700;margin-bottom:.3rem}
.survey-header .sv-desc{opacity:.9;margin:0;font-size:.88rem;line-height:1.5}
.survey-body{padding:2rem}
.event-summary{background:#fff8f0;border:1px solid #ffe0c2;border-radius:12px;padding:1rem 1.2rem;margin-bottom:1.5rem;font-size:.88rem;color:#444;line-height:1.6}
.event-summary strong{color:var(--banf-red)}
.rating-guide{background:#f0f0ff;border:1px solid #d0d0f0;border-radius:10px;padding:.8rem 1rem;margin-bottom:1.5rem;font-size:.8rem;color:#555}
.rating-guide strong{color:#333}
.q-card{background:#fafafa;border-radius:12px;padding:1.2rem 1.5rem;margin-bottom:1.2rem;border-left:4px solid var(--banf-orange);transition:border-left-color .2s}
.q-card.answered{border-left-color:var(--banf-red)}
.q-card.text-card{border-left-color:#6c5ce7}
.q-num{font-size:.72rem;color:var(--banf-orange);font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:.3rem}
.q-text{font-size:.95rem;font-weight:600;color:#222;margin-bottom:1rem;line-height:1.4}
.rating-row{display:flex;gap:.5rem;flex-wrap:wrap}
.rating-btn{width:44px;height:44px;border-radius:50%;border:2px solid #ddd;background:#fff;font-weight:600;font-size:.9rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center}
.rating-btn:hover{border-color:var(--banf-orange);background:#fff5f0}
.rating-btn.selected{background:var(--grad);color:#fff;border-color:var(--banf-red)}
.rating-labels{display:flex;justify-content:space-between;font-size:.65rem;color:#999;margin-top:.3rem;padding:0 4px}
.yn-row{display:flex;gap:.75rem}
.yn-btn{flex:1;padding:.6rem;border-radius:10px;border:2px solid #ddd;background:#fff;font-weight:600;cursor:pointer;transition:all .2s;text-align:center}
.yn-btn:hover{border-color:var(--banf-orange)}
.yn-btn.selected-yes{background:#d4edda;border-color:#28a745;color:#155724}
.yn-btn.selected-no{background:#f8d7da;border-color:#dc3545;color:#721c24}
.progress-bar-banf{background:var(--grad);border-radius:4px;transition:width .4s ease}
.btn-submit{background:var(--grad);color:#fff;border:none;border-radius:12px;padding:.85rem 2.5rem;font-size:1rem;font-weight:600;width:100%;cursor:pointer;transition:opacity .2s}
.btn-submit:hover{opacity:.88}
.btn-submit:disabled{opacity:.5;cursor:not-allowed}
#state-loading{text-align:center;padding:3rem 1rem}
#state-error{text-align:center;padding:3rem 1rem}
#state-thanks{text-align:center;padding:3rem 1rem}
.spinner{width:48px;height:48px;border:5px solid #f3e8e8;border-top-color:var(--banf-red);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto}
@keyframes spin{to{transform:rotate(360deg)}}
.req-star{color:var(--banf-orange);font-weight:700}
.anon-notice{background:rgba(255,255,255,.15);border-radius:8px;padding:.5rem 1rem;font-size:.78rem;margin-top:.8rem}
.confid-box{background:#f1f8e9;border:1px solid #c5e1a5;border-radius:10px;padding:.8rem 1rem;margin-bottom:1rem;font-size:.8rem;color:#555}
</style>
</head>
<body>

<div class="survey-card" id="survey-app">

  <!-- LOADING -->
  <div id="state-loading">
    <div class="spinner"></div>
    <p class="mt-3 text-muted">Loading your survey...</p>
  </div>

  <!-- ERROR -->
  <div id="state-error" style="display:none">
    <div style="font-size:3rem">&#x1F615;</div>
    <h5 class="mt-3" id="err-title">Something went wrong</h5>
    <p class="text-muted small" id="err-msg">Please check your link and try again.</p>
    <p class="text-muted small">If you need help, contact <a href="mailto:banfjax@gmail.com">banfjax@gmail.com</a></p>
  </div>

  <!-- SURVEY FORM -->
  <div id="state-form" style="display:none">
    <div class="survey-header">
      <div class="small mb-1 opacity-75">Bengali Association of North Florida (BANF)</div>
      <h2 id="sv-title">Survey</h2>
      <p class="sv-desc" id="sv-desc"></p>
      <div class="anon-notice">&#x1F512; Your responses are <strong>completely anonymous</strong>. No personal details are linked to your answers.</div>
      <div class="mt-3">
        <div class="d-flex justify-content-between mb-1">
          <span style="font-size:.8rem;opacity:.8">Progress</span>
          <span id="progress-label" style="font-size:.8rem;opacity:.8">0%</span>
        </div>
        <div style="background:rgba(255,255,255,.25);border-radius:4px;height:6px">
          <div id="progress-bar" class="progress-bar-banf" style="width:0;height:6px"></div>
        </div>
      </div>
    </div>
    <div class="survey-body">

      <!-- Event summary & purpose -->
      <div class="event-summary" id="event-summary"></div>

      <!-- Rating guide -->
      <div class="rating-guide">
        <strong>Rating Guide:</strong> 1 = Very Low &nbsp;|&nbsp; 2 = Low &nbsp;|&nbsp; 3 = Neutral &nbsp;|&nbsp; 4 = High &nbsp;|&nbsp; 5 = Very High
      </div>

      <!-- Confidentiality -->
      <div class="confid-box">
        <strong style="color:#33691e">Confidentiality:</strong> Your individual responses are strictly confidential. Only aggregated results (averages, summaries) are shared with the EC. No one can see who gave which response.
      </div>

      <div id="questions-container"></div>
      <button class="btn-submit" id="submit-btn" onclick="submitSurvey()" disabled>Complete required questions to submit</button>
      <p class="text-muted small text-center mt-2">By submitting you agree to BANF's privacy policy</p>
    </div>
  </div>

  <!-- THANK YOU -->
  <div id="state-thanks" style="display:none">
    <div style="font-size:3.5rem">&#x1F64F;</div>
    <h4 class="mt-3 fw-bold" style="color:var(--banf-red)">Thank you!</h4>
    <p class="text-muted">Your response has been recorded anonymously.<br>The EC will review and process all responses.</p>
    <div class="mt-3 p-3 rounded" style="background:#f8e8e8;font-size:.85rem;color:#555">
      <strong>What happens next?</strong><br>
      The EC will review survey responses, identify themes, and follow up on any important issues at the next meeting.
    </div>
  </div>

</div>

<script>
var API = 'https://banfwix.wixsite.com/banf1/_functions';
var surveyData = null;
var answers = {};
var token = '';
var sid = '';

// ── INIT ──────────────────────────────
(async function() {
  var params = new URLSearchParams(window.location.search);
  token = params.get('token') || '';
  sid = params.get('sid') || '';

  if (!token || !sid) {
    showError('Invalid Survey Link', 'This survey link is missing required parameters. Please use the link from your email.');
    return;
  }

  try {
    var res = await fetch(API + '/survey_form_data?token=' + encodeURIComponent(token) + '&sid=' + encodeURIComponent(sid), {
      method: 'GET',
      headers: { 'Content-Type': 'application/json' }
    });
    var data = await res.json();

    if (!data.success) {
      var err = data.error || '';
      if (err.indexOf('Already') >= 0 || err.indexOf('already') >= 0) {
        showError('Already Submitted', 'You have already submitted a response to this survey. Each link can only be used once.');
      } else {
        showError('Survey Unavailable', err || 'This survey is not available. It may be closed or the link may have expired.');
      }
      return;
    }

    surveyData = data;
    renderSurvey(data);
  } catch (e) {
    showError('Connection Error', 'Unable to load survey. Please check your internet connection and try again. (' + e.message + ')');
  }
})();

// ── RENDER ────────────────────────────
function renderSurvey(data) {
  var sv = data.survey || {};
  var questions = data.questions || [];

  document.getElementById('sv-title').textContent = sv.title || 'BANF Survey';
  document.getElementById('sv-desc').textContent = sv.description || '';

  // Event summary box
  var summaryEl = document.getElementById('event-summary');
  if (sv.description) {
    summaryEl.innerHTML = '<strong>About this survey:</strong> ' + escHtml(sv.description);
  } else {
    summaryEl.style.display = 'none';
  }

  var container = document.getElementById('questions-container');
  container.innerHTML = '';

  questions.forEach(function(q, i) {
    // Support both field naming conventions from API
    var qId = q.questionId || q.id || ('q_' + i);
    var qText = q.questionText || q.text || q.question || '';
    var qType = q.answerType || q.type || 'text';
    var isRequired = q.required !== false;

    var card = document.createElement('div');
    card.className = 'q-card' + (qType === 'text' ? ' text-card' : '');
    card.id = 'qcard-' + qId;

    var typeLabel = qType === 'rating_1_5' ? 'Rating (1-5)' :
                    qType === 'rating_1_10' ? 'Rating (1-10)' :
                    qType === 'yes_no' ? 'Yes / No' :
                    qType === 'text' ? 'Free Text' :
                    qType === 'nps' ? 'NPS (0-10)' :
                    qType === 'multiple_choice' ? 'Multiple Choice' : qType;

    var reqLabel = isRequired ? ' &bull; Required' : ' &bull; Optional';
    var label = isRequired ? escHtml(qText) + ' <span class="req-star">*</span>' : escHtml(qText);

    var inputHtml = '';

    if (qType === 'rating_1_5') {
      var labels5 = ['','Very Low','Low','Neutral','High','Very High'];
      inputHtml = '<div class="rating-row" id="rating-' + qId + '">' +
        [1,2,3,4,5].map(function(n) {
          return '<div class="text-center"><button type="button" class="rating-btn" data-qid="' + qId + '" data-val="' + n + '" onclick="selectRating(\'' + qId + '\',' + n + ')">' + n + '</button><div style="font-size:.63rem;color:#999;margin-top:.2rem">' + labels5[n] + '</div></div>';
        }).join('') +
        '</div>';
    } else if (qType === 'rating_1_10') {
      inputHtml = '<div class="rating-row" id="rating-' + qId + '">' +
        [1,2,3,4,5,6,7,8,9,10].map(function(n) {
          return '<button type="button" class="rating-btn" data-qid="' + qId + '" data-val="' + n + '" onclick="selectRating(\'' + qId + '\',' + n + ')">' + n + '</button>';
        }).join('') +
        '</div><div class="small text-muted mt-1" style="font-size:.72rem"><span>1 = Very Dissatisfied</span> &middot; <span>10 = Very Satisfied</span></div>';
    } else if (qType === 'nps') {
      inputHtml = '<div class="rating-row" id="rating-' + qId + '">' +
        [0,1,2,3,4,5,6,7,8,9,10].map(function(n) {
          return '<button type="button" class="rating-btn" data-qid="' + qId + '" data-val="' + n + '" onclick="selectRating(\'' + qId + '\',' + n + ')">' + n + '</button>';
        }).join('') +
        '</div><div class="small text-muted mt-1" style="font-size:.72rem"><span>0 = Not at all likely</span> &middot; <span>10 = Extremely likely</span></div>';
    } else if (qType === 'yes_no') {
      inputHtml = '<div class="yn-row">' +
        '<button type="button" class="yn-btn" id="yn-yes-' + qId + '" onclick="selectYN(\'' + qId + '\',\'yes\')">Yes</button>' +
        '<button type="button" class="yn-btn" id="yn-no-' + qId + '" onclick="selectYN(\'' + qId + '\',\'no\')">No</button>' +
        '</div>';
    } else if (qType === 'multiple_choice' && q.options && q.options.length) {
      inputHtml = '<div class="d-flex flex-column gap-2">' +
        q.options.map(function(opt) {
          return '<button type="button" class="yn-btn" id="mc-' + qId + '-' + opt + '" onclick="selectMC(\'' + qId + '\',\'' + escAttr(opt) + '\')">' + escHtml(opt) + '</button>';
        }).join('') +
        '</div>';
    } else {
      // text / fallback
      inputHtml = '<textarea class="form-control form-control-sm" id="text-' + qId + '" rows="3" placeholder="Your response..." oninput="updateAnswer(\'' + qId + '\',this.value)"></textarea>';
    }

    card.innerHTML = '<div class="q-num">Question ' + (i + 1) + ' of ' + questions.length + ' &bull; ' + typeLabel + reqLabel + '</div>' +
      '<div class="q-text">' + label + '</div>' +
      inputHtml;
    container.appendChild(card);
  });

  updateProgress();
  showState('form');
}

// ── ANSWER HELPERS ────────────────────
function selectRating(qId, val) {
  answers[qId] = val;
  document.querySelectorAll('[data-qid="' + qId + '"]').forEach(function(btn) {
    btn.classList.toggle('selected', parseInt(btn.dataset.val) === val);
  });
  var card = document.getElementById('qcard-' + qId);
  if (card) card.classList.add('answered');
  updateProgress();
}

function selectYN(qId, val) {
  answers[qId] = val;
  document.getElementById('yn-yes-' + qId).className = 'yn-btn' + (val === 'yes' ? ' selected-yes' : '');
  document.getElementById('yn-no-' + qId).className = 'yn-btn' + (val === 'no' ? ' selected-no' : '');
  var card = document.getElementById('qcard-' + qId);
  if (card) card.classList.add('answered');
  updateProgress();
}

function selectMC(qId, val) {
  answers[qId] = val;
  var card = document.getElementById('qcard-' + qId);
  if (card) card.classList.add('answered');
  updateProgress();
}

function updateAnswer(qId, val) {
  if (val && val.trim()) {
    answers[qId] = val.trim();
  } else {
    delete answers[qId];
  }
  updateProgress();
}

function updateProgress() {
  if (!surveyData) return;
  var questions = surveyData.questions || [];
  var total = questions.length;
  var answered = questions.filter(function(q) {
    var qId = q.questionId || q.id || '';
    return answers[qId] !== undefined && answers[qId] !== '';
  }).length;
  var pct = total ? Math.round((answered / total) * 100) : 0;
  document.getElementById('progress-bar').style.width = pct + '%';
  document.getElementById('progress-label').textContent = pct + '%';

  // Enable submit only when all required answered
  var requiredMissing = questions.filter(function(q) {
    if (q.required === false) return false;
    var qId = q.questionId || q.id || '';
    return answers[qId] === undefined || answers[qId] === '';
  });
  var btn = document.getElementById('submit-btn');
  btn.disabled = requiredMissing.length > 0;
  btn.textContent = requiredMissing.length > 0
    ? 'Complete ' + requiredMissing.length + ' required question' + (requiredMissing.length > 1 ? 's' : '') + ' to submit'
    : 'Submit My Responses';
}

// ── SUBMIT ────────────────────────────
async function submitSurvey() {
  var questions = surveyData ? surveyData.questions : [];
  var missing = questions.filter(function(q) {
    if (q.required === false) return false;
    var qId = q.questionId || q.id || '';
    return answers[qId] === undefined || answers[qId] === '';
  });
  if (missing.length) {
    missing.forEach(function(q) {
      var qId = q.questionId || q.id || '';
      var card = document.getElementById('qcard-' + qId);
      if (card) { card.style.borderLeftColor = '#dc3545'; }
    });
    showToast('Please answer all required questions (' + missing.length + ' remaining)');
    return;
  }

  var btn = document.getElementById('submit-btn');
  btn.disabled = true;
  btn.textContent = 'Submitting...';

  // Convert answers dict to array format: [{questionId, answer}]
  var answersArray = [];
  for (var qId in answers) {
    if (answers.hasOwnProperty(qId)) {
      answersArray.push({ questionId: qId, answer: String(answers[qId]) });
    }
  }

  try {
    var res = await fetch(API + '/survey_submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token: token, surveyId: sid, answers: answersArray })
    });
    var data = await res.json();
    if (data.success) {
      showState('thanks');
    } else {
      btn.disabled = false;
      btn.textContent = 'Submit My Responses';
      showToast(data.error || 'Submission failed. Please try again.');
    }
  } catch (e) {
    btn.disabled = false;
    btn.textContent = 'Submit My Responses';
    showToast('Network error. Please check your connection and try again.');
  }
}

// ── HELPERS ───────────────────────────
function showState(state) {
  ['loading', 'error', 'form', 'thanks'].forEach(function(s) {
    document.getElementById('state-' + s).style.display = (s === state) ? '' : 'none';
  });
}

function showError(title, msg) {
  document.getElementById('err-title').textContent = title;
  document.getElementById('err-msg').textContent = msg;
  showState('error');
}

function showToast(msg) {
  var t = document.getElementById('survey-toast');
  if (!t) {
    t = document.createElement('div');
    t.id = 'survey-toast';
    t.style.cssText = 'position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%);background:#dc3545;color:#fff;padding:.6rem 1.5rem;border-radius:20px;font-size:.85rem;z-index:9999;box-shadow:0 4px 16px rgba(0,0,0,.2)';
    document.body.appendChild(t);
  }
  t.textContent = msg;
  t.style.display = '';
  clearTimeout(t._timer);
  t._timer = setTimeout(function() { t.style.display = 'none'; }, 4000);
}

function escHtml(s) {
  var d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function escAttr(s) {
  return s.replace(/'/g, "\\'").replace(/"/g, '&quot;');
}
</script>
</body>
</html>
