<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BANF Membership Drive Workflow</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  :root { --banf:#8B0000; }
  body { background:#f8f5f5; font-family:'Segoe UI',system-ui,sans-serif; }
  .top-bar { background:var(--banf); color:#fff; padding:10px 24px; display:flex; align-items:center; gap:14px; }
  .top-bar h1 { font-size:1.25rem; font-weight:700; margin:0; }
  .top-bar .pill { background:rgba(255,255,255,.18); border-radius:20px; padding:3px 14px; font-size:.8rem; }
  .mode-bar { background:#fff; border-bottom:1px solid #e0c8c8; display:flex; align-items:center; gap:12px; padding:10px 24px; flex-wrap:wrap; }
  .mode-btn { border:2px solid; border-radius:20px; padding:5px 18px; font-size:.82rem; font-weight:600; cursor:pointer; transition:.15s; }
  .mode-demo { border-color:#f59e0b; color:#f59e0b; background:#fff; }
  .mode-demo.active { background:#f59e0b; color:#fff; }
  .mode-live { border-color:#16a34a; color:#16a34a; background:#fff; }
  .mode-live.active { background:#16a34a; color:#fff; }
  .year-badge { background:var(--banf); color:#fff; border-radius:6px; padding:4px 12px; font-size:.8rem; font-weight:700; }
  .step-card { background:#fff; border-radius:10px; border-left:5px solid #ccc; margin-bottom:16px; box-shadow:0 2px 6px rgba(0,0,0,.06); overflow:hidden; transition:.2s; }
  .step-card.pending  { border-left-color:#adb5bd; }
  .step-card.running  { border-left-color:#f59e0b; }
  .step-card.done     { border-left-color:#16a34a; }
  .step-card.skipped  { border-left-color:#6c757d; opacity:.65; }
  .step-card.blocked  { border-left-color:#dc3545; }
  .step-header { display:flex; align-items:center; gap:12px; padding:14px 18px; cursor:pointer; user-select:none; }
  .step-num { width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:.85rem; flex-shrink:0; }
  .pending  .step-num { background:#e9ecef; color:#495057; }
  .running  .step-num { background:#fef3c7; color:#92400e; }
  .done     .step-num { background:#d1fae5; color:#065f46; }
  .skipped  .step-num { background:#e9ecef; color:#6c757d; }
  .blocked  .step-num { background:#fee2e2; color:#991b1b; }
  .step-title { font-weight:700; font-size:.95rem; flex:1; }
  .step-status { font-size:.72rem; font-weight:700; padding:3px 10px; border-radius:12px; letter-spacing:.5px; text-transform:uppercase; }
  .badge-pending  { background:#e9ecef; color:#495057; }
  .badge-running  { background:#fef3c7; color:#92400e; }
  .badge-done     { background:#d1fae5; color:#065f46; }
  .badge-skipped  { background:#e2e8f0; color:#64748b; }
  .badge-blocked  { background:#fee2e2; color:#991b1b; }
  .step-body { padding:0 18px 16px 60px; display:none; }
  .step-body.open { display:block; }
  .step-desc { font-size:.85rem; color:#555; margin-bottom:12px; }
  .step-actions { display:flex; gap:8px; flex-wrap:wrap; }
  .btn-auto { background:#16a34a; color:#fff; border:none; border-radius:6px; padding:6px 18px; font-size:.84rem; font-weight:600; cursor:pointer; }
  .btn-auto:disabled { background:#9ca3af; cursor:not-allowed; }
  .btn-manual { background:#f59e0b; color:#fff; border:none; border-radius:6px; padding:6px 18px; font-size:.84rem; font-weight:600; cursor:pointer; }
  .btn-skip { background:#6c757d; color:#fff; border:none; border-radius:6px; padding:6px 14px; font-size:.84rem; cursor:pointer; }
  .btn-redo { background:#0d6efd; color:#fff; border:none; border-radius:6px; padding:6px 14px; font-size:.84rem; cursor:pointer; }
  .log-box { background:#111; color:#0f0; font-size:.78rem; font-family:'Consolas',monospace; border-radius:6px; padding:10px 14px; max-height:180px; overflow-y:auto; margin-top:10px; display:none; }
  .log-box.show { display:block; }
  .progress-bar-wrap { background:#e9ecef; border-radius:6px; height:8px; margin:0 24px 14px; }
  .progress-inner { background:var(--banf); height:8px; border-radius:6px; transition:width .5s; }
  .notice-demo { background:#fef3c7; border:1px solid #fcd34d; border-radius:8px; padding:10px 16px; font-size:.83rem; color:#78350f; margin:0 0 18px; }
  .notice-live { background:#d1fae5; border:1px solid #6ee7b7; border-radius:8px; padding:10px 16px; font-size:.83rem; color:#065f46; margin:0 0 18px; }
</style>
</head>
<body>

<div class="top-bar">
  <i class="fas fa-project-diagram"></i>
  <h1>Membership Drive Workflow</h1>
  <span class="pill">8 Steps</span>
  <span class="year-badge ms-1">FY2026-27</span>
  <a href="https://banfwix.wixsite.com/banf1/_functions/admin_portal" class="btn btn-sm ms-auto" style="background:rgba(255,255,255,.15);color:#fff;border:1px solid rgba(255,255,255,.3)">
    <i class="fas fa-arrow-left me-1"></i>Admin Portal
  </a>
</div>

<!-- Mode + year bar -->
<div class="mode-bar">
  <div>
    <span class="text-muted small me-2">Membership Year:</span>
    <input type="text" value="FY2026-27" readonly title="Only current year is supported" style="border:1px solid #ccc;border-radius:6px;padding:3px 10px;font-size:.85rem;font-weight:700;color:#8B0000;width:110px;text-align:center">
  </div>
  <div class="ms-4">
    <span class="text-muted small me-2">Mode:</span>
    <button class="mode-btn mode-demo active" id="btnDemo" onclick="setMode('demo')"><i class="fas fa-flask me-1"></i>Demo</button>
    <button class="mode-btn mode-live ms-1" id="btnLive" onclick="setMode('live')"><i class="fas fa-satellite me-1"></i>Live</button>
  </div>
  <div class="ms-auto">
    <span class="text-muted small me-2">Overall:</span>
    <span id="overall-pct" class="fw-bold">0%</span>
    <span class="text-muted small ms-2" id="overall-label">0 / 8 steps</span>
  </div>
</div>

<div class="container-fluid" style="max-width:860px;padding:24px">

  <div id="notice-demo" class="notice-demo">
    <i class="fas fa-flask me-2"></i><strong>Demo Mode:</strong> All actions simulate API calls without affecting live data. Complete all 8 steps in Demo mode first before switching to Live.
  </div>
  <div id="notice-live" class="notice-live" style="display:none">
    <i class="fas fa-satellite me-2"></i><strong>Live Mode:</strong> Actions will call real APIs and affect live Wix data. Proceed carefully.
  </div>

  <div class="progress-bar-wrap">
    <div class="progress-inner" id="progress-bar" style="width:0%"></div>
  </div>

  <!-- Step 1: Configure Tiers -->
  <div class="step-card pending" id="step-1" data-step="1">
    <div class="step-header" onclick="toggleStep(1)">
      <div class="step-num">1</div>
      <div class="step-title">Configure Membership Tiers</div>
      <span class="step-status badge-pending" id="status-1">Pending</span>
      <i class="fas fa-chevron-down ms-2 text-muted" id="chevron-1"></i>
    </div>
    <div class="step-body" id="body-1">
      <div class="step-desc">Review and confirm the 7 membership tiers (from PPTX): Individual, Family, Student, Senior, Patron, Corporate, Lifetime. Manage in the Membership Admin panel.</div>
      <div class="step-actions">
        <button class="btn-auto" id="auto-1" onclick="runStep(1,'auto')"><i class="fas fa-bolt me-1"></i>Auto: Pull Current Config</button>
        <button class="btn-manual" onclick="runStep(1,'manual')"><i class="fas fa-hand-pointer me-1"></i>Manual: Open Admin Config</button>
        <button class="btn-skip" onclick="skipStep(1)"><i class="fas fa-forward me-1"></i>Skip</button>
      </div>
      <div class="log-box" id="log-1"></div>
    </div>
  </div>

  <!-- Step 2: Build Universe Pool -->
  <div class="step-card pending" id="step-2" data-step="2">
    <div class="step-header" onclick="toggleStep(2)">
      <div class="step-num">2</div>
      <div class="step-title">Build Member Universe Pool</div>
      <span class="step-status badge-pending" id="status-2">Pending</span>
      <i class="fas fa-chevron-down ms-2 text-muted" id="chevron-2"></i>
    </div>
    <div class="step-body" id="body-2">
      <div class="step-desc">Define the target pool of contacts who will be invited to join this year. Includes new contacts + prior members. Fetches from MembershipUniverse collection.</div>
      <div class="step-actions">
        <button class="btn-auto" id="auto-2" onclick="runStep(2,'auto')"><i class="fas fa-bolt me-1"></i>Auto: Fetch Universe</button>
        <button class="btn-manual" onclick="runStep(2,'manual')"><i class="fas fa-hand-pointer me-1"></i>Manual: Open Universe Manager</button>
        <button class="btn-skip" onclick="skipStep(2)"><i class="fas fa-forward me-1"></i>Skip</button>
      </div>
      <div class="log-box" id="log-2"></div>
    </div>
  </div>

  <!-- Step 3: Initialize Drive -->
  <div class="step-card pending" id="step-3" data-step="3">
    <div class="step-header" onclick="toggleStep(3)">
      <div class="step-num">3</div>
      <div class="step-title">Initialize Drive</div>
      <span class="step-status badge-pending" id="status-3">Pending</span>
      <i class="fas fa-chevron-down ms-2 text-muted" id="chevron-3"></i>
    </div>
    <div class="step-body" id="body-3">
      <div class="step-desc">Creates the drive record in WixData (MembershipDrive collection). Sets status to <strong>active</strong>. Cannot reinitialize an active drive.</div>
      <div class="step-actions">
        <button class="btn-auto" id="auto-3" onclick="runStep(3,'auto')"><i class="fas fa-bolt me-1"></i>Auto: POST /membership_drive_init</button>
        <button class="btn-manual" onclick="runStep(3,'manual')"><i class="fas fa-hand-pointer me-1"></i>Manual: Describe</button>
        <button class="btn-skip" onclick="skipStep(3)"><i class="fas fa-forward me-1"></i>Skip</button>
      </div>
      <div class="log-box" id="log-3"></div>
    </div>
  </div>

  <!-- Step 4: Send Invitations -->
  <div class="step-card pending" id="step-4" data-step="4">
    <div class="step-header" onclick="toggleStep(4)">
      <div class="step-num">4</div>
      <div class="step-title">Send Invitations</div>
      <span class="step-status badge-pending" id="status-4">Pending</span>
      <i class="fas fa-chevron-down ms-2 text-muted" id="chevron-4"></i>
    </div>
    <div class="step-body" id="body-4">
      <div class="step-desc">
        <strong>Demo:</strong> emails sent to demo group only (adminEmail + 2 test contacts).<br>
        <strong>Live:</strong> emails sent to full universe pool. Uses <code>/membership_drive_notify</code>.
      </div>
      <div class="mb-3 mt-2">
        <label class="form-label small fw-semibold">Custom Email Subject (optional)</label>
        <input type="text" class="form-control form-control-sm" id="invite-subject" placeholder="You're invited to join BANF FY2026-27!">
      </div>
      <div class="step-actions">
        <button class="btn-auto" id="auto-4" onclick="runStep(4,'auto')"><i class="fas fa-bolt me-1"></i>Auto: Send Now</button>
        <button class="btn-manual" onclick="runStep(4,'manual')"><i class="fas fa-hand-pointer me-1"></i>Manual: Preview Email</button>
        <button class="btn-skip" onclick="skipStep(4)"><i class="fas fa-forward me-1"></i>Skip</button>
      </div>
      <div class="log-box" id="log-4"></div>
    </div>
  </div>

  <!-- Step 5: Monitor Registrations -->
  <div class="step-card pending" id="step-5" data-step="5">
    <div class="step-header" onclick="toggleStep(5)">
      <div class="step-num">5</div>
      <div class="step-title">Monitor Registrations</div>
      <span class="step-status badge-pending" id="status-5">Pending</span>
      <i class="fas fa-chevron-down ms-2 text-muted" id="chevron-5"></i>
    </div>
    <div class="step-body" id="body-5">
      <div class="step-desc">Live dashboard of who has registered. Auto-refreshes every 30 seconds. Reviews counts by tier and payment status.</div>
      <div id="monitor-panel" style="display:none">
        <div class="row g-3 mb-3 mt-1">
          <div class="col-6 col-md-3"><div class="text-center border rounded p-2"><div class="fs-4 fw-bold" id="stat-total">â€”</div><div class="small text-muted">Total Registrations</div></div></div>
          <div class="col-6 col-md-3"><div class="text-center border rounded p-2"><div class="fs-4 fw-bold text-success" id="stat-paid">â€”</div><div class="small text-muted">Confirmed Paid</div></div></div>
          <div class="col-6 col-md-3"><div class="text-center border rounded p-2"><div class="fs-4 fw-bold text-warning" id="stat-pending">â€”</div><div class="small text-muted">Pending Payment</div></div></div>
          <div class="col-6 col-md-3"><div class="text-center border rounded p-2"><div class="fs-4 fw-bold text-secondary" id="stat-universe">â€”</div><div class="small text-muted">Universe Size</div></div></div>
        </div>
      </div>
      <div class="step-actions">
        <button class="btn-auto" id="auto-5" onclick="runStep(5,'auto')"><i class="fas fa-sync me-1"></i>Auto: Start Live Monitor</button>
        <button class="btn-manual" onclick="runStep(5,'manual')"><i class="fas fa-hand-pointer me-1"></i>Manual: Open Registrations</button>
        <button class="btn-skip" onclick="skipStep(5)"><i class="fas fa-forward me-1"></i>Skip</button>
      </div>
      <div class="log-box" id="log-5"></div>
    </div>
  </div>

  <!-- Step 6: Confirm Payments -->
  <div class="step-card pending" id="step-6" data-step="6">
    <div class="step-header" onclick="toggleStep(6)">
      <div class="step-num">6</div>
      <div class="step-title">Confirm Payments</div>
      <span class="step-status badge-pending" id="status-6">Pending</span>
      <i class="fas fa-chevron-down ms-2 text-muted" id="chevron-6"></i>
    </div>
    <div class="step-body" id="body-6">
      <div class="step-desc">Review registrations with <code>pending</code> payment status. EC treasurer confirms Zelle/cash receipts and marks each as <strong>confirmed</strong>.</div>
      <div id="payments-panel" style="display:none">
        <div class="table-responsive mt-2 mb-3" style="max-height:200px;overflow-y:auto">
          <table class="table table-sm table-hover small mb-0">
            <thead class="table-light"><tr><th>Name</th><th>Tier</th><th>Amount</th><th>Status</th><th>Action</th></tr></thead>
            <tbody id="payments-tbody"></tbody>
          </table>
        </div>
      </div>
      <div class="step-actions">
        <button class="btn-auto" id="auto-6" onclick="runStep(6,'auto')"><i class="fas fa-bolt me-1"></i>Auto: Load Pending</button>
        <button class="btn-manual" onclick="runStep(6,'manual')"><i class="fas fa-hand-pointer me-1"></i>Manual: Open Payments Page</button>
        <button class="btn-skip" onclick="skipStep(6)"><i class="fas fa-forward me-1"></i>Skip</button>
      </div>
      <div class="log-box" id="log-6"></div>
    </div>
  </div>

  <!-- Step 7: Generate Report -->
  <div class="step-card pending" id="step-7" data-step="7">
    <div class="step-header" onclick="toggleStep(7)">
      <div class="step-num">7</div>
      <div class="step-title">Generate Membership Report</div>
      <span class="step-status badge-pending" id="status-7">Pending</span>
      <i class="fas fa-chevron-down ms-2 text-muted" id="chevron-7"></i>
    </div>
    <div class="step-body" id="body-7">
      <div class="step-desc">Exports all registrations as a CSV with tier breakdown, payment status, and timestamps. Download and archive for BANF records.</div>
      <div class="step-actions">
        <button class="btn-auto" id="auto-7" onclick="runStep(7,'auto')"><i class="fas fa-bolt me-1"></i>Auto: Generate + Download CSV</button>
        <button class="btn-manual" onclick="runStep(7,'manual')"><i class="fas fa-hand-pointer me-1"></i>Manual: Compose in Portal</button>
        <button class="btn-skip" onclick="skipStep(7)"><i class="fas fa-forward me-1"></i>Skip</button>
      </div>
      <div class="log-box" id="log-7"></div>
    </div>
  </div>

  <!-- Step 8: Close Drive -->
  <div class="step-card pending" id="step-8" data-step="8">
    <div class="step-header" onclick="toggleStep(8)">
      <div class="step-num">8</div>
      <div class="step-title">Close Drive</div>
      <span class="step-status badge-pending" id="status-8">Pending</span>
      <i class="fas fa-chevron-down ms-2 text-muted" id="chevron-8"></i>
    </div>
    <div class="step-body" id="body-8">
      <div class="step-desc">Marks the drive as <strong>closed</strong>. New registrations will be rejected after this point. This action is reversible only by EC admin.</div>
      <div class="alert alert-danger py-2 small mt-2 mb-3"><i class="fas fa-exclamation-triangle me-1"></i>In Live mode, this permanently closes registrations for FY2026-27.</div>
      <div class="step-actions">
        <button class="btn-auto" id="auto-8" onclick="runStep(8,'auto')"><i class="fas fa-bolt me-1"></i>Auto: POST drive_control stop</button>
        <button class="btn-manual" onclick="runStep(8,'manual')"><i class="fas fa-hand-pointer me-1"></i>Manual: Confirm Close</button>
        <button class="btn-skip" onclick="skipStep(8)"><i class="fas fa-forward me-1"></i>Skip</button>
      </div>
      <div class="log-box" id="log-8"></div>
    </div>
  </div>

  <!-- Completion banner -->
  <div id="completion-banner" class="text-center py-4 mt-2" style="display:none">
    <div style="font-size:3rem">ðŸŽ‰</div>
    <h4 class="fw-bold mt-2 text-success">All Steps Complete!</h4>
    <p class="text-muted" id="completion-msg">Membership Drive workflow finished in Demo mode. Switch to Live mode to run against real data.</p>
    <div class="d-flex gap-3 justify-content-center mt-3">
      <button class="btn btn-outline-secondary" onclick="resetWorkflow()"><i class="fas fa-redo me-1"></i>Reset Workflow</button>
      <a href="https://banfwix.wixsite.com/banf1/_functions/admin_portal" class="btn" style="background:#8B0000;color:#fff"><i class="fas fa-arrow-left me-1"></i>Back to Admin Portal</a>
    </div>
  </div>

</div><!-- /container -->

<script>
const API   = 'https://banfwix.wixsite.com/banf1/_functions';
const YEAR  = 'FY2026-27';
const TOTAL = 8;
let mode    = 'demo';
let steps   = {}; // { 1: 'pending'|'running'|'done'|'skipped' }
let demoComplete = false;

// Read auth from localStorage (set by admin-portal.html login)
function getHeaders() {
  const email = localStorage.getItem('banfAdminEmail') || '';
  const token = localStorage.getItem('banfAdminToken') || '';
  return { 'Content-Type': 'application/json', 'x-admin-email': email, 'x-admin-token': token };
}

function setMode(m) {
  if (m === 'live' && !demoComplete) {
    alert('Please complete all steps in Demo mode first before switching to Live.');
    return;
  }
  mode = m;
  document.getElementById('btnDemo').classList.toggle('active', m === 'demo');
  document.getElementById('btnLive').classList.toggle('active', m === 'live');
  document.getElementById('notice-demo').style.display = m === 'demo' ? '' : 'none';
  document.getElementById('notice-live').style.display = m === 'live' ? '' : 'none';
  // Reset steps for new mode
  for (let i = 1; i <= TOTAL; i++) setStepState(i, 'pending');
  updateProgress();
}

function toggleStep(n) {
  const body = document.getElementById('body-' + n);
  const chev = document.getElementById('chevron-' + n);
  const isOpen = body.classList.contains('open');
  body.classList.toggle('open', !isOpen);
  chev.style.transform = isOpen ? '' : 'rotate(180deg)';
}

function setStepState(n, state) {
  steps[n] = state;
  const card = document.getElementById('step-' + n);
  const badge = document.getElementById('status-' + n);
  card.className = `step-card ${state}`;
  badge.className = `step-status badge-${state}`;
  badge.textContent = state.charAt(0).toUpperCase() + state.slice(1);
}

function appendLog(n, msg, type='info') {
  const box = document.getElementById('log-' + n);
  box.classList.add('show');
  const color = type === 'error' ? '#f87171' : type === 'success' ? '#4ade80' : '#0f0';
  box.innerHTML += `<div style="color:${color}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
  box.scrollTop = box.scrollHeight;
}

function updateProgress() {
  const done = Object.values(steps).filter(s => s === 'done' || s === 'skipped').length;
  const pct  = Math.round((done / TOTAL) * 100);
  document.getElementById('progress-bar').style.width = pct + '%';
  document.getElementById('overall-pct').textContent = pct + '%';
  document.getElementById('overall-label').textContent = `${done} / ${TOTAL} steps`;
  if (done === TOTAL) {
    document.getElementById('completion-banner').style.display = '';
    if (mode === 'demo') {
      demoComplete = true;
      document.getElementById('completion-msg').textContent = 'All 8 steps finished in Demo mode. You can now switch to Live mode to run against real data.';
    } else {
      document.getElementById('completion-msg').textContent = 'Membership Drive for FY2026-27 is now complete! Download your report and archive it.';
    }
  }
}

async function runStep(n, type) {
  setStepState(n, 'running');
  const logN = n;
  appendLog(logN, `${mode.toUpperCase()} mode â€” running Step ${n} (${type === 'auto' ? 'automated' : 'manual'})...`);

  try {
    if (mode === 'demo') {
      await simulateStep(n, type);
    } else {
      await executeStep(n, type);
    }
    setStepState(n, 'done');
    appendLog(logN, `Step ${n} completed successfully.`, 'success');
    // Auto-open next step
    if (n < TOTAL) setTimeout(() => toggleStep(n + 1), 300);
  } catch(e) {
    setStepState(n, 'blocked');
    appendLog(logN, `Error: ${e.message}`, 'error');
  }
  updateProgress();
}

function skipStep(n) {
  setStepState(n, 'skipped');
  appendLog(n, `Step ${n} skipped by admin.`);
  if (n < TOTAL) setTimeout(() => toggleStep(n + 1), 200);
  updateProgress();
}

// â”€â”€ Demo simulations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function simulateStep(n, type) {
  await delay(900);
  const demos = {
    1: () => appendLog(n, 'CONFIG PULLED: 7 tiers found â€” Individual ($50), Family ($80), Student ($20), Senior ($30), Patron ($150), Corporate ($500), Lifetime ($1000)', 'success'),
    2: () => appendLog(n, 'UNIVERSE LOADED: 42 contacts in demo pool (3 test contacts active)', 'success'),
    3: () => appendLog(n, 'DRIVE INITIALIZED: driveId=DEMO-FY2026-27 | status=active | invitesScheduled=false', 'success'),
    4: () => { const subj = document.getElementById('invite-subject').value || 'Invitation: Join BANF FY2026-27'; appendLog(n, `EMAILS SENT (DEMO): subject="${subj}" | recipients=3 demo contacts | status=queued`, 'success'); },
    5: () => { document.getElementById('monitor-panel').style.display=''; document.getElementById('stat-total').textContent='3'; document.getElementById('stat-paid').textContent='1'; document.getElementById('stat-pending').textContent='2'; document.getElementById('stat-universe').textContent='42'; appendLog(n, 'MONITOR: 3 registrations | 1 confirmed | 2 pending payment', 'success'); },
    6: () => {
      const tb = document.getElementById('payments-tbody');
      document.getElementById('payments-panel').style.display='';
      tb.innerHTML = ['Alice Demo,$50,pending','Bob Demo,$80,pending'].map(r => { const [nm,amt,st]=r.split(','); return `<tr><td>${nm}</td><td>Individual</td><td>${amt}</td><td><span class="badge bg-warning text-dark">${st}</span></td><td><button onclick="this.closest('tr').style.opacity='.4'" style="font-size:.75rem" class="btn btn-sm btn-success">âœ“ Confirm</button></td></tr>`; }).join('');
      appendLog(n, 'PAYMENTS LOADED: 2 pending | click Confirm to mark each', 'success');
    },
    7: () => { downloadCSV(getDemoCSV(), 'BANF_MembershipDrive_FY2026-27_DEMO.csv'); appendLog(n, 'CSV GENERATED: 3 records | downloaded to browser', 'success'); },
    8: () => appendLog(n, 'DRIVE CLOSED (DEMO): status=closed | driveId=DEMO-FY2026-27 | no live data affected', 'success'),
  };
  if (type === 'manual') {
    appendLog(n, manualInstructions(n));
    return;
  }
  if (demos[n]) demos[n]();
}

// â”€â”€ Live execution â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function executeStep(n, type) {
  if (type === 'manual') { appendLog(n, manualInstructions(n)); return; }
  const h = getHeaders();

  if (n === 1) {
    const r = await fetch(`${API}/membership_config`, { headers: h });
    const d = await r.json();
    if (!d.success) throw new Error(d.message || 'Config fetch failed');
    appendLog(n, `CONFIG: ${d.tiers?.length || 0} tiers loaded`, 'success');
  } else if (n === 2) {
    const r = await fetch(`${API}/membership_universe`, { headers: h });
    const d = await r.json();
    appendLog(n, `UNIVERSE: ${d.count || 0} contacts`, 'success');
  } else if (n === 3) {
    const r = await fetch(`${API}/membership_drive_init`, { method:'POST', headers: h, body: JSON.stringify({ year: YEAR }) });
    const d = await r.json();
    if (!d.success) throw new Error(d.message);
    appendLog(n, `DRIVE ID: ${d.driveId}`, 'success');
  } else if (n === 4) {
    const subj = document.getElementById('invite-subject').value;
    const r = await fetch(`${API}/membership_drive_notify`, { method:'POST', headers: h, body: JSON.stringify({ year: YEAR, subject: subj || undefined }) });
    const d = await r.json();
    if (!d.success) throw new Error(d.message);
    appendLog(n, `INVITATIONS: ${d.sent || 0} emails sent`, 'success');
  } else if (n === 5) {
    const r = await fetch(`${API}/membership_drive_status?year=${YEAR}`, { headers: h });
    const d = await r.json();
    document.getElementById('monitor-panel').style.display='';
    document.getElementById('stat-total').textContent = d.total || 0;
    document.getElementById('stat-paid').textContent = d.confirmed || 0;
    document.getElementById('stat-pending').textContent = d.pending || 0;
    document.getElementById('stat-universe').textContent = d.universe || 0;
    appendLog(n, `STATUS: ${d.total} registrations | ${d.confirmed} confirmed`, 'success');
  } else if (n === 6) {
    const r = await fetch(`${API}/membership_registrations?year=${YEAR}&payment_status=pending`, { headers: h });
    const d = await r.json();
    document.getElementById('payments-panel').style.display='';
    document.getElementById('payments-tbody').innerHTML = (d.items || []).slice(0,20).map(p =>
      `<tr><td>${p.name||p.email}</td><td>${p.tier||''}</td><td>$${p.amount||'?'}</td><td><span class="badge bg-warning text-dark">pending</span></td><td><button onclick="confirmPayment('${p._id}',this)" style="font-size:.75rem" class="btn btn-sm btn-success">âœ“ Confirm</button></td></tr>`
    ).join('');
    appendLog(n, `${(d.items||[]).length} pending payments loaded`, 'success');
  } else if (n === 7) {
    const r = await fetch(`${API}/membership_registrations?year=${YEAR}`, { headers: h });
    const d = await r.json();
    const rows = (d.items||[]).map(p => [p.name||'',p.email||'',p.tier||'',p.amount||'',p.paymentStatus||'',p._createdDate||''].join(',')).join('\n');
    const csv = 'Name,Email,Tier,Amount,PaymentStatus,Date\n' + rows;
    downloadCSV(csv, `BANF_MembershipDrive_${YEAR}.csv`);
    appendLog(n, `CSV: ${(d.items||[]).length} records exported`, 'success');
  } else if (n === 8) {
    const r = await fetch(`${API}/membership_drive_control`, { method:'POST', headers: h, body: JSON.stringify({ action:'stop', year: YEAR }) });
    const d = await r.json();
    if (!d.success) throw new Error(d.message);
    appendLog(n, `DRIVE CLOSED: ${d.message}`, 'success');
  }
}

async function confirmPayment(id, btn) {
  try {
    const h = getHeaders();
    const r = await fetch(`${API}/membership_confirm_payment`, { method:'POST', headers: h, body: JSON.stringify({ registrationId: id }) });
    const d = await r.json();
    if (d.success) { btn.textContent='âœ“ Done'; btn.disabled=true; btn.closest('tr').style.opacity='.5'; }
  } catch(e) { alert('Confirm failed: ' + e.message); }
}

function manualInstructions(n) {
  const instr = {
    1: 'Open Membership Admin â†’ Config tab â†’ review all 7 tiers, then return here.',
    2: 'Open Membership Admin â†’ Universe tab â†’ import/add contacts, then return here.',
    3: 'Contact Wix backend team to manually create MembershipDrive record for FY2026-27.',
    4: 'Open Admin Portal â†’ Automation â†’ Queue invite emails manually.',
    5: 'Open Admin Portal â†’ Members â†’ filter by FY2026-27.',
    6: 'Open Admin Portal â†’ Payments â†’ confirm each Zelle receipt manually.',
    7: 'Open Admin Portal â†’ Reports â†’ export membership CSV.',
    8: 'Open Membership Admin â†’ Drive tab â†’ click "Close Drive" button.',
  };
  return 'MANUAL INSTRUCTIONS: ' + (instr[n] || 'Perform this step manually in the admin portal.');
}

function getDemoCSV() {
  return `Name,Email,Tier,Amount,PaymentStatus,Date\nAlice Demo,alice@demo.com,Individual,$50,confirmed,2025-01-15\nBob Demo,bob@demo.com,Family,$80,pending,2025-01-16\nCarol Demo,carol@demo.com,Student,$20,confirmed,2025-01-17`;
}

function downloadCSV(csv, filename) {
  const blob = new Blob([csv], { type: 'text/csv' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

function resetWorkflow() {
  for (let i = 1; i <= TOTAL; i++) {
    setStepState(i, 'pending');
    document.getElementById('log-' + i).innerHTML = '';
    document.getElementById('log-' + i).classList.remove('show');
    document.getElementById('body-' + i).classList.remove('open');
    document.getElementById('chevron-' + i).style.transform = '';
  }
  document.getElementById('completion-banner').style.display = 'none';
  updateProgress();
}

function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

// Init
(function() {
  for (let i = 1; i <= TOTAL; i++) steps[i] = 'pending';
  updateProgress();
  toggleStep(1); // open first step
})();
</script>
</body>
</html>
