<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Member Portal â€” Bengali Association of North Florida</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--banf-orange:#FF6B35;--banf-red:#8B0000;--banf-gold:#D4AF37;--grad:linear-gradient(135deg,#FF6B35,#8B0000)}
*{font-family:'Poppins',sans-serif;box-sizing:border-box}
body{background:#f5f7fa;margin:0}
.member-header{background:var(--grad);color:#fff;padding:.75rem 1.5rem;position:sticky;top:0;z-index:1000;box-shadow:0 4px 16px rgba(139,0,0,.35);display:flex;justify-content:space-between;align-items:center}
.member-header h1{font-size:1.05rem;margin:0;font-weight:600}
#login-wall{display:flex;align-items:center;justify-content:center;min-height:85vh;padding:1rem}
#login-wall .card{width:360px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.12)}
.sidebar{width:220px;min-height:calc(100vh - 58px);background:#fff;border-right:1px solid #e8e8e8;position:fixed;top:58px;left:0;overflow-y:auto;padding:.5rem 0}
.sidebar .nav-link{color:#555;padding:.5rem 1.2rem;font-size:.84rem;display:flex;align-items:center;gap:.6rem}
.sidebar .nav-link:hover,.sidebar .nav-link.active{background:#fff3ee;color:var(--banf-orange);font-weight:600}
.main-content{margin-left:220px;padding:1.5rem;min-height:calc(100vh - 58px)}
.section{display:none}
.section.active{display:block}
.stat-card{background:#fff;border-radius:12px;padding:1.1rem;box-shadow:0 2px 8px rgba(0,0,0,.07);margin-bottom:1rem;border-left:4px solid var(--banf-orange)}
.stat-card .num{font-size:1.8rem;font-weight:700;color:var(--banf-red)}
.stat-card .lbl{color:#999;font-size:.75rem;text-transform:uppercase;letter-spacing:.5px}
.btn-banf{background:var(--grad);color:#fff;border:none;border-radius:8px;padding:.4rem 1rem;font-size:.85rem}
.btn-banf:hover{opacity:.88;color:#fff}
.tbl-wrap{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.07);overflow:auto}
table thead{background:#fff3ee}
table thead th{color:var(--banf-red);font-size:.78rem;font-weight:600;text-transform:uppercase;letter-spacing:.4px}
.section-title{font-size:1.2rem;font-weight:700;color:var(--banf-red);margin-bottom:1.2rem;padding-bottom:.5rem;border-bottom:2px solid #fff3ee}
.profile-avatar{width:80px;height:80px;border-radius:50%;background:var(--grad);color:#fff;font-size:2rem;display:flex;align-items:center;justify-content:center;font-weight:700}
.event-card{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.07);overflow:hidden;height:100%}
.event-card .ev-header{background:var(--grad);color:#fff;padding:.8rem 1rem}
.event-card .ev-body{padding:1rem}
.chat-window{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.07);height:420px;display:flex;flex-direction:column}
.chat-messages{flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:.5rem}
.chat-msg{max-width:78%;padding:.5rem .85rem;border-radius:12px;font-size:.85rem}
.chat-msg.user{background:#fff3ee;color:#333;align-self:flex-end;border-bottom-right-radius:4px}
.chat-msg.bot{background:#f8e8e8;color:#333;align-self:flex-start;border-bottom-left-radius:4px}
.chat-input{padding:.75rem 1rem;border-top:1px solid #f0f0f0;display:flex;gap:.5rem}
.badge-status-active{background:#d4edda;color:#155724}
.badge-status-pending{background:#fff3cd;color:#856404}
.badge-status-inactive{background:#f8d7da;color:#721c24}
.badge-status-open{background:#cfe2ff;color:#084298}
.badge-status-resolved{background:#d4edda;color:#155724}
.toast-area{position:fixed;top:70px;right:20px;z-index:9999;width:290px}
.dir-member{background:#fff;border-radius:10px;padding:.75rem 1rem;box-shadow:0 2px 6px rgba(0,0,0,.07);margin-bottom:.5rem}
@media(max-width:768px){.sidebar{display:none}.main-content{margin-left:0}}
</style>
</head>
<body>

<!-- HEADER -->
<div class="member-header" id="header" style="display:none">
  <h1><i class="fas fa-lotus me-2"></i>BANF Member Portal</h1>
  <div class="d-flex align-items-center gap-3">
    <span id="hdr-name" style="font-size:.85rem;font-weight:500"></span>
    <button class="btn btn-sm btn-outline-light" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
  </div>
</div>

<!-- LOGIN -->
<div id="login-wall">
  <div class="card p-4">
    <div class="text-center mb-4">
      <div style="font-size:2.5rem;color:var(--banf-orange)"><i class="fas fa-user-circle"></i></div>
      <h5 class="mt-2 mb-0">Member Portal</h5>
      <small class="text-muted">Bengali Association of North Florida</small>
    </div>
    <div class="mb-3">
      <label class="form-label small">Email Address</label>
      <input type="email" class="form-control" id="login-email" placeholder="your@email.com" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <button class="btn btn-banf w-100" onclick="doLogin()"><i class="fas fa-sign-in-alt me-2"></i>Sign In</button>
    <div id="login-err" class="text-danger small mt-2" style="display:none"></div>
    <div class="text-center mt-3">
      <a href="join.html" class="small text-muted">Not a member? <strong>Join BANF</strong></a>
    </div>
  </div>
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar" style="display:none">
  <a class="nav-link active" href="#" onclick="show('dashboard',this)"><i class="fas fa-home fa-fw"></i>Dashboard</a>
  <a class="nav-link" href="#" onclick="show('profile',this)"><i class="fas fa-user fa-fw"></i>My Profile</a>
  <a class="nav-link" href="#" onclick="show('events',this)"><i class="fas fa-calendar fa-fw"></i>Events</a>
  <a class="nav-link" href="#" onclick="show('payments',this)"><i class="fas fa-receipt fa-fw"></i>My Payments</a>
  <a class="nav-link" href="#" onclick="show('surveys',this)"><i class="fas fa-poll fa-fw"></i>Surveys</a>
  <a class="nav-link" href="#" onclick="show('complaints',this)"><i class="fas fa-comment-alt fa-fw"></i>Feedback</a>
  <a class="nav-link" href="#" onclick="show('directory',this)"><i class="fas fa-address-book fa-fw"></i>Directory</a>
  <a class="nav-link" href="#" onclick="show('chat',this)"><i class="fas fa-robot fa-fw"></i>AI Assistant</a>
</div>

<!-- MAIN -->
<div class="main-content" id="main-content" style="display:none">

  <!-- DASHBOARD -->
  <div id="sec-dashboard" class="section active">
    <div class="section-title"><i class="fas fa-home me-2"></i>Welcome Back!</div>
    <div class="row g-3" id="dash-welcome">
      <div class="col-md-3"><div class="stat-card" id="dash-membership-card">
        <div class="num" id="dash-mem-type">â€”</div><div class="lbl">Membership</div>
      </div></div>
      <div class="col-md-3"><div class="stat-card" style="border-color:#D4AF37">
        <div class="num text-warning" id="dash-paid-total">â€”</div><div class="lbl">Total Paid</div>
      </div></div>
      <div class="col-md-3"><div class="stat-card" style="border-color:#28a745">
        <div class="num text-success" id="dash-events-count">â€”</div><div class="lbl">Upcoming Events</div>
      </div></div>
      <div class="col-md-3"><div class="stat-card" style="border-color:#17a2b8">
        <div class="num text-info" id="dash-surveys-count">â€”</div><div class="lbl">Pending Surveys</div>
      </div></div>
    </div>
    <div class="row g-3 mt-1">
      <div class="col-md-6" id="dash-next-event-wrap" style="display:none">
        <div class="card p-3 border-0 shadow-sm">
          <div class="small text-muted fw-bold mb-2 text-uppercase">NEXT EVENT</div>
          <div id="dash-next-event"></div>
        </div>
      </div>
      <div class="col-md-6" id="dash-survey-wrap" style="display:none">
        <div class="card p-3 border-0 shadow-sm">
          <div class="small text-muted fw-bold mb-2 text-uppercase">OPEN SURVEYS</div>
          <div id="dash-open-surveys"></div>
        </div>
      </div>
    </div>
    <div class="mt-3 p-3 bg-white rounded shadow-sm" id="dash-announcements" style="display:none">
      <div class="small text-muted fw-bold mb-2">ANNOUNCEMENTS</div>
      <div id="dash-ann-content"></div>
    </div>
  </div>

  <!-- PROFILE -->
  <div id="sec-profile" class="section">
    <div class="section-title"><i class="fas fa-user me-2"></i>My Profile</div>
    <div class="row g-3">
      <div class="col-md-4">
        <div class="card p-3 text-center border-0 shadow-sm">
          <div class="d-flex justify-content-center mb-3"><div class="profile-avatar" id="profile-avatar">?</div></div>
          <h5 id="profile-name" class="fw-bold mb-0">Loadingâ€¦</h5>
          <div class="text-muted small" id="profile-email"></div>
          <span class="badge mt-2" id="profile-badge" style="background:var(--grad)">Member</span>
        </div>
      </div>
      <div class="col-md-8">
        <div class="card p-3 border-0 shadow-sm">
          <h6 class="fw-bold text-danger mb-3">Profile Details</h6>
          <div class="row g-2" id="profile-fields">
            <div class="col-md-6"><label class="form-label small text-muted">First Name</label><input type="text" class="form-control form-control-sm" id="pf-firstname"></div>
            <div class="col-md-6"><label class="form-label small text-muted">Last Name</label><input type="text" class="form-control form-control-sm" id="pf-lastname"></div>
            <div class="col-md-6"><label class="form-label small text-muted">Phone</label><input type="text" class="form-control form-control-sm" id="pf-phone"></div>
            <div class="col-md-6"><label class="form-label small text-muted">City</label><input type="text" class="form-control form-control-sm" id="pf-city"></div>
            <div class="col-md-6"><label class="form-label small text-muted">Membership Type</label><input type="text" class="form-control form-control-sm" id="pf-membership" readonly></div>
            <div class="col-md-6"><label class="form-label small text-muted">Member Since</label><input type="text" class="form-control form-control-sm" id="pf-since" readonly></div>
            <div class="col-12 mt-2">
              <button class="btn btn-banf btn-sm" onclick="saveProfile()"><i class="fas fa-save me-1"></i>Save Changes</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- EVENTS -->
  <div id="sec-events" class="section">
    <div class="section-title"><i class="fas fa-calendar me-2"></i>Events</div>
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item"><a class="nav-link active" href="#" onclick="loadEvents('upcoming');return false">Upcoming</a></li>
      <li class="nav-item"><a class="nav-link" href="#" onclick="loadEvents('my');return false">My RSVPs</a></li>
    </ul>
    <div id="events-grid" class="row g-3"></div>
  </div>

  <!-- PAYMENTS -->
  <div id="sec-payments" class="section">
    <div class="section-title"><i class="fas fa-receipt me-2"></i>My Payments</div>
    <div class="tbl-wrap mb-3">
      <table class="table table-hover mb-0">
        <thead><tr><th>Purpose</th><th>Amount</th><th>Method</th><th>Status</th><th>Date</th></tr></thead>
        <tbody id="payments-tbl"></tbody>
      </table>
    </div>
    <div id="pay-summary" class="text-end text-muted small"></div>
  </div>

  <!-- SURVEYS -->
  <div id="sec-surveys" class="section">
    <div class="section-title"><i class="fas fa-poll me-2"></i>Surveys</div>
    <p class="text-muted small">Surveys sent to you by the Executive Committee appear below. Your responses are completely anonymous.</p>
    <div id="surveys-list" class="row g-3"></div>
  </div>

  <!-- COMPLAINTS / FEEDBACK -->
  <div id="sec-complaints" class="section">
    <div class="section-title"><i class="fas fa-comment-alt me-2"></i>Feedback &amp; Complaints</div>
    <div class="row g-3">
      <div class="col-md-5">
        <div class="card p-3 border-0 shadow-sm">
          <h6 class="fw-bold text-danger">Submit Feedback</h6>
          <div class="mb-2"><label class="form-label small">Category</label>
            <select class="form-select form-select-sm" id="c-cat">
              <option value="general">General Feedback</option>
              <option value="event">Event Feedback</option>
              <option value="membership">Membership Issue</option>
              <option value="complaint">Complaint</option>
              <option value="suggestion">Suggestion</option>
            </select>
          </div>
          <div class="mb-2"><label class="form-label small">Subject</label><input type="text" class="form-control form-control-sm" id="c-subject"></div>
          <div class="mb-2"><label class="form-label small">Description</label><textarea class="form-control form-control-sm" id="c-desc" rows="4"></textarea></div>
          <button class="btn btn-banf btn-sm w-100" onclick="submitComplaint()">Submit</button>
        </div>
      </div>
      <div class="col-md-7">
        <div class="card p-3 border-0 shadow-sm">
          <h6 class="fw-bold text-danger">My Submissions</h6>
          <div id="complaints-list"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- DIRECTORY -->
  <div id="sec-directory" class="section">
    <div class="section-title"><i class="fas fa-address-book me-2"></i>Member Directory</div>
    <div class="filter-bar d-flex gap-2 mb-3">
      <input type="text" class="form-control form-control-sm" id="dir-search" placeholder="Search membersâ€¦" style="max-width:260px" oninput="filterDir()">
    </div>
    <div id="dir-list"></div>
  </div>

  <!-- AI CHAT -->
  <div id="sec-chat" class="section">
    <div class="section-title"><i class="fas fa-robot me-2"></i>AI Assistant</div>
    <p class="text-muted small mb-3">Ask about events, membership, BANF culture, payments or anything about the organization.</p>
    <div class="chat-window">
      <div class="chat-messages" id="chat-messages">
        <div class="chat-msg bot">ðŸ‘‹ Hello! I'm your BANF AI Assistant. Ask me about upcoming events, your membership, payment history, or anything about our Bengali community!</div>
      </div>
      <div class="chat-input">
        <input type="text" class="form-control form-control-sm" id="chat-input" placeholder="Type a messageâ€¦" onkeydown="if(event.key==='Enter')sendChat()">
        <button class="btn btn-banf btn-sm" onclick="sendChat()"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
    <div class="d-flex gap-2 mt-2 flex-wrap" id="chat-quick">
      <button class="btn btn-outline-secondary btn-sm" onclick="quickChat('What events are coming up?')">Upcoming events</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="quickChat('What is my membership status?')">My membership</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="quickChat('How do I renew my membership?')">Renew membership</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="quickChat('What are the membership tiers?')">Membership tiers</button>
    </div>
  </div>

</div><!-- /main-content -->

<!-- TOAST -->
<div class="toast-area" id="toast-area"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API = 'https://banfwix.wixsite.com/banf1/_functions';
let memberEmail = '';
let memberProfile = null;
let dirCache = [];
let chatContext = [];

function getHeaders() { return { 'Content-Type':'application/json', 'x-user-email': memberEmail }; }

// â”€â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doLogin() {
  const email = document.getElementById('login-email').value.trim().toLowerCase();
  if (!email) return showToast('Enter your email','danger');
  try {
    const res = await fetch(`${API}/member_profile`, { headers: { 'x-user-email': email } });
    const data = await res.json();
    if (!data.success) {
      document.getElementById('login-err').style.display='';
      document.getElementById('login-err').textContent = data.error || 'Member not found. Contact admin.';
      return;
    }
    memberEmail = email;
    memberProfile = data.profile || {};
    localStorage.setItem('banf_member_email', email);
    showPortal();
  } catch(e) {
    document.getElementById('login-err').style.display='';
    document.getElementById('login-err').textContent = 'Login failed: ' + e.message;
  }
}

function showPortal() {
  document.getElementById('login-wall').style.display='none';
  document.getElementById('header').style.display='';
  document.getElementById('sidebar').style.display='';
  document.getElementById('main-content').style.display='';
  const name = `${memberProfile.firstName||''} ${memberProfile.lastName||''}`.trim() || memberEmail;
  document.getElementById('hdr-name').textContent = name;
  loadDashboard();
}

function logout() {
  localStorage.removeItem('banf_member_email');
  location.reload();
}

// â”€â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function show(sectionId, el) {
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active'));
  document.getElementById('sec-'+sectionId).classList.add('active');
  if (el) el.classList.add('active');
  const loaders = { dashboard: loadDashboard, profile: loadProfile, events: ()=>loadEvents('upcoming'),
    payments: loadPayments, surveys: loadMemberSurveys, complaints: loadComplaints,
    directory: loadDirectory, chat: ()=>{} };
  if (loaders[sectionId]) loaders[sectionId]();
}

// â”€â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDashboard() {
  try {
    const [profRes, evRes, payRes, svRes] = await Promise.all([
      fetch(`${API}/member_profile`, { headers: getHeaders() }),
      fetch(`${API}/member_events`, { headers: getHeaders() }),
      fetch(`${API}/member_payments?limit=10`, { headers: getHeaders() }),
      fetch(`${API}/member_surveys`, { headers: getHeaders() })
    ]);
    const [pD, eD, payD, svD] = await Promise.all([profRes.json(), evRes.json(), payRes.json(), svRes.json()]);
    if (pD.success) {
      memberProfile = pD.profile;
      document.getElementById('dash-mem-type').textContent = pD.profile.membershipType || 'Standard';
    }
    document.getElementById('dash-paid-total').textContent = `$${(payD.totalPaid||0).toFixed(0)}`;
    document.getElementById('dash-events-count').textContent = (eD.events||[]).length;
    const openSurveys = (svD.surveys||[]).filter(s=>s.status==='active');
    document.getElementById('dash-surveys-count').textContent = openSurveys.length;
    // Next event
    if ((eD.events||[]).length) {
      const ev = eD.events[0];
      document.getElementById('dash-next-event-wrap').style.display='';
      document.getElementById('dash-next-event').innerHTML=`<div class="fw-bold">${ev.title||''}</div>
        <div class="small text-muted">${ev.eventDate?new Date(ev.eventDate).toLocaleDateString():'TBD'} Â· ${ev.venue||''}</div>
        ${ev.hasRsvp ? '<span class="badge bg-success mt-1">RSVP\'d âœ…</span>' : `<button class="btn btn-banf btn-sm mt-2" onclick="rsvpEvent('${ev._id}','${(ev.title||'').replace(/'/g,'`')}')">RSVP</button>`}`;
    }
    // Open surveys
    if (openSurveys.length) {
      document.getElementById('dash-survey-wrap').style.display='';
      document.getElementById('dash-open-surveys').innerHTML = openSurveys.map(sv=>`
        <div class="d-flex justify-content-between align-items-center mb-1">
          <div class="small fw-bold">${sv.title||''}</div>
          <a href="${sv.formUrl||'#'}" target="_blank" class="btn btn-outline-danger btn-sm" style="font-size:.72rem;padding:.1rem .5rem">Take Survey</a>
        </div>`).join('');
    }
  } catch(e) { console.error(e); }
}

// â”€â”€â”€ PROFILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadProfile() {
  try {
    const res = await fetch(`${API}/member_profile`, { headers: getHeaders() });
    const data = await res.json();
    if (!data.success) return;
    const p = data.profile;
    memberProfile = p;
    const name = `${p.firstName||''} ${p.lastName||''}`.trim();
    document.getElementById('profile-name').textContent = name;
    document.getElementById('profile-email').textContent = p.email||'';
    document.getElementById('profile-avatar').textContent = (p.firstName||'?')[0].toUpperCase();
    document.getElementById('profile-badge').textContent = p.membershipType||'Member';
    document.getElementById('pf-firstname').value = p.firstName||'';
    document.getElementById('pf-lastname').value = p.lastName||'';
    document.getElementById('pf-phone').value = p.phone||'';
    document.getElementById('pf-city').value = p.city||'';
    document.getElementById('pf-membership').value = p.membershipType||'Standard';
    document.getElementById('pf-since').value = p._createdDate ? new Date(p._createdDate).toLocaleDateString() : 'â€”';
  } catch(e) { showToast('Profile load failed','danger'); }
}

async function saveProfile() {
  const body = {
    firstName: document.getElementById('pf-firstname').value.trim(),
    lastName: document.getElementById('pf-lastname').value.trim(),
    phone: document.getElementById('pf-phone').value.trim(),
    city: document.getElementById('pf-city').value.trim()
  };
  try {
    const res = await fetch(`${API}/member_profile_update`, { method:'POST', headers: getHeaders(), body: JSON.stringify(body) });
    const data = await res.json();
    if (data.success) { showToast('Profile saved âœ…','success'); memberProfile = data.profile; }
    else showToast(data.error||'Failed','danger');
  } catch(e) { showToast('Error','danger'); }
}

// â”€â”€â”€ EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadEvents(mode='upcoming') {
  const grid = document.getElementById('events-grid');
  grid.innerHTML = '<div class="col-12 text-center py-3"><div class="spinner-border spinner-sm" style="color:var(--banf-orange)"></div></div>';
  try {
    const res = await fetch(`${API}/member_events`, { headers: getHeaders() });
    const data = await res.json();
    const events = mode==='my' ? (data.myRsvps||[]).map(r=>r.event||r) : (data.events||[]);
    if (!events.length) { grid.innerHTML = '<div class="col-12 text-muted small text-center py-3">No events found</div>'; return; }
    grid.innerHTML = events.map(ev=>`
      <div class="col-md-4">
        <div class="event-card">
          <div class="ev-header">
            <div class="fw-bold">${ev.title||''}</div>
            <div class="small opacity-75">${ev.eventDate?new Date(ev.eventDate).toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'}):''}</div>
          </div>
          <div class="ev-body">
            <div class="small text-muted mb-2"><i class="fas fa-map-marker-alt me-1"></i>${ev.venue||'TBD'}</div>
            <div class="small mb-3">${(ev.description||'').substring(0,120)}${ev.description?.length>120?'â€¦':''}</div>
            <div class="d-flex justify-content-between align-items-center">
              <span class="small text-muted"><i class="fas fa-ticket-alt me-1"></i>${ev.isFree?'Free':ev.ticketPrice?`$${ev.ticketPrice}`:'See details'}</span>
              ${ev.hasRsvp ? '<span class="badge bg-success">RSVP\'d âœ…</span>' : `<button class="btn btn-banf btn-sm" onclick="rsvpEvent('${ev._id}','${(ev.title||'Event').replace(/'/g,'\`')}')">RSVP</button>`}
            </div>
          </div>
        </div>
      </div>`).join('');
  } catch(e) { grid.innerHTML = '<div class="col-12 text-danger small">Load failed</div>'; }
}

async function rsvpEvent(eventId, title) {
  const guests = parseInt(prompt(`How many guests for "${title}" (including yourself)?`,1))||1;
  try {
    const res = await fetch(`${API}/member_rsvp`, { method:'POST', headers: getHeaders(), body: JSON.stringify({ eventId, guestCount: guests }) });
    const data = await res.json();
    if (data.success) { showToast(`RSVP confirmed for ${guests} guest(s) âœ…`,'success'); loadEvents(); }
    else showToast(data.error||'RSVP failed','danger');
  } catch(e) { showToast('Error','danger'); }
}

// â”€â”€â”€ PAYMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPayments() {
  const tbl = document.getElementById('payments-tbl');
  tbl.innerHTML = '<tr><td colspan="5" class="text-center py-3"><div class="spinner-border spinner-sm" style="color:var(--banf-orange)"></div></td></tr>';
  try {
    const res = await fetch(`${API}/member_payments`, { headers: getHeaders() });
    const data = await res.json();
    document.getElementById('pay-summary').textContent = `Total paid: $${(data.totalPaid||0).toFixed(2)} across ${data.count||0} transactions`;
    tbl.innerHTML = (data.payments||[]).map(p=>`
      <tr>
        <td>${p.purpose||''}</td>
        <td class="fw-bold">$${(p.amount||0).toFixed(2)}</td>
        <td class="small">${p.method||''}</td>
        <td><span class="badge badge-status-${p.status||'pending'}">${p.status||''}</span></td>
        <td class="small">${p._createdDate?new Date(p._createdDate).toLocaleDateString():''}</td>
      </tr>`).join('') || '<tr><td colspan="5" class="text-muted small text-center py-3">No payment records</td></tr>';
  } catch(e) { tbl.innerHTML = '<tr><td colspan="5" class="text-danger small">Load failed</td></tr>'; }
}

// â”€â”€â”€ SURVEYS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMemberSurveys() {
  const out = document.getElementById('surveys-list');
  out.innerHTML = '<div class="col-12 text-center py-3"><div class="spinner-border spinner-sm" style="color:var(--banf-orange)"></div></div>';
  try {
    const res = await fetch(`${API}/member_surveys`, { headers: getHeaders() });
    const data = await res.json();
    const surveys = data.surveys || [];
    out.innerHTML = surveys.length ? surveys.map(sv=>`
      <div class="col-md-4">
        <div class="card h-100 border-0 shadow-sm">
          <div class="card-body">
            <span class="badge ${sv.status==='active'?'bg-success bg-opacity-75':'bg-secondary'} mb-1">${sv.status||'draft'}</span>
            <h6 class="fw-bold">${sv.title||''}</h6>
            <p class="small text-muted">${sv.description||''}</p>
            ${sv.responded ? '<span class="badge bg-success">Responded âœ…</span>' : ''}
          </div>
          ${!sv.responded && sv.status==='active' ? `<div class="card-footer bg-transparent">
            <a href="${sv.formUrl||'survey.html'}" target="_blank" class="btn btn-banf btn-sm w-100">Take Survey</a>
          </div>` : ''}
        </div>
      </div>`).join('') : '<div class="col-12 text-muted small text-center py-3">No surveys assigned to you</div>';
  } catch(e) { out.innerHTML = '<div class="col-12 text-danger small">Load failed</div>'; }
}

// â”€â”€â”€ COMPLAINTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadComplaints() {
  const out = document.getElementById('complaints-list');
  try {
    const res = await fetch(`${API}/member_complaints`, { headers: getHeaders() });
    const data = await res.json();
    out.innerHTML = (data.complaints||[]).map(c=>`
      <div class="d-flex justify-content-between align-items-start mb-2 p-2 bg-light rounded">
        <div>
          <div class="small fw-bold">${c.subject||''}</div>
          <div class="small text-muted">${(c.description||'').substring(0,80)}â€¦</div>
        </div>
        <span class="badge badge-status-${c.status||'open'} ms-2">${c.status||'open'}</span>
      </div>`).join('') || '<div class="text-muted small">No submissions yet</div>';
  } catch(e) { out.innerHTML = '<div class="text-muted small">Failed to load</div>'; }
}

async function submitComplaint() {
  const body = {
    category: document.getElementById('c-cat').value,
    subject: document.getElementById('c-subject').value.trim(),
    description: document.getElementById('c-desc').value.trim()
  };
  if (!body.subject || !body.description) return showToast('Subject and description required','danger');
  try {
    const res = await fetch(`${API}/member_complaint_submit`, { method:'POST', headers: getHeaders(), body: JSON.stringify(body) });
    const data = await res.json();
    if (data.success) { showToast('Submitted âœ… EC will review','success'); document.getElementById('c-subject').value=''; document.getElementById('c-desc').value=''; loadComplaints(); }
    else showToast(data.error||'Failed','danger');
  } catch(e) { showToast('Error','danger'); }
}

// â”€â”€â”€ DIRECTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDirectory() {
  const out = document.getElementById('dir-list');
  out.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-sm" style="color:var(--banf-orange)"></div></div>';
  try {
    const res = await fetch(`${API}/member_directory`, { headers: getHeaders() });
    const data = await res.json();
    dirCache = data.members || [];
    renderDir(dirCache);
  } catch(e) { out.innerHTML = '<div class="text-danger small">'+e.message+'</div>'; }
}

function renderDir(members) {
  const out = document.getElementById('dir-list');
  out.innerHTML = members.map(m=>`
    <div class="dir-member">
      <div class="d-flex align-items-center gap-2">
        <div style="width:36px;height:36px;border-radius:50%;background:var(--grad);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.9rem">${(m.firstName||'?')[0].toUpperCase()}</div>
        <div>
          <div class="fw-bold">${m.firstName||''} ${m.lastName||''}</div>
          <div class="small text-muted">${m.membershipType||'Member'} Â· ${m.city||''}</div>
        </div>
      </div>
    </div>`).join('') || '<div class="text-muted small text-center py-3">No members in directory</div>';
}

function filterDir() {
  const q = document.getElementById('dir-search').value.toLowerCase();
  renderDir(dirCache.filter(m=>(`${m.firstName} ${m.lastName} ${m.city}`).toLowerCase().includes(q)));
}

// â”€â”€â”€ AI CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendChat() {
  const input = document.getElementById('chat-input');
  const msg = input.value.trim();
  if (!msg) return;
  input.value='';
  appendChat(msg,'user');
  try {
    const res = await fetch(`${API}/member_chat`, { method:'POST', headers: getHeaders(), body: JSON.stringify({ message: msg, context: chatContext.slice(-6) }) });
    const data = await res.json();
    const reply = data.reply || data.response || 'I couldn\'t process that. Please try again.';
    appendChat(reply,'bot');
    chatContext.push({ role:'user', content: msg });
    chatContext.push({ role:'assistant', content: reply });
  } catch(e) { appendChat('Sorry, I encountered an error. Please try again.','bot'); }
}

function quickChat(msg) { document.getElementById('chat-input').value = msg; sendChat(); }

function appendChat(msg, role) {
  const msgs = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.className = 'chat-msg ' + role;
  div.textContent = msg;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

// â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg, type='info') {
  const colors = {success:'#198754',danger:'#dc3545',warning:'#e8a000',info:'#0dcaf0'};
  const el = document.createElement('div');
  el.style.cssText=`background:${colors[type]||colors.info};color:${type==='warning'||type==='info'?'#000':'#fff'};padding:.6rem 1rem;border-radius:8px;margin-bottom:.4rem;font-size:.85rem;box-shadow:0 4px 12px rgba(0,0,0,.25)`;
  el.textContent=msg;
  document.getElementById('toast-area').prepend(el);
  setTimeout(()=>el.remove(),4000);
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async () => {
  const email = localStorage.getItem('banf_member_email');
  if (email) {
    memberEmail = email;
    try {
      const res = await fetch(`${API}/member_profile`, { headers: getHeaders() });
      const data = await res.json();
      if (data.success) { memberProfile = data.profile; showPortal(); return; }
    } catch(_) {}
    localStorage.removeItem('banf_member_email');
  }
})();
</script>
</body>
</html>
