<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BANF - RSVP</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--banf-red:#8B0000;--banf-dark:#5a0000;--banf-orange:#FF6B35;--grad:linear-gradient(135deg,#8B0000,#DC143C)}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif}
body{background:#f4f0ed;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:20px}
.container{width:100%;max-width:600px}
.header{background:var(--grad);color:#fff;padding:28px 32px;border-radius:16px 16px 0 0;text-align:center}
.header h1{font-size:1.5rem;font-weight:700;margin-bottom:4px}
.header .org{font-size:.82rem;opacity:.75}
.card{background:#fff;padding:32px;border-radius:0 0 16px 16px;box-shadow:0 4px 24px rgba(0,0,0,.08)}
.event-details{background:#fdf6f0;border-left:4px solid var(--banf-orange);border-radius:0 12px 12px 0;padding:16px 20px;margin-bottom:24px}
.event-details .label{font-size:.72rem;color:#888;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.event-details .detail-row{display:flex;gap:12px;padding:4px 0;font-size:.9rem}
.event-details .detail-row .icon{font-weight:600;color:var(--banf-red);min-width:24px}
.event-details .detail-row .value{color:#333}
.welcome{font-size:.95rem;color:#555;margin-bottom:24px;line-height:1.6}
.welcome strong{color:#333}
.form-group{margin-bottom:20px}
.form-group label{display:block;font-size:.85rem;font-weight:600;color:#333;margin-bottom:6px}
.form-group .hint{font-size:.72rem;color:#999;margin-top:3px}
.rsvp-options{display:flex;gap:12px;flex-wrap:wrap}
.rsvp-option{flex:1;min-width:100px;position:relative}
.rsvp-option input{display:none}
.rsvp-option label{display:block;text-align:center;padding:14px 12px;border:2px solid #e0e0e0;border-radius:12px;cursor:pointer;transition:all .2s;font-size:.88rem;font-weight:500}
.rsvp-option label:hover{border-color:var(--banf-orange);background:#fff8f5}
.rsvp-option input:checked+label{border-color:var(--banf-red);background:linear-gradient(135deg,rgba(139,0,0,.08),rgba(220,20,60,.05));color:var(--banf-red);font-weight:700}
.rsvp-option[data-status="yes"] input:checked+label{border-color:#27ae60;background:rgba(39,174,96,.08);color:#27ae60}
.rsvp-option[data-status="no"] input:checked+label{border-color:#e74c3c;background:rgba(231,76,60,.08);color:#e74c3c}
.rsvp-option[data-status="maybe"] input:checked+label{border-color:#f39c12;background:rgba(243,156,18,.08);color:#f39c12}
.number-inputs{display:flex;gap:16px}
.number-input{flex:1}
.number-input input{width:100%;padding:10px 14px;border:2px solid #e0e0e0;border-radius:10px;font-size:.95rem;text-align:center;transition:border-color .2s}
.number-input input:focus{outline:none;border-color:var(--banf-orange)}
.dietary-options{display:flex;flex-wrap:wrap;gap:8px}
.dietary-option{position:relative}
.dietary-option input{display:none}
.dietary-option label{display:inline-block;padding:8px 16px;border:2px solid #e0e0e0;border-radius:20px;cursor:pointer;font-size:.82rem;transition:all .2s}
.dietary-option label:hover{border-color:var(--banf-orange)}
.dietary-option input:checked+label{border-color:var(--banf-red);background:rgba(139,0,0,.08);color:var(--banf-red);font-weight:600}
textarea{width:100%;padding:12px 14px;border:2px solid #e0e0e0;border-radius:10px;font-size:.9rem;resize:vertical;min-height:80px;transition:border-color .2s}
textarea:focus{outline:none;border-color:var(--banf-orange)}
.submit-btn{width:100%;padding:14px;background:var(--grad);color:#fff;border:none;border-radius:30px;font-size:1rem;font-weight:700;cursor:pointer;letter-spacing:.5px;transition:transform .15s,box-shadow .2s;box-shadow:0 4px 16px rgba(139,0,0,.25);margin-top:8px}
.submit-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(139,0,0,.35)}
.submit-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
.guest-details{display:none;margin-top:16px;padding:16px;background:#f9f7f5;border-radius:12px}
.guest-details.visible{display:block}
.loading{text-align:center;padding:60px 20px;color:#888;font-size:.95rem}
.loading .spinner{width:36px;height:36px;border:3px solid #eee;border-top-color:var(--banf-red);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}
.error-msg{background:#ffeaea;color:#c0392b;padding:16px;border-radius:12px;text-align:center;font-size:.88rem;margin:20px 0}
.success-card{text-align:center;padding:40px 32px}
.success-card .check{font-size:3rem;margin-bottom:16px}
.success-card h2{font-size:1.3rem;color:#333;margin-bottom:8px}
.success-card p{font-size:.9rem;color:#666;line-height:1.6}
.already-responded{background:#f0f7ff;border:1px solid #b3d4fc;padding:16px;border-radius:12px;text-align:center;margin:20px 0}
.already-responded .status{font-weight:700;color:var(--banf-red);font-size:1.1rem}
.footer{text-align:center;padding:20px;font-size:.72rem;color:#aaa;margin-top:auto}
</style>
</head>
<body>

<div class="container" id="main-container">
  <div class="header">
    <h1 id="event-title">BANF Event</h1>
    <div class="org">Bengali Association of North Florida</div>
  </div>
  <div class="card">
    <div class="loading" id="loading-state">
      <div class="spinner"></div>
      Loading your invitation...
    </div>
    <div id="form-state" style="display:none">
      <!-- Event Details -->
      <div class="event-details" id="event-details-box"></div>

      <!-- Welcome -->
      <div class="welcome" id="welcome-text"></div>

      <!-- Already responded notice -->
      <div class="already-responded" id="already-responded" style="display:none">
        <div>You have already responded to this invitation.</div>
        <div class="status" id="previous-status"></div>
        <div style="font-size:.82rem;color:#666;margin-top:8px">You can update your response below if needed.</div>
      </div>

      <!-- RSVP Form -->
      <form id="rsvp-form">
        <div class="form-group">
          <label>Will you be attending?</label>
          <div class="rsvp-options">
            <div class="rsvp-option" data-status="yes">
              <input type="radio" name="rsvpStatus" id="rsvp-yes" value="yes">
              <label for="rsvp-yes">&#127881; Yes, I'll be there!</label>
            </div>
            <div class="rsvp-option" data-status="no">
              <input type="radio" name="rsvpStatus" id="rsvp-no" value="no">
              <label for="rsvp-no">&#128532; Sorry, can't make it</label>
            </div>
            <div class="rsvp-option" data-status="maybe">
              <input type="radio" name="rsvpStatus" id="rsvp-maybe" value="maybe">
              <label for="rsvp-maybe">&#129300; Maybe</label>
            </div>
          </div>
        </div>

        <div class="guest-details" id="guest-details">
          <div class="form-group">
            <label>How many guests?</label>
            <div class="number-inputs">
              <div class="number-input">
                <input type="number" id="adults" min="0" max="20" value="1" placeholder="Adults">
                <div class="hint" style="text-align:center">Adults</div>
              </div>
              <div class="number-input">
                <input type="number" id="kids" min="0" max="20" value="0" placeholder="Kids">
                <div class="hint" style="text-align:center">Kids (under 18)</div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label>Dietary Preference</label>
            <div class="dietary-options">
              <div class="dietary-option">
                <input type="radio" name="dietary" id="diet-veg" value="vegetarian">
                <label for="diet-veg">&#129367; Vegetarian</label>
              </div>
              <div class="dietary-option">
                <input type="radio" name="dietary" id="diet-nonveg" value="non_vegetarian">
                <label for="diet-nonveg">&#127830; Non-Vegetarian</label>
              </div>
              <div class="dietary-option">
                <input type="radio" name="dietary" id="diet-mixed" value="mixed">
                <label for="diet-mixed">&#127869; Mixed</label>
              </div>
              <div class="dietary-option">
                <input type="radio" name="dietary" id="diet-vegan" value="vegan">
                <label for="diet-vegan">&#127793; Vegan</label>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label>Special Requests or Notes (optional)</label>
            <textarea id="notes" placeholder="Allergies, accessibility needs, anything we should know..."></textarea>
          </div>
        </div>

        <button type="submit" class="submit-btn" id="submit-btn" disabled>Select your response above</button>
      </form>
    </div>

    <!-- Success State -->
    <div id="success-state" style="display:none" class="success-card"></div>

    <!-- Error State -->
    <div id="error-state" style="display:none"></div>
  </div>
</div>

<div class="footer">
  Bengali Association of North Florida (BANF) | Jacksonville, FL<br>
  Your response is only visible to BANF organizers.
</div>

<script>
const API_BASE = 'https://banfwix.wixsite.com/banf1/_functions';
const params = new URLSearchParams(window.location.search);
const TOKEN = params.get('token');
const EVENT_ID = params.get('eventId');

const loadingEl = document.getElementById('loading-state');
const formEl = document.getElementById('form-state');
const successEl = document.getElementById('success-state');
const errorEl = document.getElementById('error-state');

let currentData = null;

// ── Load invitation data ──
async function loadInvitation() {
    if (!TOKEN) {
        showError('No invitation token found. Please use the link from your invitation email.');
        return;
    }
    try {
        const res = await fetch(`${API_BASE}/evite_rsvp_form_data?token=${TOKEN}`);
        const data = await res.json();
        if (!data.success) {
            showError(data.error || 'Unable to load invitation. The link may be invalid or expired.');
            return;
        }
        currentData = data;
        renderForm(data);
    } catch (e) {
        showError('Unable to connect to the server. Please try again later.');
    }
}

function renderForm(data) {
    loadingEl.style.display = 'none';
    formEl.style.display = 'block';

    const inv = data.invitation;
    const evt = data.event;

    // Event title
    if (evt) {
        document.getElementById('event-title').textContent = evt.eventName;

        // Event details box
        let detailsHtml = '<div class="label">Event Details</div>';
        if (evt.eventDate) {
            const d = new Date(evt.eventDate);
            detailsHtml += `<div class="detail-row"><span class="icon">&#128197;</span><span class="value">${d.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</span></div>`;
        }
        if (evt.eventTime) {
            detailsHtml += `<div class="detail-row"><span class="icon">&#128336;</span><span class="value">${evt.eventTime}</span></div>`;
        }
        if (evt.venue) {
            detailsHtml += `<div class="detail-row"><span class="icon">&#128205;</span><span class="value">${evt.venue}</span></div>`;
        }
        if (evt.description) {
            detailsHtml += `<div style="margin-top:8px;font-size:.88rem;color:#555;line-height:1.5">${evt.description}</div>`;
        }
        document.getElementById('event-details-box').innerHTML = detailsHtml;
    }

    // Welcome
    document.getElementById('welcome-text').innerHTML =
        `Dear <strong>${inv.recipientName}</strong>, please let us know if you can join us!`;

    // Already responded?
    if (inv.responded) {
        const arEl = document.getElementById('already-responded');
        arEl.style.display = 'block';
        const statusMap = { yes: 'Attending', no: 'Not Attending', maybe: 'Maybe' };
        document.getElementById('previous-status').textContent = 'Current response: ' + (statusMap[inv.rsvpStatus] || inv.rsvpStatus);
    }
}

// ── RSVP option handling ──
document.querySelectorAll('input[name="rsvpStatus"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const val = this.value;
        const guestDetails = document.getElementById('guest-details');
        const btn = document.getElementById('submit-btn');

        if (val === 'yes' || val === 'maybe') {
            guestDetails.classList.add('visible');
        } else {
            guestDetails.classList.remove('visible');
        }

        btn.disabled = false;
        const labels = { yes: "Submit RSVP - I'm Coming!", no: "Submit RSVP - Can't Make It", maybe: "Submit RSVP - Maybe" };
        btn.textContent = labels[val] || 'Submit RSVP';
    });
});

// ── Form submit ──
document.getElementById('rsvp-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const btn = document.getElementById('submit-btn');
    const rsvpStatus = document.querySelector('input[name="rsvpStatus"]:checked');
    if (!rsvpStatus) return;

    btn.disabled = true;
    btn.textContent = 'Submitting...';

    const dietary = document.querySelector('input[name="dietary"]:checked');

    const payload = {
        token: TOKEN,
        rsvpStatus: rsvpStatus.value,
        adults: parseInt(document.getElementById('adults').value) || 0,
        kids: parseInt(document.getElementById('kids').value) || 0,
        dietary: dietary ? dietary.value : '',
        notes: document.getElementById('notes').value.trim()
    };

    try {
        const res = await fetch(`${API_BASE}/evite_rsvp_submit`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.success) {
            showSuccess(data.message, rsvpStatus.value);
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
            btn.disabled = false;
            btn.textContent = 'Try Again';
        }
    } catch (err) {
        alert('Network error. Please try again.');
        btn.disabled = false;
        btn.textContent = 'Try Again';
    }
});

function showSuccess(message, status) {
    formEl.style.display = 'none';
    successEl.style.display = 'block';
    const icons = { yes: '&#127881;', no: '&#128075;', maybe: '&#129300;' };
    const titles = { yes: 'See You There!', no: 'Maybe Next Time!', maybe: 'We Hope You Can Make It!' };
    successEl.innerHTML = `
        <div class="check">${icons[status] || '&#9989;'}</div>
        <h2>${titles[status] || 'Response Recorded'}</h2>
        <p>${message}</p>
        <p style="margin-top:16px;font-size:.82rem;color:#999">You can close this page now. If you change your mind, just click the link in your invitation email again.</p>
    `;
}

function showError(msg) {
    loadingEl.style.display = 'none';
    errorEl.style.display = 'block';
    errorEl.innerHTML = `<div class="error-msg">${msg}</div>`;
}

// Start
loadInvitation();
</script>
</body>
</html>
